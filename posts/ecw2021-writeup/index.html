<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=author content><meta name=description content="Thalium blog."><meta name=keywords content="blog,tech"><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><meta name=generator content="Hugo 0.145.0"><link rel=canonical href=/posts/ecw2021-writeup/><meta property="og:url" content="/posts/ecw2021-writeup/"><meta property="og:site_name" content="THALIUM"><meta property="og:title" content="ECW 2021 - WriteUp"><meta property="og:description" content="For the European Cyber Week CTF 2021 Thalium created some challenges in our core competencies: reverse and exploitation. This blog post presents some of the write-ups:
Chest (36 solve) - reverse FSB as a service (3 solve) - exploitation WYSIWYG (3 solve) - reverse Pipe Dream (1 solve) - reverse the author posted his solution on his personal blog Thalium’s challenges have been less resolved than others. They were not that difficult, but probably a bit more unexpected. A few additional challenges designed by Thalium are:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-25T12:00:01+01:00"><meta property="article:modified_time" content="2021-10-25T12:00:01+01:00"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Writeup"><meta property="article:tag" content="ECW 2021"><meta property="article:tag" content="Reverse Engineering"><meta property="article:tag" content="Exploit"><meta name=twitter:card content="summary"><meta name=twitter:title content="ECW 2021 - WriteUp"><meta name=twitter:description content="For the European Cyber Week CTF 2021 Thalium created some challenges in our core competencies: reverse and exploitation. This blog post presents some of the write-ups:
Chest (36 solve) - reverse FSB as a service (3 solve) - exploitation WYSIWYG (3 solve) - reverse Pipe Dream (1 solve) - reverse the author posted his solution on his personal blog Thalium’s challenges have been less resolved than others. They were not that difficult, but probably a bit more unexpected. A few additional challenges designed by Thalium are:"><meta itemprop=name content="ECW 2021 - WriteUp"><meta itemprop=description content="For the European Cyber Week CTF 2021 Thalium created some challenges in our core competencies: reverse and exploitation. This blog post presents some of the write-ups:
Chest (36 solve) - reverse FSB as a service (3 solve) - exploitation WYSIWYG (3 solve) - reverse Pipe Dream (1 solve) - reverse the author posted his solution on his personal blog Thalium’s challenges have been less resolved than others. They were not that difficult, but probably a bit more unexpected. A few additional challenges designed by Thalium are:"><meta itemprop=datePublished content="2021-10-25T12:00:01+01:00"><meta itemprop=dateModified content="2021-10-25T12:00:01+01:00"><meta itemprop=wordCount content="3852"><meta itemprop=keywords content="CTF,Writeup,ECW 2021,Reverse Engineering,Exploit"><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=/css/default-dark.css><link rel=icon href=/favicon.ico><title>ECW 2021 - WriteUp
</title><script>MathJax={tex:{inlineMath:[["∳","∳"]],displayMath:[["∳∳","∳∳"]],processEscapes:!0},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></head><body><div class=main><header><div class=header-bar><nav><div class=siteTitle><a href=/><img src=/shard_only_no_background.png></img>
<span>THALIUM</span></a></div><div class=nav-item-title><a class=nav-item href=/posts/>Posts</a></div><div class=nav-item-title><a class=nav-item href=/joinus/>Join Us</a></div><div class=nav-item-title><a class=nav-item href=/about/>About</a></div></nav></div></header><article class=post><h1 class=title>ECW 2021 - WriteUp</h1><div class=content><p>For the <a href=https://www.european-cyber-week.eu/>European Cyber Week</a> CTF 2021 Thalium created some challenges in our core competencies: reverse and exploitation. This blog post presents some of the write-ups:</p><ul><li><a href=#chest>Chest (36 solve) - reverse</a></li><li><a href=#fsb-as-a-service>FSB as a service (3 solve) - exploitation</a></li><li><a href=#wysiwyg>WYSIWYG (3 solve) - reverse</a></li><li>Pipe Dream (1 solve) - reverse<ul><li>the author posted his solution on <a href=https://face.0xff.re/posts/ecw-ctf-2021-pipe-dream-writeup/>his personal blog</a></li></ul></li></ul><p>Thalium&rsquo;s challenges have been less resolved than others. They were not that difficult, but probably a bit more unexpected. A few additional challenges designed by Thalium are:</p><ul><li>EMU (3 solve) - reverse</li><li>Hospital simulator (3 solve) - exploitation</li></ul><p>As a reminder, Thalium - part of THALES group - is a cybersecurity team dedicated to vulnerability research and development of Red Team-type tools. The team is located in Rennes and we are actively recruiting experienced or high potential profiles in reverse, forensics, and software development. Spoiler: we also offer internships, see <a href=#internships-2022>below</a>.</p><h2 id=chest>Chest</h2><p>The provided file <a href=/posts/binaries/ECW_2021/chest.hex>chest.hex</a> is in <a href=https://www.intel.com/content/www/us/en/support/programmable/articles/000076770.html>Intel HEX format</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cat chest.hex
</span></span><span style=display:flex><span>:100000000C9434000C9449000C9449000C94490061
</span></span><span style=display:flex><span>:100010000C9449000C9449000C9449000C9449003C
</span></span><span style=display:flex><span>:100020000C9449000C9449000C9449000C9449002C
</span></span><span style=display:flex><span>:100030000C9449000C9449000C9449000C9449001C
</span></span><span style=display:flex><span>:100040000C9449000C9449000C9449000C9449000C
</span></span><span style=display:flex><span>:100050000C9449000C9449000C9449000C944900FC
</span></span><span style=display:flex><span>:100060000C9449000C94490011241FBECFEFD8E036
</span></span><span style=display:flex><span>:10007000DEBFCDBF11E0A0E0B1E0E8EAF1E002C0F0
</span></span><span style=display:flex><span>:1000800005900D92A632B107D9F70E94CA000C94D0
</span></span><span style=display:flex><span>:10009000D2000C9400001092C5008093C40088E147
</span></span><span style=display:flex><span>:1000A0008093C10086E08093C20008959091C000C3
</span></span><span style=display:flex><span>:1000B00095FFFCCF8093C60008950F931F93CF93B5
</span></span><span style=display:flex><span>:1000C000DF93EC018C01060F111DC017D10721F041
</span></span><span style=display:flex><span>:1000D00089910E945600F9CFDF91CF911F910F9126
</span></span><span style=display:flex><span>:1000E00008958091C00087FFFCCF8091C6000895DD
</span></span><span style=display:flex><span>:1000F0000F931F93CF93DF93EC018C01060F111D1B
</span></span><span style=display:flex><span>:10010000C017D10721F00E9471008993F9CFDF91C8
</span></span><span style=display:flex><span>:10011000CF911F910F910895CF93DF93CDB7DEB7A5
</span></span><span style=display:flex><span>:100120002B970FB6F894DEBF0FBECDBF8BE0EBE18F
</span></span><span style=display:flex><span>:10013000F1E0DE01119601900D928A95E1F76BE0F6
</span></span><span style=display:flex><span>:10014000CE0101960E945D000E9471002B960FB6B1
</span></span><span style=display:flex><span>:10015000F894DEBF0FBECDBFDF91CF910895FF921F
</span></span><span style=display:flex><span>:100160000F931F93CF93DF93F82EC0E0D1E00CE103
</span></span><span style=display:flex><span>:1001700011E0888184508F250E94560022960C172A
</span></span><span style=display:flex><span>:100180001D07B9F78AE0DF91CF911F910F91FF9082
</span></span><span style=display:flex><span>:100190000C94560087E60E944B000E948C000E943F
</span></span><span style=display:flex><span>:1001A000AF00FBCFF894FFCF4F5551505D62795DA2
</span></span><span style=display:flex><span>:1001B00073546F5770424355717A3E3842454378C5
</span></span><span style=display:flex><span>:0E01C000773300456E746572206B65790A0016
</span></span><span style=display:flex><span>:00000001FF
</span></span></code></pre></div><p>The Intel HEX is a transitional file format for microcontrollers, (E)PROMs, and other devices. The documentation states that HEXs can be converted to binary files and programmed into a configuration device.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ objcopy -I ihex chest.hex -O binary chest.bin ; xxd chest.bin
</span></span><span style=display:flex><span>00000000: 0c94 3400 0c94 4900 0c94 4900 0c94 4900  ..4...I...I...I.
</span></span><span style=display:flex><span>00000010: 0c94 4900 0c94 4900 0c94 4900 0c94 4900  ..I...I...I...I.
</span></span><span style=display:flex><span>00000020: 0c94 4900 0c94 4900 0c94 4900 0c94 4900  ..I...I...I...I.
</span></span><span style=display:flex><span>00000030: 0c94 4900 0c94 4900 0c94 4900 0c94 4900  ..I...I...I...I.
</span></span><span style=display:flex><span>00000040: 0c94 4900 0c94 4900 0c94 4900 0c94 4900  ..I...I...I...I.
</span></span><span style=display:flex><span>00000050: 0c94 4900 0c94 4900 0c94 4900 0c94 4900  ..I...I...I...I.
</span></span><span style=display:flex><span>00000060: 0c94 4900 0c94 4900 1124 1fbe cfef d8e0  ..I...I..$......
</span></span><span style=display:flex><span>00000070: debf cdbf 11e0 a0e0 b1e0 e8ea f1e0 02c0  ................
</span></span><span style=display:flex><span>00000080: 0590 0d92 a632 b107 d9f7 0e94 ca00 0c94  .....2..........
</span></span><span style=display:flex><span>00000090: d200 0c94 0000 1092 c500 8093 c400 88e1  ................
</span></span><span style=display:flex><span>000000a0: 8093 c100 86e0 8093 c200 0895 9091 c000  ................
</span></span><span style=display:flex><span>000000b0: 95ff fccf 8093 c600 0895 0f93 1f93 cf93  ................
</span></span><span style=display:flex><span>000000c0: df93 ec01 8c01 060f 111d c017 d107 21f0  ..............!.
</span></span><span style=display:flex><span>000000d0: 8991 0e94 5600 f9cf df91 cf91 1f91 0f91  ....V...........
</span></span><span style=display:flex><span>000000e0: 0895 8091 c000 87ff fccf 8091 c600 0895  ................
</span></span><span style=display:flex><span>000000f0: 0f93 1f93 cf93 df93 ec01 8c01 060f 111d  ................
</span></span><span style=display:flex><span>00000100: c017 d107 21f0 0e94 7100 8993 f9cf df91  ....!...q.......
</span></span><span style=display:flex><span>00000110: cf91 1f91 0f91 0895 cf93 df93 cdb7 deb7  ................
</span></span><span style=display:flex><span>00000120: 2b97 0fb6 f894 debf 0fbe cdbf 8be0 ebe1  +...............
</span></span><span style=display:flex><span>00000130: f1e0 de01 1196 0190 0d92 8a95 e1f7 6be0  ..............k.
</span></span><span style=display:flex><span>00000140: ce01 0196 0e94 5d00 0e94 7100 2b96 0fb6  ......]...q.+...
</span></span><span style=display:flex><span>00000150: f894 debf 0fbe cdbf df91 cf91 0895 ff92  ................
</span></span><span style=display:flex><span>00000160: 0f93 1f93 cf93 df93 f82e c0e0 d1e0 0ce1  ................
</span></span><span style=display:flex><span>00000170: 11e0 8881 8450 8f25 0e94 5600 2296 0c17  .....P.%..V.&#34;...
</span></span><span style=display:flex><span>00000180: 1d07 b9f7 8ae0 df91 cf91 1f91 0f91 ff90  ................
</span></span><span style=display:flex><span>00000190: 0c94 5600 87e6 0e94 4b00 0e94 8c00 0e94  ..V.....K.......
</span></span><span style=display:flex><span>000001a0: af00 fbcf f894 ffcf 4f55 5150 5d62 795d  ........OUQP]by]
</span></span><span style=display:flex><span>000001b0: 7354 6f57 7042 4355 717a 3e38 4245 4378  sToWpBCUqz&gt;8BECx
</span></span><span style=display:flex><span>000001c0: 7733 0045 6e74 6572 206b 6579 0a00       w3.Enter key..
</span></span></code></pre></div><p>Note that we can also use the online tool <a href=http://matrixstorm.com/avr/hextobin/ihexconverter.html>matrixstorm</a> to do this.</p><p>Now that we have our binary, we need to identify which architecture it was compiled for.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>file chest.bin
</span></span><span style=display:flex><span>chest.bin: data
</span></span></code></pre></div><p>Well, our beloved friend <code>file</code> didn&rsquo;t recognize the file format. At that point, we have several options to discover the architecture:</p><ul><li>compiling a sample project for many architectures and clustering the outputs using correlation techniques like binary diffing in the hope of identifying the correct architecture</li><li>try disassembling for many architectures in the hope of discovering the right code</li><li>googling the HEX</li></ul><p>The Googling technique is definetly the fastest and the easiest. It gives us a
lot of results concerning <a href=https://www.microchip.com/en-us/products/microcontrollers-and-microprocessors/8-bit-mcus/avr-mcus>AVR</a>.
Let&rsquo;s give the <code>avr-objdump</code> disassembler a try:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ avr-objdump -m avr -D chest.hex
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>00000000 &lt;.sec1&gt;:
</span></span><span style=display:flex><span>   0:    0c 94 34 00     jmp    0x68    ;  0x68
</span></span><span style=display:flex><span>   4:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>   8:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>   c:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  10:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  14:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  18:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  1c:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  20:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  24:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  28:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  2c:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  30:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  34:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  38:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  3c:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  40:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  44:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  48:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  4c:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  50:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  54:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  58:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  5c:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  60:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  64:    0c 94 49 00     jmp    0x92    ;  0x92
</span></span><span style=display:flex><span>  68:    11 24           eor    r1, r1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[...]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  92:    0c 94 00 00     jmp    0    ;  0x0
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[...]
</span></span></code></pre></div><p>We can deduce from the first bytes that this is valid code. Indeed, we are looking at a 26-entries vector table.</p><p>We know that this code is targeting an Atmel AVR microcontroller, but which one?
Here is a <a href=https://gcc.gnu.org/onlinedocs/gcc/AVR-Options.html>list of the most common ones</a>, and here is a <a href=/posts/img/ECW2021_chest/avr_matrix.png>matrix</a> listing some of their available features.</p><p>Again, we have multiple options to discover the correct microcontroller:</p><ul><li>compiling samples with all the different MCU types supported by <code>avr-gcc</code> and, again, use some correlation techniques against our dump</li><li>searching more information about what we already know, like the <a href=https://ece-classes.usc.edu/ee459/library/documents/avr_intr_vectors/>interrupt vectors</a></li><li>googling the code</li></ul><p>Again, the googling technique is the fastest and the less painful. We can
quickly find a <a href=https://stackoverflow.com/q/17323757>dump like ours</a> that is targeting an ATmega328P.</p><p>We can proceed with a static analysis using the <a href=/posts/misc/ECW2021_chest/atmel-0856-avr-instruction-set-manual.pdf>AVR instruction set manual</a>
and the <a href=/posts/misc/ECW2021_chest/ATmega328-328P_Datasheet_Full.pdf>ATMega328P datasheet</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>[...]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  __decode:
</span></span><span style=display:flex><span>   15e:    ff 92           push   r15
</span></span><span style=display:flex><span>   160:    0f 93           push   r16
</span></span><span style=display:flex><span>   162:    1f 93           push   r17
</span></span><span style=display:flex><span>   164:    cf 93           push   r28
</span></span><span style=display:flex><span>   166:    df 93           push   r29
</span></span><span style=display:flex><span>   168:    f8 2e           mov    r15, r24
</span></span><span style=display:flex><span>   16a:    c0 e0           ldi    r28, 0x00
</span></span><span style=display:flex><span>   16c:    d1 e0           ldi    r29, 0x01
</span></span><span style=display:flex><span>   16e:    0c e1           ldi    r16, 0x1C
</span></span><span style=display:flex><span>   170:    11 e0           ldi    r17, 0x01
</span></span><span style=display:flex><span>   172:    88 81           ld     r24, Y
</span></span><span style=display:flex><span>   174:    84 50           subi   r24, 0x04     ; acc -= 4
</span></span><span style=display:flex><span>   176:    8f 25           eor    r24, r15      ; acc ^= user input key
</span></span><span style=display:flex><span>   178:    0e 94 56 00     call   0xac          ; __usart_transmit_byte
</span></span><span style=display:flex><span>   17c:    22 96           adiw   r28, 0x02     ; i += 2
</span></span><span style=display:flex><span>   17e:    0c 17           cp     r16, r28
</span></span><span style=display:flex><span>   180:    1d 07           cpc    r17, r29
</span></span><span style=display:flex><span>   182:    b9 f7           brne   .-18          ; loop
</span></span><span style=display:flex><span>   184:    8a e0           ldi    r24, 0x0A     ; r24 = &#39;\n&#39;
</span></span><span style=display:flex><span>   186:    df 91           pop    r29
</span></span><span style=display:flex><span>   188:    cf 91           pop    r28
</span></span><span style=display:flex><span>   18a:    1f 91           pop    r17
</span></span><span style=display:flex><span>   18c:    0f 91           pop    r16
</span></span><span style=display:flex><span>   18e:    ff 90           pop    r15
</span></span><span style=display:flex><span>   190:    0c 94 56 00     jmp    0xac          ; __usart_transmit_byte(&#39;\n&#39;)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  __main:
</span></span><span style=display:flex><span>   194:    87 e6           ldi    r24, 0x67     ; UBRR
</span></span><span style=display:flex><span>   196:    0e 94 4b 00     call   0x96          ; __usart_init(UBRR)
</span></span><span style=display:flex><span>   19a:    0e 94 8c 00     call   0x118         ; while __decode(__display_prompt())
</span></span><span style=display:flex><span>   19e:    0e 94 af 00     call   0x15e         ;
</span></span><span style=display:flex><span>   1a2:    fb cf           rjmp   .-10
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[...]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  __flag:   ; OUQP]by]sToWpBCUqz&gt;8BECxw3
</span></span><span style=display:flex><span>   1a8:     4f 55 51 50 5d 62 79 5d 73 54 6f 57 70 42 43 55 71 7a 3e 38 42 45 43 78 77 33
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  __prompt: ; Enter key
</span></span><span style=display:flex><span>   1c3:     45 6e 74 65 72 20 6b 65 79 0a 00
</span></span></code></pre></div><p>There is a decoding routine at <code>0x15e</code> for the encoded flag at <code>0x1a8</code>. This
routine needs a xor key, which is received using a serial line. We can pursue
the static analysis by bruteforcing the key. This python script will do the job:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>encoded <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;OUQP]by]sToWpBCUqz&gt;8BECxw3&#34;</span>
</span></span><span style=display:flex><span>rot_key <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> xor_key <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0xFF</span>):
</span></span><span style=display:flex><span>    decoded <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(
</span></span><span style=display:flex><span>        [
</span></span><span style=display:flex><span>            chr((ord(char) <span style=color:#f92672>-</span> rot_key) <span style=color:#f92672>^</span> xor_key)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> i, char <span style=color:#f92672>in</span> enumerate(encoded)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> decoded<span style=color:#f92672>.</span>casefold()<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;ecw{&#34;</span>):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>xor_key<span style=color:#e6db74>:</span><span style=color:#e6db74>#04x</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>{</span>decoded<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ python3 decode.py
</span></span><span style=display:flex><span>0x0e ECW{aeb1c401}
</span></span></code></pre></div><p>Another approach was to emulate the MCU and bruteforce the key like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ qemu-system-avr -S -s -nographic -serial tcp::5678,server<span style=color:#f92672>=</span>on,wait<span style=color:#f92672>=</span>off -machine uno -bios chest.bin
</span></span><span style=display:flex><span>$ printf <span style=color:#e6db74>&#34;\x0e&#34;</span> | nc localhost <span style=color:#ae81ff>5678</span>
</span></span><span style=display:flex><span>ECW{aeb1c401}
</span></span></code></pre></div><p>I hope you enjoyed it as much as I did, see you next year!</p><h2 id=fsb-as-a-service>FSB as a service</h2><p>The downloadable <a href=/posts/binaries/ECW_2021/fsb_as_a_service.txz>archive</a> contains elements used to build the docker image you can access online. It contains:</p><ul><li>a dynamic loader</li><li>a C library</li><li>a challenge binary</li></ul><p>Let&rsquo;s start with a basic <code>checksec</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>pwn checksec challenge
</span></span><span style=display:flex><span>[*] &#39;/Users/gteissier/Downloads/ecw2021-fsb_as_a_service/challenge&#39;
</span></span><span style=display:flex><span>    Arch:     aarch64-64-little
</span></span><span style=display:flex><span>    RELRO:    Full RELRO
</span></span><span style=display:flex><span>    Stack:    No canary found
</span></span><span style=display:flex><span>    NX:       NX enabled
</span></span><span style=display:flex><span>    PIE:      PIE enabled
</span></span></code></pre></div><p>The binary is rather small, compiled for aarch64, and we spot three things:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>0000000000000a90 &lt;shell&gt;:
</span></span><span style=display:flex><span> a90:	d503233f 	paciasp
</span></span><span style=display:flex><span> a94:	a9bf7bfd 	stp	x29, x30, [sp, #-16]!
</span></span><span style=display:flex><span> a98:	910003fd 	mov	x29, sp
</span></span><span style=display:flex><span> a9c:	90000000 	adrp	x0, 0 &lt;__abi_tag-0x254&gt;
</span></span><span style=display:flex><span> aa0:	91318000 	add	x0, x0, #0xc60
</span></span><span style=display:flex><span> aa4:	97ffff9f 	bl	920 &lt;system@plt&gt;
</span></span><span style=display:flex><span> aa8:	d503201f 	nop
</span></span><span style=display:flex><span> aac:	a8c17bfd 	ldp	x29, x30, [sp], #16
</span></span><span style=display:flex><span> ab0:	d65f0bff 	retaa
</span></span></code></pre></div><ol><li>The binary is cool enough to give us a shell function! <code>paciasp</code> and <code>retaa</code> are ARMv8.3 pointer-authentication instructions, they shield integrity of return addresses stored on the stack. Curious French readers can go and enjoy this <a href=https://connect.ed-diamond.com/MISC/misc-113/armv8.5-un-support-materiel-contre-les-bugs-memoires>article</a>.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>0000000000000ab4 &lt;make_readonly&gt;:
</span></span><span style=display:flex><span> ab4:	d503233f 	paciasp
</span></span><span style=display:flex><span> ab8:	a9be7bfd 	stp	x29, x30, [sp, #-32]!
</span></span><span style=display:flex><span> abc:	910003fd 	mov	x29, sp
</span></span><span style=display:flex><span> ac0:	b0000080 	adrp	x0, 11000 &lt;__FRAME_END__+0x10208&gt;
</span></span><span style=display:flex><span> ac4:	f947f400 	ldr	x0, [x0, #4072]
</span></span><span style=display:flex><span> ac8:	9274cc00 	and	x0, x0, #0xfffffffffffff000
</span></span><span style=display:flex><span> acc:	52800022 	mov	w2, #0x1                   	// #1
</span></span><span style=display:flex><span> ad0:	d2820001 	mov	x1, #0x1000                	// #4096
</span></span><span style=display:flex><span> ad4:	97ffffa7 	bl	970 &lt;mprotect@plt&gt;
</span></span><span style=display:flex><span> ad8:	b9401fe0 	ldr	w0, [sp, #28]
</span></span><span style=display:flex><span> adc:	7100001f 	cmp	w0, #0x0
</span></span><span style=display:flex><span> ae0:	54000060 	b.eq	aec &lt;make_readonly+0x38&gt;  // b.none
</span></span><span style=display:flex><span> ae4:	52800040 	mov	w0, #0x2                   	// #2
</span></span><span style=display:flex><span> ae8:	97ffff7a 	bl	8d0 &lt;_exit@plt&gt;
</span></span><span style=display:flex><span> aec:	d503201f 	nop
</span></span><span style=display:flex><span> af0:	a8c27bfd 	ldp	x29, x30, [sp], #32
</span></span><span style=display:flex><span> af4:	d65f0bff 	retaa
</span></span></code></pre></div><ol start=2><li>A memory region is made read-only. Further examination reveals the memory region made read-only contains <code>__malloc_hook</code>, and this page also coincidently contains other hooks such as <code>__realloc_hook</code> or <code>__free_hook</code>.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>0000000000000af8 &lt;main&gt;:
</span></span><span style=display:flex><span> af8:	d503233f 	paciasp
</span></span><span style=display:flex><span> afc:	a9be7bfd 	stp	x29, x30, [sp, #-32]!
</span></span><span style=display:flex><span> b00:	910003fd 	mov	x29, sp
</span></span><span style=display:flex><span>... boring setbuf follows
</span></span><span style=display:flex><span> b40:	d2801000 	mov	x0, #0x80                  	// #128
</span></span><span style=display:flex><span> b44:	97ffff6f 	bl	900 &lt;malloc@plt&gt;		// buf = malloc(0x80)
</span></span><span style=display:flex><span> b48:	f9000fe0 	str	x0, [sp, #24]
</span></span><span style=display:flex><span> b4c:	f9400fe0 	ldr	x0, [sp, #24]
</span></span><span style=display:flex><span> b50:	f100001f 	cmp	x0, #0x0
</span></span><span style=display:flex><span> b54:	54000061 	b.ne	b60 &lt;main+0x68&gt;  // b.any
</span></span><span style=display:flex><span> b58:	52800020 	mov	w0, #0x1                   	// #1
</span></span><span style=display:flex><span> b5c:	97ffff5d 	bl	8d0 &lt;_exit@plt&gt;
</span></span><span style=display:flex><span> b60:	97ffffd5 	bl	ab4 &lt;make_readonly&gt;		// turn malloc_hook and the like read-only from now on
</span></span><span style=display:flex><span> b64:	d2801002 	mov	x2, #0x80                  	// 0x80
</span></span><span style=display:flex><span> b68:	f9400fe1 	ldr	x1, [sp, #24]			// buf, allocated at 0xb44
</span></span><span style=display:flex><span> b6c:	52800000 	mov	w0, #0x0                   	// #0, stdin fileno
</span></span><span style=display:flex><span> b70:	97ffff78 	bl	950 &lt;read@plt&gt;
</span></span><span style=display:flex><span> b74:	b90017e0 	str	w0, [sp, #20]
</span></span><span style=display:flex><span> b78:	b94017e0 	ldr	w0, [sp, #20]
</span></span><span style=display:flex><span> b7c:	7100041f 	cmp	w0, #0x1
</span></span><span style=display:flex><span> b80:	5400012d 	b.le	ba4 &lt;main+0xac&gt;
</span></span><span style=display:flex><span> b84:	b98017e0 	ldrsw	x0, [sp, #20]
</span></span><span style=display:flex><span> b88:	d1000400 	sub	x0, x0, #0x1
</span></span><span style=display:flex><span> b8c:	f9400fe1 	ldr	x1, [sp, #24]
</span></span><span style=display:flex><span> b90:	8b000020 	add	x0, x1, x0
</span></span><span style=display:flex><span> b94:	3900001f 	strb	wzr, [x0]
</span></span><span style=display:flex><span> b98:	f9400fe0 	ldr	x0, [sp, #24]			// buf
</span></span><span style=display:flex><span> b9c:	97ffff71 	bl	960 &lt;printf@plt&gt;		// printf(buf)
</span></span><span style=display:flex><span> ba0:	17fffff1 	b	b64 &lt;main+0x6c&gt;			// while true
</span></span><span style=display:flex><span> ba4:	d503201f 	nop
</span></span><span style=display:flex><span> ba8:	52800060 	mov	w0, #0x3                   	// #3
</span></span><span style=display:flex><span> bac:	97ffff49 	bl	8d0 &lt;_exit@plt&gt;
</span></span></code></pre></div><ol start=3><li>After having allocated a buffer from heap, the hooks&rsquo; page is made read-only. This buffer is then used to read from stdin, and the buffer is directly fed to printf. We have a format string! There is no limit on the number of calls to <code>printf</code> we can do, thus we may:</li></ol><ul><li>leak values in stack located below our frame: stack and code locations</li><li>modify values through the use of <code>%n</code> and its variants</li></ul><p>Taking the above a bit further, we can find stack values that point to stack itself, so all in all we can forge arbitrary values on the stack, and later gain arbitrary read and write.</p><p>However, to go further, we need to turn arbitrary write to code execution:</p><ul><li>The stack does not look easily malleable: return addresses are protected through the use of <code>paciasp</code> / <code>retaa</code>;</li><li>Dynamic memory hooks have been turned read-only: there is no hope in overwriting them;</li><li>Inserting a destructor is made useless by the use of <code>_exit</code>.</li></ul><p>How to gain code execution then? There are a number of options, but looking at files contained in the initial archive, we spot a hidden file, <code>.gdb_history</code>.
This dot file is indeed a hint: <code>disassemble register_printf_specifier</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* Register FUNC to be called to format SPEC specifiers; ARGINFO must be
</span></span></span><span style=display:flex><span><span style=color:#75715e>   specified to determine how many arguments a SPEC conversion requires and
</span></span></span><span style=display:flex><span><span style=color:#75715e>   what their types are.  */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>register_printf_specifier</span> (<span style=color:#66d9ef>int</span> __spec, printf_function __func,
</span></span><span style=display:flex><span>                                      printf_arginfo_size_function __arginfo)
</span></span></code></pre></div><p>The code speaks for itself:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>__register_printf_specifier</span> (<span style=color:#66d9ef>int</span> spec, printf_function converter,
</span></span><span style=display:flex><span>	                             printf_arginfo_size_function arginfo)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>if</span> (spec <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> spec <span style=color:#f92672>&gt;</span> (<span style=color:#66d9ef>int</span>) UCHAR_MAX)
</span></span><span style=display:flex><span>	    {
</span></span><span style=display:flex><span>	      <span style=color:#a6e22e>__set_errno</span> (EINVAL);
</span></span><span style=display:flex><span>	      <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	    }
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>__libc_lock_lock</span> (lock);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>if</span> (__printf_function_table <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>	    {
</span></span><span style=display:flex><span>	      __printf_arginfo_table <span style=color:#f92672>=</span> (printf_arginfo_size_function <span style=color:#f92672>**</span>)
</span></span><span style=display:flex><span>	        <span style=color:#a6e22e>calloc</span> (UCHAR_MAX <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>sizeof</span> (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>	      <span style=color:#66d9ef>if</span> (__printf_arginfo_table <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>	        {
</span></span><span style=display:flex><span>	          result <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	          <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>	        }
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	      __printf_function_table <span style=color:#f92672>=</span> (printf_function <span style=color:#f92672>**</span>)
</span></span><span style=display:flex><span>	        (__printf_arginfo_table <span style=color:#f92672>+</span> UCHAR_MAX <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	    }
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	  __printf_function_table[spec] <span style=color:#f92672>=</span> converter;
</span></span><span style=display:flex><span>	  __printf_arginfo_table[spec] <span style=color:#f92672>=</span> arginfo;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	 out:
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>__libc_lock_unlock</span> (lock);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>This is a little known feature of <code>glibc</code>: users can register custom printf specifiers through the use of <code>register_printf_specifier</code>. This function makes use of an array of function pointers indexed by the char specifier. We can leverage this feature to overwrite one element of the array and later call <code>printf</code> with the associated specifier: the overwritten address will be called!</p><h2 id=wysiwyg>WYSIWYG</h2><h3 id=hints>Hints</h3><p>Let&rsquo;s start with the hints that were there!</p><p>Executing the challenge gives a message:</p><pre tabindex=0><code>$ ./wysiwyg
Welcome to the challenge !
</code></pre><p>The thing is that when you disassemble the challenge you won&rsquo;t see the corresponding call to printf. This was a first line of approach.</p><p>Now, executing it with an input will give you:</p><pre tabindex=0><code>$ ./wysiwyg toto
Welcome to the challenge !
Your key is:
toto
The message should be deciphered correctly if you did things right ;)
Nop !
</code></pre><p>If you&rsquo;re a try-harder and execute it a second time you would get:</p><pre tabindex=0><code>$ ./wysiwyg toto
Welcome to the challenge !
Your key is:
Are 
The message should be deciphered correctly if you did things right ;)
Nop !
</code></pre><p>What you see here is that the announced key (after <em>Your key is:</em> has changed). This was a second line of approach.</p><h3 id=main-function>Main function</h3><p>The main function of the challenge is not very helpful and quite weird at first read.
If you give an argument it reads a file called <em>text.txt</em> into <code>argv[1]</code> with a length equal to <code>strlen(argv[1])</code>.
It then copies <code>argv[1]</code> up to a maximum of 32 bytes in a buffer and prints it after <em>Your key is</em>.</p><p>The first 8 bytes of the key are set to upper case and the rest of the key is <em>xored</em> with the result of <code>sqrt(log(1337.3615)) + sinh(asinh(3615.1337))</code>.</p><p>Using mbedTLS this key will be used to decipher a message using AES-CBC with an IV set to <code>"yolo pour l'iv!"</code></p><p>Finally a <code>sha1</code> is computed on the deciphered message and if it&rsquo;s the right one, it&rsquo;s printed and it gives you the flag.</p><p>What must be seen here (and I hope you didn&rsquo;t reversed too much cryptography because it was some kind of trap!) is that the input you gave is not used which is weird.
You must find where the input affects the challenge.</p><h3 id=back-to-hints>Back to hints!</h3><p>The second time we execute the challenge, we get a different key after <em>Your key is:</em> even if we did not create and write something in <em>text.txt</em>. So something is done with <em>text.txt</em> elsewhere in the binary.</p><p>In the same way, <em>Welcome to the challenge !</em> is not printed in the main and there is no associated call to <code>printf</code> anywhere in the binary. definitively something is executed elsewhere.</p><h3 id=constructor-function>Constructor function</h3><p>!SPOILER ALERT! The binary is going to play with the loader by changing the resolved functions.</p><p>If you look closely, there is a constructor function (<em><code>__attribute__ ((constructor))</code></em>).</p><p>This function finds the base address of the binary by reading the beginning of the pages starting from the one that contains the current function and going up until it reads the magic <code>\x7fELF</code> (0x7f454c46).</p><p>Then it parses the ELF file header to find the <code>.dynamic</code> (PT_DYNAMIC) section
(see <a href=https://code.woboq.org/linux/include/elf.h.html>here</a> and <a href=https://docs.oracle.com/cd/E19683-01/816-1386/chapter6-83432/index.html>here</a>).</p><p>Once it has the .dynamic section, it finds other information it needs about the binary:</p><ul><li>the address of the GOT (specifically the <code>.got.plt</code>): <code>DT_PLTGOT</code></li><li>the address of the symbol table: <code>DT_SYMTAB</code></li><li>the address of the string table: <code>DT_STRTAB</code></li><li>the address of the PLT relocations : <code>DT_JMPREL</code></li><li>the size in bytes of the PLT relocations : <code>DT_PLTRELSZ</code></li><li>the size of one of the PLT relocation: <code>DT_RELAENT</code></li></ul><p>If your are not familiar with how the PLT and the GOT work please go and check <a href=https://www.technovelty.org/linux/plt-and-got-the-key-to-code-sharing-and-dynamic-libraries.html>this</a> or <a href=https://ypl.coffee/dl-resolve/>here</a>. The challenge is compiled with <em>lazy-bindings</em>.</p><p>The challenge then gets the offsets in the <code>.got.plt</code> of the following functions using the symbol table, the string table, and the PLT relocations:</p><ul><li><code>read</code></li><li><code>write</code></li><li><code>__memcpy_chk</code></li><li><code>__printf_chk</code></li><li><code>sinh</code></li><li><code>log</code></li><li><code>sqrt</code></li><li><code>asinh</code>.</li></ul><p><strong>Notes:</strong></p><ul><li><code>.got.plt</code> is the part of the GOT patched by <code>_dl_runtime_resolve</code> (ld.so) when symbols are resolved thanks to the PLT.</li><li>In the challenge, all the strings that are not in main are obfuscated in the same way. Characters with even offsets are xored with 0x25 and the ones with odd offsets with 0x11.</li></ul><p>It then calls <code>printf</code> with the message <em>Welcome to the challenge !</em> by calling the good <code>.got.plt</code> entry which will resolve <code>printf</code> address.</p><p>The current state of the GOT is saved and a <strong>hook</strong> is installed on future calls to <code>_dl_runtime_resolve</code>.
So now each time a function is resolved our hook is called.</p><h3 id=the-hook>The hook</h3><p>Before <code>_dl_runtime_resolve</code> is called 2 arguments are pushed on the stack: the context associated to <code>_dl_runtime_resolve</code> and the GOT offset of the function to be resolved. <code>_dl_runtime_resolve</code> cleans these arguments before calling the resolved function. Also when <code>_dl_runtime_resolve</code> is called, some volatile registers contains the arguments of the function to be resolved.
Because of this, the process is in a tricky state where quite a lot of bugs and segmentation faults can appear. To avoid this, a small trampoline is called as a <em>pre-hook</em> function to store or clean what needs to be.</p><p>The trampoline also installs a <em>post-hook</em> to be called after the resolved function to restore the GOT with the state saved during the contructor function. This is done so that our hook is always called even if a function was already resolved.</p><p>The hook acts differently depending on the resolved function.</p><ul><li>read: checks if a file called <em>change_me.txt</em> exists in the current folder and <strong>swaps read with write</strong>. read and write have the same prototypes.</li><li>write: checks if a file called <em>change_me.txt</em> exists in the current folder and <strong>swaps write with read</strong>.</li><li>memcpy (precisely <em>__memcpy_chk</em>): opens <em>text.txt</em> and writes the content of a buffer containing &ldquo;Are your sure about the formula ?&rdquo; in it. It then parses the buffer with a custom <code>sscanf</code> function using the format string <code>%x_%d-%d_%d-%d_%d-%d_%d-%d</code>.</li><li>The last effects can swap <code>sqrt</code>, <code>log</code>, <code>sinh</code> and <code>asinh</code> but it will be explained later in the write-up.</li></ul><p><strong>Note:</strong></p><p>I hope you understood that it was <code>sscanf</code> just by looking at the input and output of the function&mldr; Otherwise, I&rsquo;m sorry, it might have been hard! While developping the challenge, it kept on breaking the stack and the arguments of the resolved function when calling <code>sscanf</code>. This came from variadic arguments which were a pain to use in the context of a hook of <code>_dl_runtime_resolve</code>. In the end, I decided to use a custom <code>sscanf</code> using <a href=https://musl.libc.org/>musl</a> to remove variadic arguments.</p><h3 id=take-a-step-back>Take a step back</h3><p>The main:</p><ul><li>reads the context of <em>text.txt</em> into <code>argv[1]</code> with a length of <code>strlen(argv[1])</code></li><li>memcpy it into a 32 bit buffer and prints the key.</li><li>XOR this buffer with the result of <code>sqrt(log(1337.3615)) + sinh(asinh(3615.1337))</code>.</li><li>Uses the buffer to decipher a message.</li></ul><p>But if we also look at the hook (without creating a <em>chang_me.txt</em> file for the moment) we get:</p><ul><li>reads the context of <em>text.txt</em> into <code>argv[1]</code> with a length of <code>strlen(argv[1])</code></li><li>memcpy is resolved, the hook writes &ldquo;Are your sure about the formula ?&rdquo; in <em>text.txt</em> if the file exists.</li><li>memcpy <code>argv[1]</code> it into a 32 bit buffer and prints the it.</li><li>XOR this buffer with the result of <code>sqrt(log(1337.3615)) + sinh(asinh(3615.1337))</code>.</li><li>Uses the buffer to decipher a message.</li></ul><p>That is why the second time you execute the challenge a part of &ldquo;Are your sure about the formula ?&rdquo; is printed, <code>strlen(argv[1])</code> characters to be precise.</p><h3 id=resolution>Resolution</h3><p>Now, if you create a file named <em>chang_me.txt</em> this is what happens:</p><ul><li>read is called but is changed to write by the hook so <code>argv[1]</code> is written to <em>text.txt</em></li><li>memcpy is resolved, the hook calls write but it is changed to read. So the file <em>text.txt</em> is read in a buffer which is then parsed by a <code>sscanf</code> using the format string <code>%x_%d-%d_%d-%d_%d-%d_%d-%d</code>. The first <code>%x</code> is a magic that is checked later and the <code>%d</code> are stored in an array.</li><li>memcpy <code>argv[1]</code> into a 32 bit buffer and print it.</li><li><code>sqrt(log(1337.3615)) + sinh(asinh(3615.1337))</code> is computed. This will call the hook at the resolution of <code>sqrt</code>, <code>log</code>, <code>sinh</code> and <code>asinh</code>. If the magic parsed by the <code>sscanf</code> is equal to <em>0xfacebeef</em> these four functions will be swapped using the indexes you gave. In the format string <code>%x_%d-%d_%d-%d_%d-%d_%d-%d</code> each <code>%d-%d</code> corresponds to a permutation, you must give the indexes of <code>sqrt</code> (26), <code>log</code> (12), <code>sinh</code> (19) and <code>asinh</code> (30) otherwise it will not work. In other words you can control the formula of this computation through <code>argv[1]</code>.</li><li>XOR the buffer with the result of the previous computation.</li><li>Use the buffer to decipher a message.</li></ul><p>To summarize, to resolve the challenge you must create a file called <em>chang_me.txt</em> and then find the correct formula by bruteforcing (there is only 256 possibilities and the main returns -1 if you failed).</p><p>Finally you will get:</p><pre tabindex=0><code>$ touch change_me.txt
$ ./wysiwyg facebeef_26-19_12-26_19-30_30-12
Welcome to the challenge !
Your key is:
facebeef_26-19_12-26_19-30_30-12
The message should be deciphered correctly if you did things right ;)
Good job ! ;) Your flag is:
ECW{H4v3_FuN_1n_7H3_L0D3R}
</code></pre><p>I hope you liked it and that you learned things about the loader!</p><h2 id=conclusion>Conclusion</h2><p>We hope you had fun with these challenges and you definitely learned something even if you did not get through it. We will be glad to meet you during the CTF final and discuss about theses challenges and uncover our jobs in more details.</p><p>We look forward to reading your write-ups and techniques you used in order to solve these challenges.</p><h2 id=internships-2022>Internships 2022</h2><ul><li><a href=https://emploi.thalesgroup.com/emploi/rennes/fuzzing-android-system-services-stage-h-f/17883/16071146400>Fuzzing Android System Services</a></li><li><a href=https://emploi.thalesgroup.com/emploi/rennes/ai-assisted-fuzzing-stage-h-f/17883/15757478912>AI assisted Fuzzing</a></li><li><a href=https://emploi.thalesgroup.com/emploi/rennes/windows-attack-surface-analyzer-stage-h-f/17883/15757478816>Windows attack surface analyzer</a></li><li><a href=https://jobs.thalesgroup.com/job/rennes/leveraging-android-custom-permissions-stage-h-f/1766/15757545888>Leveraging Android custom permissions</a></li><li><a href=https://jobs.thalesgroup.com/job/rennes/frontend-gdb-avec-dear-imgui-en-rust-stage-h-f/1766/15757546896>Frontend GDB avec Dear ImGui en Rust</a></li></ul><p>All thalium&rsquo;s offers can be found at <a href=https://jobs.thalesgroup.com/search-jobs/thalium>Thales job portal</a>.</p></div><footer class=post-footer><div class=post-footer-data><div class=tags><div class=tag><a href=/tags/ctf>#CTF</a></div><div class=tag><a href=/tags/writeup>#Writeup</a></div><div class=tag><a href=/tags/ecw-2021>#ECW 2021</a></div><div class=tag><a href=/tags/reverse-engineering>#Reverse Engineering</a></div><div class=tag><a href=/tags/exploit>#Exploit</a></div></div><span class=date>2021-10-25
<span class=author>by
Thalium team</span></span></div></footer></article><footer><div class=social-links-footer><a href=mailto:contact@thalium.re><div class=social-link>Email</div></a><a href=https://github.com/thalium target=_blank><div class=social-link>Github</div></a><a href=https://twitter.com/thalium_team target=_blank><div class=social-link>Twitter</div></a></div><div class=copyright>Copyright (c) 2025, all rights reserved.</div><div class=poweredby>Powered by <a href=https://gohugo.io/>Hugo</a>.</div></footer></div></body></html>