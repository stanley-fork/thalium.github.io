<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=author content="Thalium Team"><meta name=description content="Thalium blog."><meta name=keywords content="blog,tech"><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><meta name=generator content="Hugo 0.120.4"><link rel=canonical href=/posts/ecw-2023-kaleidoscope-write-up/><meta property="og:title" content="ECW 2023: kaleidoscope (write-up)"><meta property="og:description" content="kaleidoscope was a hard reverse engineering challenge created for the European Cyber Week CTF 2023 qualifiers, with a focus on Windows-specific mechanisms and VM-based obfuscation."><meta property="og:type" content="article"><meta property="og:url" content="/posts/ecw-2023-kaleidoscope-write-up/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-07T12:00:00+01:00"><meta property="article:modified_time" content="2023-11-07T12:00:00+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ECW 2023: kaleidoscope (write-up)"><meta name=twitter:description content="kaleidoscope was a hard reverse engineering challenge created for the European Cyber Week CTF 2023 qualifiers, with a focus on Windows-specific mechanisms and VM-based obfuscation."><meta itemprop=name content="ECW 2023: kaleidoscope (write-up)"><meta itemprop=description content="kaleidoscope was a hard reverse engineering challenge created for the European Cyber Week CTF 2023 qualifiers, with a focus on Windows-specific mechanisms and VM-based obfuscation."><meta itemprop=datePublished content="2023-11-07T12:00:00+01:00"><meta itemprop=dateModified content="2023-11-07T12:00:00+01:00"><meta itemprop=wordCount content="5161"><meta itemprop=keywords content="CTF,Writeup,ECW 2023,Reverse Engineering,Windows,"><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=/css/default-dark.css><link rel=icon href=/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141692648-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><title>ECW 2023: kaleidoscope (write-up)
</title><script>MathJax={tex:{inlineMath:[["∳","∳"]],displayMath:[["∳∳","∳∳"]],processEscapes:!0},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></head><body><style>@font-face{font-family:days_one;src:url(/days_one.ttf)format('truetype')}.siteTitle{margin-top:24px}.siteTitle img{display:inline-block;vertical-align:middle;margin-top:-24px;margin-right:-10px}.siteTitle span{font-family:days_one,Fallback,sans-serif;color:#fff;font-size:160%}</style><div class=main><header><div class=header-bar><nav><div class=siteTitle><a href=/><img src=/shard_only_no_background.png width=12%></img>
<span>THALIUM</span></a></div><a class=nav-item href=/posts/><div class=nav-item-title>Posts</div></a><a class=nav-item href=/joinus/><div class=nav-item-title>Join Us</div></a><a class=nav-item href=/about/><div class=nav-item-title>About</div></a></nav><div class=social-links-header><a href=mailto:contact@thalium.re><div class=social-link>Email</div></a><a href=https://github.com/thalium target=_blank><div class=social-link>Github</div></a><a href=https://twitter.com/thalium_team target=_blank><div class=social-link>Twitter</div></a></div></div></header><article class=post><h1 class=title>ECW 2023: kaleidoscope (write-up)</h1><div class=content><p>This year again, Thalium took part in organizing the <a href=https://www.european-cyber-week.eu/>European Cyber Week</a> CTF qualifiers, as well as designing several challenges in our core competencies.</p><p><strong>kaleidoscope</strong> was a hard reverse engineering challenge, with a focus on Windows-specific mechanisms and obfuscation. 14 contestants managed to solve it. You can download the challenge files <a href=/posts/binaries/ecw-2023/kaleidoscope/kaleidoscope.7z>here</a> (password: <code>thalium</code>).</p><p>In this write-up, I will explain my thoughts as the author of the challenge, and describe two different approaches that could be leveraged to untangle its inner workings.</p><h1 id=introduction>Introduction</h1><p>The challenge&rsquo;s description was the following:</p><p><a href=/posts/img/ecw-2023/kaleidoscope/challenge.png target=_blank><img src=/posts/img/ecw-2023/kaleidoscope/challenge.png alt="Challenge description"></a></p><p>It refers to the concept of <a href=https://en.wikipedia.org/wiki/Weird_machine>weird machine</a>, which can be thought of as the set of <em>unintended</em> states that can be reached in a program (e.g. by leveraging a vulnerability such as memory corruption, and « breaking out » of the program&rsquo;s initial specification). This will prove important later.</p><p>We are given an executable file (<code>kaleidoscope.exe</code>) and an unknown binary file (<code>wtf.bin</code>). Running the former yields:</p><pre tabindex=0><code>$ ./kaleidoscope.exe
Usage: C:\work\ctf\ecw\2023\kaleidoscope\kaleidoscope.exe program.bin
</code></pre><p>Let&rsquo;s pass <code>wtf.bin</code> as argument:</p><pre tabindex=0><code>$ ./kaleidoscope.exe wtf.bin
   __        __    _    __
  / /_____ _/ /__ (_)__/ /__  __________  ___  ___
 /  &#39;_/ _ `/ / -_) / _  / _ \(_-&lt; __/ _ \/ _ \/ -_)
/_/\_\\_,_/_/\__/_/\_,_/\___/___|__/\___/ .__/\__/
                                       /_/

Enter the password: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
Uhh... no
Terminated
</code></pre><p>CTF players with some experience in reverse engineering will most likely recognize what seems to be VM-based obfuscation, <code>wtf.bin</code> being the emulated program. Here is its hexdump:</p><pre tabindex=0><code>00000000  e3 0c a9 f1 b1 61 79 86 2d e9 ee 5a d6 a6 8f 63  |ã.©ñ±ay.-éîZÖ¦.c|
00000010  55 01 00 00 20 20 20 5f 5f 20 20 20 20 20 20 20  |U...   __       |
00000020  20 5f 5f 20 20 20 20 5f 20 20 20 20 5f 5f 20 20  | __    _    __  |
00000030  20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20  |                |
00000040  20 20 20 20 20 20 20 0a 20 20 2f 20 2f 5f 5f 5f  |       .  / /___|
00000050  5f 5f 20 5f 2f 20 2f 5f 5f 20 28 5f 29 5f 5f 2f  |__ _/ /__ (_)__/|
00000060  20 2f 5f 5f 20 20 5f 5f 5f 5f 5f 5f 5f 5f 5f 5f  | /__  __________|
00000070  20 20 5f 5f 5f 20 20 5f 5f 5f 20 0a 20 2f 20 20  |  ___  ___ . /  |
00000080  27 5f 2f 20 5f 20 60 2f 20 2f 20 2d 5f 29 20 2f  |&#39;_/ _ `/ / -_) /|
00000090  20 5f 20 20 2f 20 5f 20 5c 28 5f 2d 3c 20 5f 5f  | _  / _ \(_-&lt; __|
000000a0  2f 20 5f 20 5c 2f 20 5f 20 5c 2f 20 2d 5f 29 0a  |/ _ \/ _ \/ -_).|
000000b0  2f 5f 2f 5c 5f 5c 5c 5f 2c 5f 2f 5f 2f 5c 5f 5f  |/_/\_\\_,_/_/\__|
000000c0  2f 5f 2f 5c 5f 2c 5f 2f 5c 5f 5f 5f 2f 5f 5f 5f  |/_/\_,_/\___/___|
000000d0  7c 5f 5f 2f 5c 5f 5f 5f 2f 20 2e 5f 5f 2f 5c 5f  ||__/\___/ .__/\_|
000000e0  5f 2f 20 0a 20 20 20 20 20 20 20 20 20 20 20 20  |_/ .            |
000000f0  20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20  |                |
00000100  20 20 20 20 20 20 20 20 20 20 20 2f 5f 2f 20 20  |           /_/  |
00000110  20 20 20 20 20 20 20 0a 0a 45 6e 74 65 72 20 74  |       ..Enter t|
00000120  68 65 20 70 61 73 73 77 6f 72 64 3a 20 4e 69 63  |he password: Nic|
00000130  65 20 6f 6e 65 21 0a 55 68 68 2e 2e 2e 20 6e 6f  |e one!.Uhh... no|
00000140  0a 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000150  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000160  00 01 00 00 00 01 00 00 00 ef c2 18 d2 13 aa 11  |.........ïÂ.Ò.ª.|
00000170  02 2b 1e 89 4d 87 07 a7 92 e6 41 5d 9a dc fc 1c  |.+..M..§.æA].Üü.|
00000180  50 fd ba 01 f0 1c 4b 14 ed 44 4d ca ec af 03 13  |Pýº.ð.K.íDMÊì¯..|
00000190  c3 25 8c ee 5b 24 27 3a 63 c3 be 1d 8a 77 7d f1  |Ã%.î[$&#39;:cÃ¾..w}ñ|
000001a0  80 0a 2f 7d c5 ca ee be a8 5a 48 dd e5 3b 3a 98  |../}ÅÊî¾¨ZHÝå;:.|
000001b0  5b 9a 91 88 42 81 0c 7f 88 10 7c 18 93 03 4d a6  |[...B.....|...M¦|
000001c0  52 7b fa 9c f4 5a 0d 5f a1 6a c8 f0 f1 e7 ca c6  |R{ú.ôZ._¡jÈðñçÊÆ|
000001d0  40 6d 9d 66 e2 a9 1b b4 df 3d c1 41 f1 8e cb 45  |@m.fâ©.´ß=ÁAñ.ËE|
000001e0  ba 00 b5 a8 6b 8c 63 ba 22 03 9f 64 63 89 2e 25  |º.µ¨k.cº&#34;..dc..%|
000001f0  48 cf 23 dd de f3 15 ca 5c 22 32 2e 6c a5 5e 32  |HÏ#ÝÞó.Ê\&#34;2.l¥^2|
00000200  78 91 c4 26 5a ad 90 61 12 0b 3f 15 68 c0 b3 82  |x.Ä&amp;Z..a..?.hÀ³.|
00000210  dd 21 ad fe 02 f7 d5 d7 9a ce de d9 41 41 bb 2c  |Ý!.þ.÷Õ×.ÎÞÙAA»,|
00000220  3e 5c b5 4e 82 ed 10 1e 38 d0 51 aa ac 7d 4f 31  |&gt;\µN.í..8ÐQª¬}O1|
00000230  26 38 9a 9a 2b f4 4d 66 33 94 97 7d 70 7c 99 6c  |&amp;8..+ôMf3..}p|.l|
00000240  ba 13 4d a7 79 be df 79 f7 3a bc 97 99 8f 7a 72  |º.M§y¾ßy÷:¼...zr|
00000250  40 ae 86 dc fe ed aa 75 67 f3 ee d3 b8 70 03 32  |@®.ÜþíªugóîÓ¸p.2|
00000260  0d 5d 91 c9 47 ea 8e dd 5f 7c 34 0c d5 77 99 f9  |.].ÉGê.Ý_|4.Õw.ù|
00000270  ed 11 eb 8b 37 29 3f 6f 99 1e 8d 3c 85 3b 53 e0  |í.ë.7)?o...&lt;.;Sà|
00000280  a2 e3 1c 9f 45 c7 e0 05 50 85 6e 99 16 16 c0 c8  |¢ã..EÇà.P.n...ÀÈ|
00000290  cb 23 bd 3d b8 f7 0e f6 d4 0e 3e 8f 52 46 6a 13  |Ë#½=¸÷.öÔ.&gt;.RFj.|
000002a0  44 2d 6f 96 bf 3a f9 ab 46 59 c1 76 a3 76 a8 fb  |D-o.¿:ù«FYÁv£v¨û|
000002b0  05 d4 ef 13 56 27 54 44 f8 03 f0 07 96 29 5e 33  |.Ôï.V&#39;TDø.ð..)^3|
000002c0  95 be 3a 06 20 fe 68 a5 24 d0 b5 43 07 cb e9 5f  |.¾:. þh¥$ÐµC.Ëé_|
000002d0  7f 93 b9 b0 d9 1b 0f c6 da d9 2b ff 0e f0 8f de  |..¹°Ù..ÆÚÙ+ÿ.ð.Þ|
000002e0  b9 27 b5 0e 4d 63 0a 57 12 75 2a e1 56 2d ea 41  |¹&#39;µ.Mc.W.u*áV-êA|
000002f0  b5 26 6d 6b 19 ad eb 51 26 77 f5 e7 67 92 9c 2d  |µ&amp;mk..ëQ&amp;wõçg..-|
00000300  f8 7b 49 9b ed 27 05 79 cb 5a be 24 2a 14 0f 02  |ø{I.í&#39;.yËZ¾$*...|
00000310  91 46 7d bd a0 b1 78 0a 4a 7e 60 07 cf ec 3e 2e  |.F}½ ±x.J~`.Ïì&gt;.|
00000320  a7 f0 3d a2 46 72 56 75 23 1e 73 c3 d0 27 5a 8f  |§ð=¢FrVu#.sÃÐ&#39;Z.|
00000330  fe 82 dc e6 ac ed 4d 1d 4d 45 74 1b 14 8e 67 ef  |þ.Üæ¬íM.MEt...gï|
00000340  aa e4 a8 5f db a3 ac c6 95 2f 9b 70 d3 d5 57 50  |ªä¨_Û£¬Æ./.pÓÕWP|
00000350  45 a9 e5 f6 16 58 70 7f be 9f f3 24 df 75 18 9c  |E©åö.Xp.¾.ó$ßu..|
00000360  60 11 d2 d0 df a5 02 57 ad 64 ce 23 56 31 b4 fd  |`.ÒÐß¥.W.dÎ#V1´ý|
00000370  63 5d 3f a9 af 7c 2e 26 12 24 a3 2e 77 60 0e aa  |c]?©¯|.&amp;.$£.w`.ª|
00000380  47 91 cf 66 29 a4 3a f8 33 9a 76 80 ef a6 3a 7b  |G.Ïf)¤:ø3.v.ï¦:{|
00000390  a5 c8 f4 d4 b7 31 e6 13 df c1 c4 8c f6 f6 61 56  |¥ÈôÔ·1æ.ßÁÄ.ööaV|
000003a0  91 dd d0 97 b1 a5 b4 b2 4f 15 ad e8 cc 44 df 58  |.ÝÐ.±¥´²O..èÌDßX|
000003b0  ee c7 2a e2 64 86 b7 83 1e 35 3a f6 db 79 3f 5d  |îÇ*âd.·..5:öÛy?]|
000003c0  a3 64 18 16 09 fc 5d 82 ba 4f 0c 10 79 79 f6 9f  |£d...ü].ºO..yyö.|
000003d0  af fe 6b d0 2c e0 b0 01 17 c4 44 b3 6b 83 80 e0  |¯þkÐ,à°..ÄD³k..à|
000003e0  ce 95 5c d8 2b 89 ba fc b3 26 b7 d9 34 64 c9 71  |Î.\Ø+.ºü³&amp;·Ù4dÉq|
000003f0  ac bb 7b 40 66 9d 5e 73 4c cc 73 a0 78 37 4a 2c  |¬»{@f.^sLÌs x7J,|
00000400  9c                                               |.|
</code></pre><p>We can already point out a few relevant elements:</p><ul><li>the file starts with 16 seemingly random bytes;</li><li>then, it is followed by a section that contains program data, including strings;</li><li>finally, the main part of the file, which would be the code, has a high entropy (7.7), hinting towards compression or encryption.</li></ul><p>Other than that, there is not much more to uncover in pure black-box, so let&rsquo;s reverse the host binary.</p><h1 id=reversing-the-vm-host>Reversing the VM host</h1><p>The main function opens the argument file, and parses it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>FileA <span style=color:#f92672>=</span> CreateFileA(filename_argv, GENERIC_READ, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>i64, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span style=color:#ae81ff>0</span>i64);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ( FileA <span style=color:#f92672>==</span> (HANDLE)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>i64 )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;Could not open file</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ( ReadFile(FileA, <span style=color:#f92672>&amp;</span>Key, <span style=color:#ae81ff>0x10u</span>, <span style=color:#f92672>&amp;</span>NumberOfBytesRead, <span style=color:#ae81ff>0</span>i64)
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;&amp;</span> NumberOfBytesRead <span style=color:#f92672>==</span> <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;&amp;</span> ReadFile(FileA, <span style=color:#f92672>&amp;</span>EntryPoint, <span style=color:#ae81ff>4u</span>, <span style=color:#f92672>&amp;</span>NumberOfBytesRead, <span style=color:#ae81ff>0</span>i64)
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;&amp;</span> NumberOfBytesRead <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;&amp;</span> (Program <span style=color:#f92672>=</span> malloc(<span style=color:#ae81ff>0x10000u</span>i64)) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>i64
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;&amp;</span> (memset(Program, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0x10000u</span>i64), ReadFile(FileA, Program, <span style=color:#ae81ff>0x10000u</span>, <span style=color:#f92672>&amp;</span>NumberOfBytesRead, <span style=color:#ae81ff>0</span>i64))
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;&amp;</span> NumberOfBytesRead )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    CloseHandle(FileA);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( CreateThread(<span style=color:#ae81ff>0</span>i64, <span style=color:#ae81ff>0</span>i64, CryptoWorkerMain, <span style=color:#ae81ff>0</span>i64, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&amp;</span>CryptoWorkerTid) )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ProgramInfo.EntryPoint <span style=color:#f92672>=</span> EntryPoint;
</span></span><span style=display:flex><span>        ProgramInfo.Program <span style=color:#f92672>=</span> Program;
</span></span><span style=display:flex><span>        v9 <span style=color:#f92672>=</span> CreateThread(<span style=color:#ae81ff>0</span>i64, <span style=color:#ae81ff>0</span>i64, VMWorkerMain, <span style=color:#f92672>&amp;</span>ProgramInfo, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&amp;</span>VMWorkerTid);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( v9 )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            WaitForSingleObject(v9, <span style=color:#ae81ff>0xFFFFFFFF</span>);
</span></span><span style=display:flex><span>            puts(<span style=color:#e6db74>&#34;Terminated&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;CreateThread failed (%lu)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, GetLastError());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A 16-byte key is first read, then the offset of the entry point in the emulated program is read (4 bytes). Some space for the program is allocated on the heap, and the rest of the file (up to 0x10000 bytes) is read into it. This includes both the data/strings section and the encrypted code section.</p><p>After that, two threads are created:</p><ul><li>one dedicated to cryptographic operations, which we shall call the <em>crypto worker</em>;</li><li>one dedicated to running the virtualized program, which we shall call the <em>VM worker</em>. It takes the program and the entry point as parameters in a structure.</li></ul><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 816 153"><g transform="translate(8,16)"><path d="M344 0H472" fill="none" stroke="currentcolor"/><path d="M328 32h72" fill="none" stroke="currentcolor"/><path d="M4e2 32h56" fill="none" stroke="currentcolor"/><path d="M288 48h96" fill="none" stroke="currentcolor"/><path d="M416 48h96" fill="none" stroke="currentcolor"/><path d="M168 96H368" fill="none" stroke="currentcolor"/><path d="M440 96H608" fill="none" stroke="currentcolor"/><path d="M168 128H368" fill="none" stroke="currentcolor"/><path d="M440 128H608" fill="none" stroke="currentcolor"/><path d="M168 96v32" fill="none" stroke="currentcolor"/><path d="M272 64V80" fill="none" stroke="currentcolor"/><path d="M328 16V32" fill="none" stroke="currentcolor"/><path d="M368 96v32" fill="none" stroke="currentcolor"/><path d="M440 96v32" fill="none" stroke="currentcolor"/><path d="M472 0V16" fill="none" stroke="currentcolor"/><path d="M528 64V80" fill="none" stroke="currentcolor"/><path d="M608 96v32" fill="none" stroke="currentcolor"/><path d="M272 80v8" fill="none" stroke="currentcolor"/><polygon points="288.000000,80.000000 276.000000,74.400002 276.000000,85.599998" fill="currentcolor" transform="rotate(90.000000, 272.000000, 80.000000)"/><path d="M528 80v8" fill="none" stroke="currentcolor"/><polygon points="544.000000,80.000000 532.000000,74.400002 532.000000,85.599998" fill="currentcolor" transform="rotate(90.000000, 528.000000, 80.000000)"/><path d="M344 0A16 16 0 00328 16" fill="none" stroke="currentcolor"/><path d="M472 16A16 16 0 01456 32" fill="none" stroke="currentcolor"/><path d="M288 48A16 16 0 00272 64" fill="none" stroke="currentcolor"/><path d="M4e2 32A16 16 0 01384 48" fill="none" stroke="currentcolor"/><path d="M4e2 32a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M512 48a16 16 0 0116 16" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="192" y="116" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="200" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="208" y="116" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="216" y="116" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="224" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="232" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="248" y="116" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="256" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="264" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="272" y="116" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="280" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="288" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="304" y="116" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="312" y="116" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="320" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="328" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="344" y="116" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="360" y="20" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="368" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="376" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="384" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="400" y="20" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="408" y="20" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="416" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="424" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="432" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="440" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="464" y="116" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="472" y="116" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="488" y="116" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="496" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="504" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="512" y="116" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="520" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="528" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="544" y="116" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="552" y="116" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="560" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="568" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="576" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="584" y="116" fill="currentcolor" style="font-size:1em">d</text></g></svg></div><p>The VM worker initializes a context for the virtual machine, and then enters a loop in which it fetches the instructions and handles them.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__fastcall</span> __noreturn <span style=color:#a6e22e>VMWorkerMain</span>(ProgramInfo <span style=color:#f92672>*</span>ProgramInfo)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> EntryPoint; <span style=color:#75715e>// ebx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> Ins; <span style=color:#75715e>// eax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  VmContext VmCtx; <span style=color:#75715e>// [rsp+20h] [rbp-59h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  EntryPoint <span style=color:#f92672>=</span> ProgramInfo<span style=color:#f92672>-&gt;</span>EntryPoint;
</span></span><span style=display:flex><span>  VmCtx.Stack <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>  VmCtx.Program <span style=color:#f92672>=</span> ProgramInfo<span style=color:#f92672>-&gt;</span>Program;
</span></span><span style=display:flex><span>  VmCtx.SyscallHandlers[<span style=color:#ae81ff>5</span>] <span style=color:#f92672>=</span> SyscallUnimplemented;
</span></span><span style=display:flex><span>  VmCtx.SyscallHandlers[<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> SyscallUnimplemented;
</span></span><span style=display:flex><span>  memset(VmCtx.Registers, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>72</span>);
</span></span><span style=display:flex><span>  VmCtx.SyscallHandlers[<span style=color:#ae81ff>7</span>] <span style=color:#f92672>=</span> SyscallUnimplemented;
</span></span><span style=display:flex><span>  VmCtx.SyscallHandlers[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> sub_10D0;
</span></span><span style=display:flex><span>  VmCtx.SyscallHandlers[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> sub_1120;
</span></span><span style=display:flex><span>  VmCtx.SyscallHandlers[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> sub_1170;
</span></span><span style=display:flex><span>  VmCtx.SyscallHandlers[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> sub_1190;
</span></span><span style=display:flex><span>  VmCtx.SyscallHandlers[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> sub_1280;
</span></span><span style=display:flex><span>  VmCtx.Stack <span style=color:#f92672>=</span> (DWORD <span style=color:#f92672>*</span>)calloc(<span style=color:#ae81ff>0x2000u</span>i64, <span style=color:#ae81ff>4u</span>i64);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( VmCtx.Stack )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    VmCtx.Registers[<span style=color:#ae81ff>15</span>] <span style=color:#f92672>=</span> EntryPoint;
</span></span><span style=display:flex><span>    VmCtx.Registers[<span style=color:#ae81ff>13</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x2000</span>;
</span></span><span style=display:flex><span>    hKernel32 <span style=color:#f92672>=</span> LoadLibraryA(<span style=color:#e6db74>&#34;kernel32.dll&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> ( VmCtx.Registers[<span style=color:#ae81ff>15</span>] <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x10000</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      Ins <span style=color:#f92672>=</span> VM_FetchInstruction(<span style=color:#f92672>&amp;</span>VmCtx);
</span></span><span style=display:flex><span>      VM_HandleInstruction(<span style=color:#f92672>&amp;</span>VmCtx, Ins);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  ExitProcess(<span style=color:#ae81ff>1u</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Further analysis of the handling logic shows that the VM works with 32-bit registers, a stack, and up to 8 syscalls (we can see some of the subs call <code>fread</code>/<code>fwrite</code> for I/O).</p><p>The context structure stores the values for 16 different registers, some special ones like 0xF or 0xD being dedicated to the program counter and stack pointer.</p><p>The <code>VM_FetchInstruction</code> function reads a 4-byte instruction from the current program counter, but then does something more unexpected:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>DWORD <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>VM_FetchInstruction</span>(VmContext <span style=color:#f92672>*</span>VmCtx)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  LPARAM PC; <span style=color:#75715e>// rax MAPDST
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  WPARAM Ins; <span style=color:#75715e>// rdi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>tagMSG</span> Msg; <span style=color:#75715e>// [rsp+30h] [rbp-48h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  PC <span style=color:#f92672>=</span> VmCtx<span style=color:#f92672>-&gt;</span>Registers[<span style=color:#ae81ff>15</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)PC <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0x10000</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    puts(<span style=color:#e6db74>&#34;Program overflow&#34;</span>);
</span></span><span style=display:flex><span>    ExitProcess(<span style=color:#ae81ff>1u</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  PC <span style=color:#f92672>=</span> VmCtx<span style=color:#f92672>-&gt;</span>Registers[<span style=color:#ae81ff>15</span>];
</span></span><span style=display:flex><span>  Ins <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>VmCtx<span style=color:#f92672>-&gt;</span>Program[PC];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ( <span style=color:#f92672>!</span>PostThreadMessageA(CryptoWorkerTid, <span style=color:#ae81ff>0x1337u</span>, Ins, PC) )
</span></span><span style=display:flex><span>    Sleep(<span style=color:#ae81ff>100u</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ( <span style=color:#f92672>!</span>PeekMessageA(<span style=color:#f92672>&amp;</span>Msg, HWND_MESSAGE<span style=color:#f92672>|</span><span style=color:#ae81ff>0x2</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1u</span>) <span style=color:#f92672>||</span> Msg.message <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0x1338</span> )
</span></span><span style=display:flex><span>    Sleep(<span style=color:#ae81ff>0xAu</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Msg.wParam;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It uses the <a href=https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-postthreadmessagea><code>PostThreadMessageA</code></a> function from Windows API, which posts a message to a message queue of a specific thread (here, the crypto worker thread).</p><p>This function is often used to send window events, but one can define custom messages by choosing a message identifier in the <em>private</em> range, between 0x0400 (<code>WM_USER</code>) and 0xFFFF. Here, we can see that two message types exist: 0x1337 and 0x1338.</p><p>The VM worker thread sends the information of the fetched instruction (<code>Ins</code>) and the current program counter (<code>PC</code>) to the crypto worker thread through the 0x1337 message type. Then, a 0x1338 message is received from the crypto worker thread (thanks to <a href=https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-peekmessagea><code>PeekMessageA</code></a>), which contains the decrypted instruction that will be sent over to <code>VM_HandleInstruction</code>.</p><p>For this part, I was inspired by the notion of <em>Instruction Set Randomization</em>, a theoretical mitigation against code injection attacks (which can be implemented at both hardware or software level). Here, instructions are encrypted and decrypted on-the-fly through the crypto worker thread.</p><p>Let&rsquo;s take a look at the crypto worker:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__fastcall</span> __noreturn <span style=color:#a6e22e>CryptoWorkerMain</span>(<span style=color:#66d9ef>__int64</span> lpThreadParameter)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> v1; <span style=color:#75715e>// rbx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>tagMSG</span> Msg; <span style=color:#75715e>// [rsp+38h] [rbp-40h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  SetSeed(lpThreadParameter, <span style=color:#ae81ff>0xBAD1DEAu</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ( <span style=color:#ae81ff>1</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( PeekMessageA(<span style=color:#f92672>&amp;</span>Msg, HWND_MESSAGE<span style=color:#f92672>|</span><span style=color:#ae81ff>0x2</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1u</span>) <span style=color:#f92672>&amp;&amp;</span> Msg.message <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x1337</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      v1 <span style=color:#f92672>=</span> LODWORD(Msg.wParam) <span style=color:#f92672>^</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span>)(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)TEA_Encrypt(Msg.lParam);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>while</span> ( <span style=color:#f92672>!</span>PostThreadMessageA(VMWorkerTid, <span style=color:#ae81ff>0x1338u</span>, v1, <span style=color:#ae81ff>0</span>i64) )
</span></span><span style=display:flex><span>        Sleep(<span style=color:#ae81ff>0xAu</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      Sleep(<span style=color:#ae81ff>0xAu</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>SetSeed</code> function sets a global variable <code>Seed</code> to 0xBAD1DEA. Then, every time an encrypted instruction arrives, it is decrypted by xoring it with <code>TEA_Encrypt(PC)</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>DWORD <span style=color:#66d9ef>__stdcall</span> <span style=color:#a6e22e>TEA_Encrypt</span>(DWORD v0)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> v1; <span style=color:#75715e>// eax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> sum; <span style=color:#75715e>// r9d
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> rounds; <span style=color:#75715e>// r10
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  v1 <span style=color:#f92672>=</span> Seed;
</span></span><span style=display:flex><span>  sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  rounds <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>i64;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>-=</span> <span style=color:#ae81ff>0x61C88647</span>;
</span></span><span style=display:flex><span>    v0 <span style=color:#f92672>+=</span> (sum <span style=color:#f92672>+</span> v1) <span style=color:#f92672>^</span> (Key0 <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> v1) <span style=color:#f92672>^</span> (Key1 <span style=color:#f92672>+</span> (v1 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>5</span>));
</span></span><span style=display:flex><span>    v1 <span style=color:#f92672>+=</span> (sum <span style=color:#f92672>+</span> v0) <span style=color:#f92672>^</span> (Key2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> v0) <span style=color:#f92672>^</span> (Key3 <span style=color:#f92672>+</span> (v0 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>5</span>));
</span></span><span style=display:flex><span>    <span style=color:#f92672>--</span>rounds;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ( rounds );
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> v0 <span style=color:#f92672>^</span> v1;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>TEA_Encrypt</code> function performs TEA encryption (<a href=https://en.wikipedia.org/wiki/Tiny_Encryption_Algorithm>Tiny Encryption Algorithm</a>) with PC and Seed as inputs. The 128-bit key is the one that was read from the header of the file.</p><p>Therefore, the encrypted instructions basically depend on their offset in the code (PC) and a 32-bit (constant) seed.</p><p>The <code>VM_HandleInstruction</code> function, which eventually handles the decrypted instructions, dispatches them to different handlers. It&rsquo;s a pretty classic VM: some arithmetic logic instructions, branching, stack stuff, syscalls&mldr;</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 760 233"><g transform="translate(8,16)"><path d="M504 16h40" fill="none" stroke="currentcolor"/><path d="M88 64H232" fill="none" stroke="currentcolor"/><path d="M448 64h56" fill="none" stroke="currentcolor"/><path d="M504 64h56" fill="none" stroke="currentcolor"/><path d="M240 80H448" fill="none" stroke="currentcolor"/><path d="M568 80h96" fill="none" stroke="currentcolor"/><path d="M40 96H80" fill="none" stroke="currentcolor"/><path d="M6e2 112h64" fill="none" stroke="currentcolor"/><path d="M664 112h64" fill="none" stroke="currentcolor"/><path d="M6e2 144H728" fill="none" stroke="currentcolor"/><path d="M40 160H80" fill="none" stroke="currentcolor"/><path d="M232 176H440" fill="none" stroke="currentcolor"/><path d="M560 176H664" fill="none" stroke="currentcolor"/><path d="M88 192H232" fill="none" stroke="currentcolor"/><path d="M448 192h56" fill="none" stroke="currentcolor"/><path d="M504 192h56" fill="none" stroke="currentcolor"/><path d="M88 64V96" fill="none" stroke="currentcolor"/><path d="M88 96v64" fill="none" stroke="currentcolor"/><path d="M88 160v32" fill="none" stroke="currentcolor"/><path d="M232 64V176" fill="none" stroke="currentcolor"/><path d="M232 176v16" fill="none" stroke="currentcolor"/><path d="M448 64V80" fill="none" stroke="currentcolor"/><path d="M448 80V192" fill="none" stroke="currentcolor"/><path d="M504 16V48" fill="none" stroke="currentcolor"/><path d="M504 48V64" fill="none" stroke="currentcolor"/><path d="M560 64V80" fill="none" stroke="currentcolor"/><path d="M560 80v96" fill="none" stroke="currentcolor"/><path d="M560 176v16" fill="none" stroke="currentcolor"/><path d="M664 80v32" fill="none" stroke="currentcolor"/><path d="M664 160v16" fill="none" stroke="currentcolor"/><polygon points="88.000000,96.000000 76.000000,90.400002 76.000000,101.599998" fill="currentcolor" transform="rotate(0.000000, 80.000000, 96.000000)"/><polygon points="88.000000,160.000000 76.000000,154.399994 76.000000,165.600006" fill="currentcolor" transform="rotate(0.000000, 80.000000, 160.000000)"/><polygon points="248.000000,80.000000 236.000000,74.400002 236.000000,85.599998" fill="currentcolor" transform="rotate(180.000000, 240.000000, 80.000000)"/><polygon points="448.000000,176.000000 436.000000,170.399994 436.000000,181.600006" fill="currentcolor" transform="rotate(0.000000, 440.000000, 176.000000)"/><path d="M504 48v8" fill="none" stroke="currentcolor"/><polygon points="520.000000,48.000000 508.000000,42.400002 508.000000,53.599998" fill="currentcolor" transform="rotate(90.000000, 504.000000, 48.000000)"/><polygon points="576.000000,80.000000 564.000000,74.400002 564.000000,85.599998" fill="currentcolor" transform="rotate(180.000000, 568.000000, 80.000000)"/><path d="M664 152v8" fill="none" stroke="currentcolor"/><polygon points="680.000000,160.000000 668.000000,154.399994 668.000000,165.600006" fill="currentcolor" transform="rotate(270.000000, 664.000000, 160.000000)"/><path d="M6e2 112a16 16 0 00-16 16" fill="none" stroke="currentcolor"/><path d="M728 112a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M584 128a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M744 128a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="0" y="164" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="8" y="100" fill="currentcolor" style="font-size:1em">K</text><text text-anchor="middle" x="8" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="16" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="16" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="24" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="24" y="164" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="112" y="132" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="120" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="128" y="132" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="132" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="144" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="152" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="168" y="132" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="176" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="184" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="192" y="132" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="200" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="208" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="272" y="20" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="280" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="280" y="100" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="280" y="196" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="288" y="20" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="288" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="288" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="296" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="296" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="296" y="196" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="304" y="20" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="304" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="304" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="312" y="20" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="312" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="312" y="196" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="320" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="320" y="68" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="320" y="100" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="320" y="164" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="320" y="196" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="328" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="328" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="328" y="164" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="328" y="196" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="336" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="336" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="336" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="116" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="336" y="164" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="336" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="344" y="68" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="344" y="100" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="344" y="116" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="344" y="164" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="344" y="196" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="352" y="20" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="352" y="68" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="352" y="164" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="360" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="360" y="68" fill="currentcolor" style="font-size:1em">7</text><text text-anchor="middle" x="360" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="360" y="164" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="360" y="196" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="368" y="20" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="368" y="100" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="368" y="196" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="376" y="20" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="376" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="376" y="196" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="384" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="384" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="384" y="196" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="392" y="20" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="392" y="100" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="392" y="196" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="400" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="400" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="400" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="408" y="20" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="472" y="132" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="480" y="132" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="496" y="132" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="504" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="512" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="520" y="132" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="528" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="536" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="560" y="20" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="568" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="576" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="584" y="20" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="592" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="600" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="608" y="20" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="608" y="132" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="616" y="132" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="624" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="624" y="132" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="632" y="20" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="640" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="640" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="648" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="648" y="132" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="656" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="656" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="664" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="664" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="672" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="672" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="680" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="680" y="132" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="688" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="696" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="704" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="712" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="720" y="132" fill="currentcolor" style="font-size:1em">n</text></g></svg></div><p>At this point, players can opt for two main routes.</p><p>The first is the more <strong>static route</strong>, in which you keep on reversing the handling logic, specify all the instructions, and write a static disassembler for the bytecode (which also involves decrypting the instructions).</p><p>The second is the <strong>dynamic route</strong>: one may be tempted to instrument the binary in order to automatically dump all the decrypted instructions that are executed.</p><p>Both routes are valid and worth taking a look at, because both have their own twists and touch on different skills. Let&rsquo;s dive into them!</p><h1 id=the-static-route>The static route</h1><p>Through a more thorough analysis of the functions involved in instruction handling, we are able to grasp a finer understanding of the virtual machine.</p><p>The sixteen registers are subdivided like the following:</p><ul><li>R0 -> RB: general purpose</li><li>RC: frame pointer (FP)</li><li>RD: stack pointer (SP)</li><li>RE: link register (LR)</li><li>RF: program counter (PC)</li></ul><p>Regarding the calling convention, arguments are stored in R0, R1, R2, R3 and the stack. Return values are stored in RA.</p><p>The calling convention for syscalls is slightly different; maximum 4 arguments, stored in R2, R3, R4 and R5. A few syscalls are defined:</p><ul><li><code>SYSCALL_READ</code> (0x0)</li><li><code>SYSCALL_WRITE</code> (0x1)</li><li><code>SYSCALL_EXIT</code> (0x2)</li><li><code>SYSCALL_SETPROCESSMITIGATIONPOLICY</code> (0x3)</li><li><code>SYSCALL_ISDEBUGGERPRESENT</code> (0x4)</li></ul><p>We will talk about the last two syscalls in the section dedicated to the dynamic route.</p><p>Instructions (32-bits) are encoded as the four following bytes: <code>[Opcode][Param][Dst][Src]</code>. For ALU/MOV operations, the source can be a register, a memory location or an immediate. Likewise, destination can be a register or a memory location. The <code>Param</code> byte specifies the different cases with its four last bits (∳b_3∳, ∳b_2∳, ∳b_1∳, ∳b_0∳):</p><table><thead><tr><th style=text-align:left>case</th><th style=text-align:left>meaning</th><th style=text-align:left>comment</th></tr></thead><tbody><tr><td style=text-align:left>∳b_3 b_2 = 00∳</td><td style=text-align:left>dst = reg</td><td style=text-align:left></td></tr><tr><td style=text-align:left>∳b_3 b_2 = 01∳</td><td style=text-align:left>dst = mem</td><td style=text-align:left>1 additional DWORD for the address</td></tr><tr><td style=text-align:left>∳b_3 b_2 = 10∳</td><td style=text-align:left>invalid</td><td style=text-align:left></td></tr><tr><td style=text-align:left>∳b_3 b_2 = 11∳</td><td style=text-align:left>invalid</td><td style=text-align:left></td></tr><tr><td style=text-align:left>∳b_1 b_0 = 00∳</td><td style=text-align:left>src = reg</td><td style=text-align:left></td></tr><tr><td style=text-align:left>∳b_1 b_0 = 01∳</td><td style=text-align:left>src = mem</td><td style=text-align:left>1 additional DWORD for the address</td></tr><tr><td style=text-align:left>∳b_1 b_0 = 10∳</td><td style=text-align:left>src = imm</td><td style=text-align:left>1 additional DWORD for the immediate</td></tr><tr><td style=text-align:left>∳b_1 b_0 = 11∳</td><td style=text-align:left>invalid</td><td style=text-align:left></td></tr></tbody></table><p>For memory accesses, an additional bit (∳b_4∳) specifies whether we&rsquo;re working at DWORD level or BYTE level. For instance, <code>mov reg, dword ptr [addr]</code> would require ∳b_4 = 0∳, and <code>mov reg, byte ptr [addr]</code> would require ∳b_4 = 1∳. In the case of a byte read access, it also allows to save 4 bytes by encoding the immediate in the <code>Src</code> byte.</p><p>As for jumps/calls, these can be relative or absolute depending on ∳b_0∳. If ∳b_0 = 0∳, it&rsquo;s a relative jump encoded by the WORD <code>[Dst][Src]</code> (relative offset to PC at the moment of the jump). If ∳b_0 = 1∳, it&rsquo;s an absolute jump, and the address is encoded in an additional DWORD.</p><p>These are all the opcodes:</p><table><thead><tr><th>instruction</th><th>opcode</th></tr></thead><tbody><tr><td>ADD</td><td>0x80</td></tr><tr><td>SUB</td><td>0x81</td></tr><tr><td>MUL</td><td>0x82</td></tr><tr><td>DIV</td><td>0x83</td></tr><tr><td>MOD</td><td>0x84</td></tr><tr><td>CMP</td><td>0x85</td></tr><tr><td>AND</td><td>0x90</td></tr><tr><td>OR</td><td>0x91</td></tr><tr><td>XOR</td><td>0x92</td></tr><tr><td>MOV</td><td>0xA0</td></tr><tr><td>JMP</td><td>0xB0</td></tr><tr><td>JEQ</td><td>0xB1</td></tr><tr><td>JNE</td><td>0xB2</td></tr><tr><td>JGT</td><td>0xB3</td></tr><tr><td>JGE</td><td>0xB4</td></tr><tr><td>JLT</td><td>0xB5</td></tr><tr><td>JLE</td><td>0xB6</td></tr><tr><td>CALL</td><td>0xC0</td></tr><tr><td>RET</td><td>0xC1</td></tr><tr><td>PUSH</td><td>0xD0</td></tr><tr><td>POP</td><td>0xD1</td></tr><tr><td>SYSCALL</td><td>0xE0</td></tr></tbody></table><p>With all this knowledge, we can now decrypt the instructions and implement a basic disassembler. This can yield something like the following:</p><pre tabindex=0><code>.welcome  b&#34;   __        __    _    __                         \n  / /_____ _/ /__ (_)__/ /__  __________  ___  ___ \n /  &#39;_/ _ `/ / -_) / _  / _ \\(_-&lt; __/ _ \\/ _ \\/ -_)\n/_/\\_\\\\_,_/_/\\__/_/\\_,_/\\___/___|__/\\___/ .__/\\__/ \n                                       /_/         \n\n&#34;
.enterpassword  b&#34;Enter the password: &#34;
.good  b&#34;Nice one!\n&#34;
.nope  b&#34;Uhh... no\n&#34;

.flag   b&#34;\x00&#34; * 32

.unk1  b&#34;\x01\x00\x00\x00&#34; 
.unk2  b&#34;\x01\x00\x00\x00&#34;

jmp entrypoint

fun1:
mov R2, flag
mov R3, 32
syscall 0  ; read
ret

fun2:
mov R5, ??????
mov R6, ??????
sub R5, 0x10c0
ret

fun3:
syscall 4
cmp RA, 1
jne fun3_ret
syscall 2
fun3_ret:
ret

fun4:
mov R2, 2
mov R3, unk1
mov R4, 4
syscall 3
mov R2, 8
mov R3, unk2
mov R4, 4
syscall 3
ret

entrypoint:
call fun3
call fun4
mov R2, welcome
mov R3, $welcome
syscall 1
mov R2, enterpassword
mov R3, $enterpassword
syscall 1
call fun1
call fun3
call fun2
mov R0, R5
mov R1, R6
add R0, 0x1f30
mov R2, 0x644e7750
syscall 8
</code></pre><p>We will ignore what <code>fun3</code> and <code>fun4</code> do for now. The program outputs the welcome and enter password strings, before calling <code>fun1</code> which reads a 32-byte flag.</p><p>It then calls <code>fun2</code>, which does something weird that wasn&rsquo;t disassembled properly&mldr; and finally, after the last syscall, the disassembly is total garbage (not shown here), as if the program were obfuscated or the instructions not decrypted correctly.</p><p>The first weird thing that happens is this:</p><pre tabindex=0><code>mov R5, ??????
mov R6, ??????
sub R5, 0x10c0
ret
</code></pre><p>Let&rsquo;s look at the exact bytecode for the mov instructions:</p><pre tabindex=0><code>A00005FE
A00006FF
</code></pre><p>According to the handling logic, a <code>mov Rp, Rq</code> instruction should be encoded as <code>A0 00 0p 0q</code>. But here, we have <code>FE</code> and <code>FF</code> bytes instead!</p><p>Indeed, there is a vulnerability in the virtual machine that allows to cause an <strong>underflow</strong> in register numbers. Here&rsquo;s an extract of the actual source code of the challenge:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>DWORD <span style=color:#a6e22e>VM_LoadSrcOrDst</span>(VMContext<span style=color:#f92672>*</span> VM, CHAR SrcOrDst, UCHAR Type, UCHAR IsByte) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	DWORD Addr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> (Type) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Register
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (SrcOrDst <span style=color:#f92672>&lt;</span> N_REGISTERS) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> VM<span style=color:#f92672>-&gt;</span>Registers[SrcOrDst];
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		ExitProcess(EXIT_FAILURE);
</span></span></code></pre></div><p>It is correctly verified that the register number (<code>SrcOrDst</code>) be lower than a certain threshold. However, this variable is a signed CHAR, which means that a negative byte can be used.</p><p>The <code>VMContext</code> structure is the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>VMContext</span> {
</span></span><span style=display:flex><span>	BYTE<span style=color:#f92672>*</span> Program;
</span></span><span style=display:flex><span>	VM_SYSCALL_FN<span style=color:#f92672>*</span> SyscallHandlers[N_SYSCALLS];
</span></span><span style=display:flex><span>	DWORD Registers[N_REGISTERS];
</span></span><span style=display:flex><span>	UCHAR Flag;
</span></span><span style=display:flex><span>	DWORD<span style=color:#f92672>*</span> Stack;
</span></span><span style=display:flex><span>} VMContext;
</span></span></code></pre></div><p>Consequently, we are able to underflow into the <code>SyscallHandlers</code> table. The <code>fun2</code> function actually does something like this:</p><pre tabindex=0><code>mov R5, R(-2)
mov R6, R(-1)
sub R5, 0x10c0
ret
</code></pre><p>The <code>R(-2)</code> and <code>R(-1)</code> registers represent the last two DWORDs of the <code>SyscallHandlers</code> table. Therefore, the emulated program is effectively leaking the last function pointer in the table!</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 760 409"><g transform="translate(8,16)"><path d="M152 16H472" fill="none" stroke="currentcolor"/><path d="M152 48H472" fill="none" stroke="currentcolor"/><path d="M488 48h8" fill="none" stroke="currentcolor"/><path d="M152 80H472" fill="none" stroke="currentcolor"/><path d="M152 112H472" fill="none" stroke="currentcolor"/><path d="M152 144H472" fill="none" stroke="currentcolor"/><path d="M152 176H472" fill="none" stroke="currentcolor"/><path d="M512 176h16" fill="none" stroke="currentcolor"/><path d="M152 208H472" fill="none" stroke="currentcolor"/><path d="M152 240H472" fill="none" stroke="currentcolor"/><path d="M120 272h24" fill="none" stroke="currentcolor"/><path d="M152 272H472" fill="none" stroke="currentcolor"/><path d="M120 304h24" fill="none" stroke="currentcolor"/><path d="M152 304H312" fill="none" stroke="currentcolor"/><path d="M312 304H472" fill="none" stroke="currentcolor"/><path d="M488 304h8" fill="none" stroke="currentcolor"/><path d="M152 336H312" fill="none" stroke="currentcolor"/><path d="M312 336H472" fill="none" stroke="currentcolor"/><path d="M152 368H312" fill="none" stroke="currentcolor"/><path d="M312 368H472" fill="none" stroke="currentcolor"/><path d="M152 16V48" fill="none" stroke="currentcolor"/><path d="M152 48V80" fill="none" stroke="currentcolor"/><path d="M152 80v32" fill="none" stroke="currentcolor"/><path d="M152 112v32" fill="none" stroke="currentcolor"/><path d="M152 144v32" fill="none" stroke="currentcolor"/><path d="M152 176v32" fill="none" stroke="currentcolor"/><path d="M152 208v32" fill="none" stroke="currentcolor"/><path d="M152 240v32" fill="none" stroke="currentcolor"/><path d="M152 272v32" fill="none" stroke="currentcolor"/><path d="M152 304v32" fill="none" stroke="currentcolor"/><path d="M152 336v32" fill="none" stroke="currentcolor"/><path d="M312 304v32" fill="none" stroke="currentcolor"/><path d="M312 336v32" fill="none" stroke="currentcolor"/><path d="M472 16V48" fill="none" stroke="currentcolor"/><path d="M472 48V80" fill="none" stroke="currentcolor"/><path d="M472 80v32" fill="none" stroke="currentcolor"/><path d="M472 112v32" fill="none" stroke="currentcolor"/><path d="M472 144v32" fill="none" stroke="currentcolor"/><path d="M472 176v32" fill="none" stroke="currentcolor"/><path d="M472 208v32" fill="none" stroke="currentcolor"/><path d="M472 240v32" fill="none" stroke="currentcolor"/><path d="M472 272v32" fill="none" stroke="currentcolor"/><path d="M472 304v32" fill="none" stroke="currentcolor"/><path d="M472 336v32" fill="none" stroke="currentcolor"/><path d="M512 80v96" fill="none" stroke="currentcolor"/><path d="M512 176v96" fill="none" stroke="currentcolor"/><path d="M496 304l16-32" fill="none" stroke="currentcolor"/><path d="M496 48l16 32" fill="none" stroke="currentcolor"/><polygon points="152.000000,272.000000 140.000000,266.399994 140.000000,277.600006" fill="currentcolor" transform="rotate(0.000000, 144.000000, 272.000000)"/><polygon points="152.000000,304.000000 140.000000,298.399994 140.000000,309.600006" fill="currentcolor" transform="rotate(0.000000, 144.000000, 304.000000)"/><text text-anchor="middle" x="0" y="276" fill="currentcolor" style="font-size:1em">&amp;</text><text text-anchor="middle" x="8" y="276" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="16" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="24" y="276" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="32" y="276" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="40" y="276" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="40" y="308" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="48" y="276" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="48" y="308" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="308" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="64" y="276" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="308" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="72" y="276" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="72" y="308" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="80" y="276" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="80" y="308" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="276" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="88" y="308" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="276" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="96" y="308" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="104" y="276" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="104" y="308" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="168" y="36" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="168" y="68" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="168" y="132" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="168" y="164" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="168" y="196" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="168" y="228" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="168" y="260" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="168" y="292" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="168" y="324" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="168" y="356" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="176" y="68" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="132" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="164" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="196" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="228" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="260" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="292" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="324" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="176" y="356" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="164" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="196" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="228" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="260" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="292" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="192" y="68" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="192" y="100" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="192" y="132" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="192" y="164" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="192" y="196" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="192" y="228" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="192" y="260" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="192" y="292" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="68" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="200" y="132" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="200" y="164" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="200" y="196" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="200" y="228" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="200" y="260" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="200" y="292" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="208" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="208" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="208" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="208" y="228" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="208" y="260" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="208" y="292" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="216" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="216" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="216" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="216" y="164" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="216" y="196" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="216" y="228" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="216" y="260" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="216" y="292" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="224" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="196" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="228" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="260" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="292" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="232" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="196" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="228" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="260" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="196" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="228" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="260" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="248" y="68" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="248" y="100" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="248" y="132" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="248" y="164" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="248" y="196" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="248" y="228" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="248" y="260" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="248" y="292" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="256" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="256" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="256" y="132" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="256" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="256" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="256" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="256" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="256" y="292" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="264" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="264" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="264" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="264" y="196" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="264" y="228" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="264" y="260" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="264" y="292" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="272" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="272" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="272" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="272" y="164" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="272" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="272" y="228" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="272" y="260" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="272" y="292" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="280" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="280" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="280" y="196" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="280" y="228" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="280" y="260" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="280" y="292" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="288" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="288" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="288" y="228" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="288" y="260" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="288" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="296" y="164" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="296" y="196" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="296" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="296" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="296" y="292" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="304" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="304" y="196" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="304" y="228" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="304" y="260" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="304" y="292" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="312" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="312" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="292" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="320" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="320" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="320" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="320" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="320" y="292" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="328" y="164" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="328" y="196" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="328" y="228" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="328" y="260" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="328" y="292" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="328" y="324" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="328" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="336" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="336" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="292" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="324" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="336" y="356" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="344" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="344" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="228" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="344" y="260" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="344" y="292" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="344" y="356" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="352" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="352" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="352" y="356" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="360" y="164" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="360" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="368" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="368" y="196" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="376" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="376" y="196" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="384" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="392" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="400" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="408" y="164" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="416" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="424" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="432" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="440" y="164" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="448" y="164" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="544" y="180" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="552" y="180" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="560" y="180" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="568" y="180" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="576" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="584" y="180" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="592" y="180" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="600" y="180" fill="currentcolor" style="font-size:1em">H</text><text text-anchor="middle" x="608" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="616" y="180" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="624" y="180" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="632" y="180" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="640" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="648" y="180" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="656" y="180" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="672" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="680" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="688" y="180" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="696" y="180" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="704" y="180" fill="currentcolor" style="font-size:1em">e</text></g></svg></div><p>This function pointer happens to be the function <code>VM_SyscallUnimplemented</code> (at 0x10C0), which is a default filler for undefined syscalls. The <code>fun2</code> function thus computes the <em>base address</em> of <code>kaleidoscope.exe</code>.</p><p>The emulated program does not stop there, and does a second weird thing:</p><pre tabindex=0><code>mov R0, R5
mov R1, R6
add R0, 0x1f30
mov R2, 0x644e7750
syscall 8
</code></pre><p>The 8th syscall does not exist! There&rsquo;s a second vulnerability, a bit similar to the previous one. Here is another extract of the source code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>case</span> OP_SYSCALL:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Param <span style=color:#f92672>&gt;</span> N_SYSCALLS)
</span></span><span style=display:flex><span>        ExitProcess(EXIT_FAILURE);
</span></span><span style=display:flex><span>    VM<span style=color:#f92672>-&gt;</span>Registers[RA] <span style=color:#f92672>=</span> VM<span style=color:#f92672>-&gt;</span>SyscallHandlers[Param](
</span></span><span style=display:flex><span>        VM,
</span></span><span style=display:flex><span>        VM<span style=color:#f92672>-&gt;</span>Registers[R2],
</span></span><span style=display:flex><span>        VM<span style=color:#f92672>-&gt;</span>Registers[R3],
</span></span><span style=display:flex><span>        VM<span style=color:#f92672>-&gt;</span>Registers[R4],
</span></span><span style=display:flex><span>        VM<span style=color:#f92672>-&gt;</span>Registers[R5]
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    VM<span style=color:#f92672>-&gt;</span>Registers[PC] <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>;
</span></span></code></pre></div><p>The <code>Param > N_SYSCALLS</code> condition gives room for an <strong>off-by-one</strong>. There are only 8 handlers in the <code>SyscallHandlers</code> table, but we can call a handler that is located one QWORD right after.</p><p>As we saw before, right next to this table sit the registers. Therefore, an attacker can call an arbitrary function pointer formed by the two first registers R0 and R1.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 760 409"><g transform="translate(8,16)"><path d="M184 16H504" fill="none" stroke="currentcolor"/><path d="M160 48h16" fill="none" stroke="currentcolor"/><path d="M184 48H504" fill="none" stroke="currentcolor"/><path d="M184 80H504" fill="none" stroke="currentcolor"/><path d="M184 112H504" fill="none" stroke="currentcolor"/><path d="M184 144H504" fill="none" stroke="currentcolor"/><path d="M184 176H504" fill="none" stroke="currentcolor"/><path d="M184 208H504" fill="none" stroke="currentcolor"/><path d="M184 240H504" fill="none" stroke="currentcolor"/><path d="M184 272H504" fill="none" stroke="currentcolor"/><path d="M184 304H344" fill="none" stroke="currentcolor"/><path d="M344 304H504" fill="none" stroke="currentcolor"/><path d="M520 304h8" fill="none" stroke="currentcolor"/><path d="M160 320h16" fill="none" stroke="currentcolor"/><path d="M184 336H344" fill="none" stroke="currentcolor"/><path d="M344 336H504" fill="none" stroke="currentcolor"/><path d="M544 336h8" fill="none" stroke="currentcolor"/><path d="M184 368H344" fill="none" stroke="currentcolor"/><path d="M344 368H504" fill="none" stroke="currentcolor"/><path d="M520 368h8" fill="none" stroke="currentcolor"/><path d="M184 16V48" fill="none" stroke="currentcolor"/><path d="M184 48V80" fill="none" stroke="currentcolor"/><path d="M184 80v32" fill="none" stroke="currentcolor"/><path d="M184 112v32" fill="none" stroke="currentcolor"/><path d="M184 144v32" fill="none" stroke="currentcolor"/><path d="M184 176v32" fill="none" stroke="currentcolor"/><path d="M184 208v32" fill="none" stroke="currentcolor"/><path d="M184 240v32" fill="none" stroke="currentcolor"/><path d="M184 272v32" fill="none" stroke="currentcolor"/><path d="M184 304v16" fill="none" stroke="currentcolor"/><path d="M184 320v16" fill="none" stroke="currentcolor"/><path d="M184 336v32" fill="none" stroke="currentcolor"/><path d="M344 304v32" fill="none" stroke="currentcolor"/><path d="M344 336v32" fill="none" stroke="currentcolor"/><path d="M504 16V48" fill="none" stroke="currentcolor"/><path d="M504 48V80" fill="none" stroke="currentcolor"/><path d="M504 80v32" fill="none" stroke="currentcolor"/><path d="M504 112v32" fill="none" stroke="currentcolor"/><path d="M504 144v32" fill="none" stroke="currentcolor"/><path d="M504 176v32" fill="none" stroke="currentcolor"/><path d="M504 208v32" fill="none" stroke="currentcolor"/><path d="M504 240v32" fill="none" stroke="currentcolor"/><path d="M504 272v32" fill="none" stroke="currentcolor"/><path d="M504 304v32" fill="none" stroke="currentcolor"/><path d="M504 336v32" fill="none" stroke="currentcolor"/><path d="M528 368l16-32" fill="none" stroke="currentcolor"/><path d="M528 304l16 32" fill="none" stroke="currentcolor"/><polygon points="184.000000,48.000000 172.000000,42.400002 172.000000,53.599998" fill="currentcolor" transform="rotate(0.000000, 176.000000, 48.000000)"/><polygon points="184.000000,320.000000 172.000000,314.399994 172.000000,325.600006" fill="currentcolor" transform="rotate(0.000000, 176.000000, 320.000000)"/><text text-anchor="middle" x="8" y="324" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="16" y="324" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="24" y="324" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="32" y="52" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="32" y="324" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="40" y="52" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="40" y="324" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="48" y="52" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="48" y="324" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="56" y="324" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="64" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="324" fill="currentcolor" style="font-size:1em">H</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="72" y="324" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="52" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="80" y="324" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">H</text><text text-anchor="middle" x="88" y="324" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="96" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="96" y="324" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="104" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="104" y="324" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="112" y="52" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="112" y="324" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="52" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="324" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="128" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="128" y="324" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="136" y="52" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="136" y="324" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="144" y="52" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="144" y="324" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="200" y="68" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="132" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="164" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="196" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="228" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="260" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="292" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="324" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="200" y="356" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="208" y="68" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="132" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="164" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="196" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="228" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="260" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="292" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="324" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="208" y="356" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="216" y="68" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="216" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="216" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="216" y="164" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="216" y="196" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="216" y="228" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="216" y="260" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="216" y="292" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="224" y="68" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="224" y="100" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="224" y="132" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="224" y="164" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="224" y="196" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="224" y="228" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="224" y="260" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="224" y="292" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="232" y="68" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="232" y="132" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="232" y="164" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="232" y="196" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="232" y="228" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="232" y="260" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="232" y="292" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="240" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="240" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="240" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="240" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="240" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="240" y="228" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="240" y="260" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="240" y="292" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="248" y="36" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="248" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="248" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="248" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="248" y="164" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="248" y="196" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="248" y="228" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="248" y="260" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="248" y="292" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="256" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="196" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="228" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="260" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="292" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="264" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="196" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="228" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="260" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="196" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="228" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="260" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="280" y="68" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="280" y="100" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="280" y="132" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="280" y="164" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="280" y="196" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="280" y="228" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="280" y="260" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="280" y="292" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="288" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="288" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="288" y="132" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="288" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="288" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="288" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="288" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="288" y="292" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="296" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="296" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="296" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="296" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="296" y="196" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="296" y="228" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="296" y="260" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="296" y="292" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="304" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="304" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="304" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="304" y="164" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="304" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="304" y="228" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="304" y="260" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="304" y="292" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="312" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="312" y="196" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="312" y="228" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="312" y="260" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="312" y="292" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="320" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="320" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="320" y="228" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="320" y="260" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="320" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="328" y="164" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="328" y="196" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="328" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="292" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="196" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="336" y="228" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="336" y="260" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="336" y="292" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="344" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="344" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="292" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="352" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="352" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="352" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="352" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="352" y="292" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="360" y="164" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="360" y="196" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="360" y="228" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="360" y="260" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="360" y="292" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="360" y="324" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="360" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="368" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="368" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="368" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="368" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="368" y="292" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="368" y="324" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="368" y="356" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="376" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="376" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="376" y="228" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="376" y="260" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="376" y="292" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="376" y="356" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="384" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="384" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="384" y="356" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="392" y="164" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="392" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="400" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="400" y="196" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="408" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="408" y="196" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="416" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="424" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="432" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="440" y="164" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="448" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="456" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="464" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="472" y="164" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="480" y="164" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="568" y="340" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="576" y="340" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="584" y="340" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="592" y="340" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="600" y="340" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="608" y="340" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="616" y="340" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="624" y="340" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="632" y="340" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><p>Since the syscalling convention is given by registers R2, R3, R4 and R5, we can also potentially specify arbitrary arguments to the call through these registers (if the target function&rsquo;s calling convention is compatible).</p><p>The target function for the call is computed with <code>add R0, 0x1f30</code>. At offset 0x1f30 lies the function <code>SetSeed</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>SetSeed</span>(<span style=color:#66d9ef>__int64</span> a1, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> a2)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  Seed <span style=color:#f92672>=</span> a2;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As discussed earlier, this function simply modifies the global <code>Seed</code> variable used during the instruction decryption mechanism. Its calling convention happens to match the one from the syscall handlers, and <code>a2</code> (edx) contains the value of the R2 register, which is at the attacker&rsquo;s control.</p><p>Therefore, the attacker manages to change the seed to the value of R2: 0x644e7750 (&lsquo;PwNd&rsquo;)!</p><p>From this moment onwards, all instructions will see their decryption modified, hence the garbage. To summarize, <strong>the emulated program auto-exploited a chain of bugs in the host in order to obfuscate itself</strong>.</p><p>Note: this concept was partly inspired by hgarrereyn&rsquo;s <a href=https://github.com/reductor/dice-ctf-2022-breach-writeup><em>breach</em> challenge</a> from DiceCTF 2022.</p><p>We can now modify our disassembler to use the new decryption seed after a certain offset. This allows to decrypt the rest of the program, which implements the flag checking logic.</p><pre tabindex=0><code>mov RA, 0

mov R8, [flag0]
mov R9, R8
mod R8, 76335
mod R9, 120026
xor R8, 27241
xor R9, 68181
or RA, R8
or RA, R9

mov R8, [flag4]
mov R9, R8
mod R8, 110125
mod R9, 108506
xor R8, 92563
xor R9, 45127
or RA, R8
or RA, R9

mov R8, [flag8]
mov R9, R8
mod R8, 98851
mod R9, 115966
xor R8, 42287
xor R9, 46766
or RA, R8
or RA, R9

mov R8, [flag12]
mov R9, R8
mod R8, 98564
mod R9, 114611
xor R8, 96512
xor R9, 58270
or RA, R8
or RA, R9

cmp RA, 0
jne fail

mov R8, [flag16]
mov R9, R8
mod R8, 69129
mod R9, 88694
xor R8, 14900
xor R9, 82705
or RA, R8
or RA, R9

mov R8, [flag20]
mov R9, R8
mod R8, 109460
mod R9, 68883
xor R8, 24419
xor R9, 41368
or RA, R8
or RA, R9

mov R8, [flag24]
mov R9, R8
mod R8, 82595
mod R9, 65709
xor R8, 40736
xor R9, 58761
or RA, R8
or RA, R9

mov R8, [flag28]
mov R9, R8
mod R8, 130942
mod R9, 71079
xor R8, 22132
xor R9, 26140
or RA, R8
or RA, R9

cmp RA, 0
jne fail

mov R2, good
mov R3, $good
syscall 1  ; write
syscall 2  ; exit

fail:
mov R2, nope
mov R3, $nope
syscall 1  ; write
syscall 2  ; exit
</code></pre><h1 id=the-dynamic-route>The dynamic route</h1><p>When the challenge was first designed, we found a little bypass (or shortcut): by instrumenting the binary to dump all instructions after they&rsquo;re decrypted, we could totally circumvent the &ldquo;key&rdquo; point of the challenge, which is understanding the obfuscation.</p><p>Indeed, we would be able to dump all the executed instructions, including the flag checking logic, while staying totally oblivious to the vulnerability that was exploited right before our eyes and the seed modification that happened.</p><p>Therefore, I wanted to even out the difficulty a bit between the two approaches, by making this route more complex (not significantly much, but still throwing a little spanner in the works).</p><p>In order to do that, I implemented a few protections and mitigations, namely anti-debug and anti-hooking tricks.</p><p>The host binary leverages the <a href=https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-isdebuggerpresent>IsDebuggerPresent</a> and <a href=https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy>SetProcessMitigationPolicy</a> functions from the Windows API to:</p><ul><li>check whether a debugger is present;</li><li>enable the ProcessDynamicCodePolicy policy (ACG), thwarting most hooking tools that allow RWX trampolines (e.g. frida, detours);</li><li>enable the ProcessSignaturePolicy policy (CIG), preventing non-Microsoft-signed DLLs from being loaded into the binary.</li></ul><p>However, these calls are not <em>directly</em> seen in the binary; they are performed from inside the VM, through two &ldquo;proxy&rdquo; syscalls (remember <code>fun3</code> and <code>fun4</code>?) and some <code>GetProcAddress</code>. One should identify these syscalls in the host and patch these to cancel out their effect.</p><p>Once the mitigations are overcome, a tiny <em>frida</em> hook can easily dump all instructions post-decryption:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>Interceptor</span>.<span style=color:#a6e22e>attach</span>(<span style=color:#a6e22e>Module</span>.<span style=color:#a6e22e>findBaseAddress</span>(<span style=color:#e6db74>&#34;kaleidoscope.exe&#34;</span>).<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>0x1190</span>), {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onLeave</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>retVal</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>retVal</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>16</span>));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>retVal</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>The VM instruction handling logic still needs to be reversed a little bit to understand the instructions (but only those of interest).</p><h1 id=conclusion>Conclusion</h1><p>The flag checking logic is unmistakably not the most intricate part of the challenge.</p><p>Each DWORD from the flag must satisfy constraints as following:</p><p>∳∳
\left\{
\:
\begin{aligned}
\text{flag}_i = x_{i,1} \mod{n_{i,1}} \\
\text{flag}_i = x_{i,2} \mod{n_{i,2}}
\end{aligned}
\right.
∳∳</p><p>We can get rid of these using the Chinese remainder theorem (<a href=https://twitter.com/gf_256/status/1543321843037310985>or simply z3&mldr;</a>).</p><p>This yields the following flag: <code>ECW{w31rdtu4l_m4ch1n3s_g00d_fun}</code>!</p><p>I hope you enjoyed this challenge. I wanted to bring together different elements: a little bit of Windows reversing, a little bit of inter-thread communication, a little bit of crypto&mldr; and tie it all together with an auto-exploiting VM, which I have seen a few times during CTFs.</p><p>Most experienced reverse players have already deobfuscated plenty of VMs and might find it repetitive, but these ones come with a little twist, which I think is interesting.</p><p>During the CTF, many players seem to have opted for the dynamic route, and rightfully so: in hindsight, this was clearly the easiest route. I hoped people would figure out the bugs in the VM, but very few actually did.</p><p>I should have made debugging harder, or pushed the exploitation concept even further (e.g. getting code execution).</p><p>Some contestants noticed uncanny stuff going on that miraculously changed the TEA seed, and just dumped the new seed. Others didn&rsquo;t even realize anything was happening and managed to directly dump the flag constraints (though sometimes through more creative approaches, such as Qiling emulation or modifying Wine).</p><p>Anyway, there were a few slip-ups with this challenge and it was eventually not as hard as I intended, but overall I believe it was still relevant and of decent difficulty.</p><p>You can find the sources of the challenge <a href=https://github.com/face0xff/kaleidoscope>over on Github</a> if you&rsquo;re interested!</p></div><footer class=post-footer><div class=post-footer-data><div class=tags><div class=tag><a href=/tags/ctf>#CTF</a></div><div class=tag><a href=/tags/writeup>#Writeup</a></div><div class=tag><a href=/tags/ecw-2023>#ECW 2023</a></div><div class=tag><a href=/tags/reverse-engineering>#Reverse Engineering</a></div><div class=tag><a href=/tags/windows>#Windows</a></div></div><span class=date>2023-11-07
<span class=author>by
Valentino Ricotta</span></span></div></footer></article><footer><div class=social-links-footer><a href=mailto:contact@thalium.re><div class=social-link>Email</div></a><a href=https://github.com/thalium target=_blank><div class=social-link>GitHub</div></a><a href=https://twitter.com/thalium_team target=_blank><div class=social-link>Twitter</div></a></div><div class=copyright>Copyright (c) 2020, all rights reserved.</div><div class=poweredby>Powered by <a href=https://gohugo.io/>Hugo</a>.</div></footer></div></body></html>